<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>GPS-AR / è‡ªå‰ã‚«ãƒ¡ãƒ©åˆæˆç‰ˆ</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font:14px/1.5 ui-monospace,monospace}
  /* èƒŒæ™¯ã‚«ãƒ¡ãƒ©ï¼ˆç”»é¢å…¨é¢ï¼‰ */
  #cam{position:fixed;inset:0;object-fit:cover;width:100%;height:100%;z-index:0;background:#000}
  /* A-Frameã‚’ä¸Šã«é‡ã­ã‚‹ï¼ˆé€æ˜æç”»ï¼‰ */
  a-scene{position:fixed;inset:0;z-index:1}
  /* HUD */
  #hud{position:fixed;top:10px;left:10px;z-index:2;background:rgba(0,0,0,.55);padding:6px 10px;border-radius:8px}
  /* æœ€åˆã®è¨±å¯ã‚²ãƒ¼ãƒˆ */
  #gate{position:fixed;inset:0;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;background:#000;z-index:3}
  button{padding:12px 18px;font-size:18px;border:0;border-radius:10px;background:#2196f3;color:#fff}
</style>

<!-- A-Frame + AR.jsï¼ˆGPSï¼‰ -->
<script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
</head>
<body>

<!-- èƒŒæ™¯ã‚«ãƒ¡ãƒ©ï¼ˆè‡ªå‰ã§ getUserMedia ã‚’æµã™ï¼‰ -->
<video id="cam" playsinline autoplay muted></video>

<!-- HUD -->
<div id="hud">lat:- lon:- Â±- m</div>

<!-- è¨±å¯ã‚²ãƒ¼ãƒˆ -->
<div id="gate">
  <div style="opacity:.8">ğŸ“·ã‚«ãƒ¡ãƒ©ãƒ»ğŸ“ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
  <button id="start">é–‹å§‹</button>
  <div id="err" style="color:#f66"></div>
</div>

<!-- A-Frameï¼ˆé€æ˜æç”» / AR.jsã¯ videoTexture ã‚’ç„¡åŠ¹åŒ–ï¼‰ -->
<a-scene
  embedded
  renderer="alpha:true;colorManagement:true;physicallyCorrectLights:true"
  arjs="sourceType: webcam; videoTexture: false; gpsMinDistance:1; debugUIEnabled:false">
  <a-camera gps-camera rotation-reader></a-camera>
  <a-entity light="type:ambient;intensity:0.9"></a-entity>
  <!-- ç›®çš„åœ°ï¼ˆä¾‹ï¼šã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«ï¼‰ -->
  <a-entity gps-entity-place="latitude:38.101327; longitude:140.043027">
    <a-sphere color="#ff9800" radius="0.5"></a-sphere>
    <a-text value="ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«" align="center" position="0 1 0" color="#fff"></a-text>
  </a-entity>
</a-scene>

<script>
const hud = document.getElementById('hud');
const gate = document.getElementById('gate');
const err  = document.getElementById('err');
const video= document.getElementById('cam');

document.getElementById('start').onclick = async () => {
  try {
    // 1) ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’è‡ªå‰ã§é–‹å§‹ï¼ˆèƒŒé¢å„ªå…ˆï¼‰
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'}}, audio:false
    });
    video.srcObject = stream;

    // 2) ä½ç½®æƒ…å ±ï¼ˆ1å›å–ã£ã¦HUDæ›´æ–°ï¼‰
    await new Promise((res, rej)=>{
      navigator.geolocation.getCurrentPosition(p=>{
        const c=p.coords;
        hud.textContent=`lat:${c.latitude.toFixed(6)}  lon:${c.longitude.toFixed(6)}  Â±${c.accuracy.toFixed(1)} m`;
        res();
      }, e=>rej(e), {enableHighAccuracy:true, timeout:8000});
    });

    // 3) æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ï¼ˆiOSæ‰‹å‹•è¨±å¯ï¼‰
    if (window.DeviceOrientationEvent && DeviceOrientationEvent.requestPermission) {
      try { await DeviceOrientationEvent.requestPermission(); } catch(_){}
    }

    // 4) ã‚²ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
    gate.remove();

    // 5) GPSæ›´æ–°æ™‚ã«HUDã‚’ãƒ©ã‚¤ãƒ–æ›´æ–°
    document.querySelector('[gps-camera]')
      .addEventListener('gps-camera-update-position', e=>{
        const {latitude,longitude,accuracy} = e.detail.position;
        hud.textContent=`lat:${latitude.toFixed(6)}  lon:${longitude.toFixed(6)}  Â±${accuracy.toFixed(1)} m`;
      });

  } catch(e){
    err.textContent = 'è¨±å¯/èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + (e.message || e.name || e);
  }
};
</script>
</body>
</html>
