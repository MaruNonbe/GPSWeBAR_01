<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPSãƒˆãƒªã‚¬ãƒ¼ARï¼‹åœ°å›³ï¼ˆ3Dç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <!-- ãƒ‡ãƒãƒƒã‚°(ä¸è¦ãªã‚‰æ¶ˆã—ã¦OK) -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <style>
    :root { --tab-h: 50px; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
      background: #000;
    }
    /* ã‚¿ãƒ– */
    #tabs {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--tab-h);
      background: #000;
      display: flex;
      z-index: 10000;
    }
    #tabs button {
      flex: 1;
      border: none;
      background: #000;
      color: #fff;
      font-size: 16px;
    }
    #tabs button.active { background: #333; }

    /* ARã‚·ãƒ¼ãƒ³ */
    a-scene {
      position: fixed !important;
      top: var(--tab-h);
      left: 0;
      right: 0;
      bottom: 0;
      width: 100% !important;
      height: calc(100vh - var(--tab-h)) !important;
      z-index: 1;
      display: none; /* ãƒœã‚¿ãƒ³æŠ¼ã™ã¾ã§å‡ºã•ãªã„ */
    }

    /* HUD */
    #hud {
      position: fixed;
      top: calc(var(--tab-h) + 8px);
      left: 8px;
      z-index: 10001;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 14px;
      line-height: 1.4;
      padding: 6px 8px;
      border-radius: 4px;
      white-space: pre-line;
      max-width: 90vw;
      display: none;
    }

    /* ãƒãƒƒãƒ— */
    #map-view {
      position: fixed;
      top: var(--tab-h);
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 5000;
      display: none;
    }
    #map { width: 100%; height: 100%; }

    /* è¨±å¯ãƒœã‚¿ãƒ³ */
    #permissionOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    #permissionOverlay button {
      margin-top: 20px;
      background: #007bff;
      border: none;
      color: #fff;
      padding: 14px 26px;
      font-size: 18px;
      border-radius: 8px;
    }
  </style>
</head>
<body>

  <!-- å…¨ç”»é¢ã®è¨±å¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="permissionOverlay">
    <div>ARè¡¨ç¤ºã®ãŸã‚ã«<br>ã‚«ãƒ¡ãƒ©ã¨ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚</div>
    <button id="startBtn">ARã‚’é–‹å§‹ã™ã‚‹</button>
  </div>

  <!-- ã‚¿ãƒ– -->
  <div id="tabs">
    <button id="tab-ar" class="active">ARè¡¨ç¤º</button>
    <button id="tab-map">èµ°è¡Œãƒãƒƒãƒ—</button>
  </div>

  <!-- HUD -->
  <div id="hud">ä½ç½®ã‚’å–å¾—ä¸­â€¦</div>

  <!-- ARã‚·ãƒ¼ãƒ³ -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="antialias: true; alpha: true"
    id="ar-scene"
  >
    <a-assets>
      <!-- é©å½“ãªåŠ¹æœéŸ³ã€‚ä¸è¦ãªã‚‰æ¶ˆã—ã¦OK -->
      <audio id="ding" src="https://cdn.aframe.io/basic-guide/audio/backgroundnoise.wav"></audio>
    </a-assets>

    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <!-- ãƒãƒƒãƒ—è¡¨ç¤º -->
  <div id="map-view">
    <div id="map"></div>
  </div>

<script>
/* ========= 1. GASã®URL ========= */
const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw_uhqYjG25qdhdrZ6zCZgjTCKPVypqmTcgKenXBtt4LSBCaoARHYSAYxtMEHijY1rSdA/exec';

function sendLog(p){
  fetch(LOG_ENDPOINT,{
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(p)
  }).catch(e=>console.warn('log fail',e));
}

/* ========= 2. GPSåœ°ç‚¹ ========= */
const PLACES = [
  { id: 'tas-park',         name: 'TasParkHotel',       lat: 38.10148128126027, lon: 140.0433090680094, radius: 20 },
  { id: 'MichinoEkiNagai',  name: 'MichinoEkiNagai',    lat: 38.108970970886325, lon: 140.04382939078403, radius: 100 },
  { id: 'MNagaiShougakkou', name: 'MNagaiShougakkou',   lat: 38.107796313044474, lon: 140.04269068239356, radius: 100 },
  { id: 'Kozakurakan',      name: 'Kozakurakan',        lat: 38.110963329145335, lon: 140.03632275489852, radius: 100 },
  { id: 'Marudaiougiya',    name: 'Marudaiougiya',      lat: 38.11228246118919,  lon: 140.036198935986,   radius: 100 },
  { id: 'Nagaisiyakusho',   name: 'Nagaisiyakusho',     lat: 38.1063333593554,   lon: 140.033892868012,   radius: 100 },
  { id: 'NagaiKougyokoukou',name: 'NagaiKougyokoukou',  lat: 38.114426209437404, lon: 140.03013087985815, radius: 100 },
  { id: 'Nagaikoukou',      name: 'Nagaikoukou',        lat: 38.097283861825424, lon: 140.0380452392042,  radius: 100 },
  { id: 'MinamiNagai',      name: 'MinamiNagai',        lat: 38.09769549394771,  lon: 140.03458623775896, radius: 100 },
  { id: 'Kurunt',           name: 'Kurunt',             lat: 38.10491876278905,  lon: 140.03466346205656, radius: 100 }
];

const hud = document.getElementById('hud');

/* ========= è·é›¢è¨ˆç®— ========= */
function distanceMeter(lat1, lon1, lat2, lon2){
  const R=6378137, toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1);
  const dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* ========= 3Dã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆ ========= */
function createPlaceEntities(){
  const scene = document.querySelector('a-scene');

  /* â‘  å¸¸ã«è¦‹ãˆã‚‹ãƒ†ã‚¹ãƒˆç”¨ï¼ˆGPSã¨ç„¡é–¢ä¿‚ï¼‰ */
  const test = document.createElement('a-box');
  test.setAttribute('position','0 1.5 -3');
  test.setAttribute('color','#ffff55');
  test.setAttribute('scale','2 2 2');
  test.setAttribute('animation','property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear');
  scene.appendChild(test);

  /* â‘¡ GPSã§å‡ºã™ã‚„ã¤ */
  PLACES.forEach((p, idx) => {
    const wrapper = document.createElement('a-entity');
    wrapper.setAttribute('id', 'place-' + p.id);
    wrapper.setAttribute('position', '0 1.5 -6');     // ã‚«ãƒ¡ãƒ©ã‹ã‚‰6må‰ã«å›ºå®š
    wrapper.setAttribute('visible', 'false');

    // ã‚µã‚¦ãƒ³ãƒ‰
    const snd = document.createElement('a-sound');
    snd.setAttribute('id', 'sound-' + p.id);
    snd.setAttribute('src', '#ding');
    snd.setAttribute('autoplay', 'false');
    snd.setAttribute('volume', '2.0');
    wrapper.appendChild(snd);

    let child;
    switch(idx){
      case 0:
        child = document.createElement('a-box');
        child.setAttribute('color','#ff4444');
        break;
      case 1:
        child = document.createElement('a-sphere');
        child.setAttribute('color','#448aff');
        break;
      case 2:
        child = document.createElement('a-cone');
        child.setAttribute('color','#4caf50');
        break;
      case 3:
        child = document.createElement('a-cylinder');
        child.setAttribute('color','#ff9800');
        break;
      case 4:
        child = document.createElement('a-torus');
        child.setAttribute('radius','0.8');
        child.setAttribute('radius-tubular','0.12');
        child.setAttribute('color','#9c27b0');
        break;
      case 5:
        child = document.createElement('a-tetrahedron');
        child.setAttribute('color','#00bcd4');
        break;
      case 6:
        child = document.createElement('a-box');
        child.setAttribute('color','#cddc39');
        break;
      case 7:
        child = document.createElement('a-sphere');
        child.setAttribute('color','#ff6f00');
        break;
      case 8:
        child = document.createElement('a-cone');
        child.setAttribute('color','#795548');
        break;
      case 9:
      default:
        child = document.createElement('a-box');
        child.setAttribute('color','#03a9f4');
        break;
    }

    // ğŸ‘‡ã“ã“ã§10å€
    child.setAttribute('scale','10 10 10');
    child.setAttribute('animation','property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear');

    wrapper.appendChild(child);
    scene.appendChild(wrapper);

    // çŠ¶æ…‹ä¿æŒ
    p._isInside = false;
  });
}

/* ========= GPSç›£è¦– ========= */
let lastPos=null;
let lastSentAt=0;
let map, mapPolyline, mapPath=[];

function startGPSWatch(){
  navigator.geolocation.watchPosition(pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;
    const acc=pos.coords.accuracy;
    lastPos={lat,lon,acc};

    hud.textContent=`ğŸ“ ç¾åœ¨ä½ç½®\nlat:${lat.toFixed(6)}\nlon:${lon.toFixed(6)}\nç²¾åº¦:Â±${acc.toFixed(1)}m`;

    // å„åœ°ç‚¹ãƒã‚§ãƒƒã‚¯
    PLACES.forEach(p=>{
      const dist=distanceMeter(lat,lon,p.lat,p.lon);
      const ent=document.getElementById('place-'+p.id);
      const snd=document.getElementById('sound-'+p.id);
      const near=dist <= p.radius;

      if (ent) ent.setAttribute('visible', near);

      if(!p._isInside && near){
        sendLog({place_id:p.id,event:'enter',lat,lon});
        if (snd && snd.components && snd.components.sound) {
          snd.components.sound.playSound();
        }
      }
      if(p._isInside && !near){
        sendLog({place_id:p.id,event:'leave',lat,lon});
      }
      p._isInside = near;
    });

    // ãƒãƒƒãƒ—æç”»
    if(map){
      const posLatLng={lat, lng:lon};
      mapPath.push(posLatLng);
      mapPolyline.setPath(mapPath);
      map.setCenter(posLatLng);
    }

  },err=>{
    hud.textContent='ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆ'+err.message+'ï¼‰';
  },{enableHighAccuracy:true, maximumAge:0, timeout:5000});

  // 5ç§’ã”ã¨ã«ç¾åœ¨ä½ç½®ã‚’ãƒ­ã‚°ã¸
  setInterval(()=>{
    if(!lastPos) return;
    const now=Date.now();
    if(now-lastSentAt<5000) return;
    sendLog({place_id:'current',event:'position',lat:lastPos.lat,lon:lastPos.lon});
    lastSentAt=now;
  },5000);
}

/* ========= Googleãƒãƒƒãƒ— ========= */
function initMap(){
  const center = lastPos ? {lat:lastPos.lat,lng:lastPos.lon} : {lat:38.1014,lng:140.0433};
  map = new google.maps.Map(document.getElementById('map'),{
    center, zoom:16
  });
  mapPolyline = new google.maps.Polyline({
    map,
    path:[],
    strokeColor:'#ff0000',
    strokeWeight:3
  });
}

/* ========= ã‚¿ãƒ– ========= */
const tabAr=document.getElementById('tab-ar');
const tabMap=document.getElementById('tab-map');
const sceneEl=document.getElementById('ar-scene');
const mapView=document.getElementById('map-view');

tabAr.addEventListener('click',()=>{
  tabAr.classList.add('active');
  tabMap.classList.remove('active');
  sceneEl.style.display='block';
  mapView.style.display='none';
});
tabMap.addEventListener('click',()=>{
  tabMap.classList.add('active');
  tabAr.classList.remove('active');
  sceneEl.style.display='none';
  mapView.style.display='block';
  if(!map) initMap();
});

/* ========= è¨±å¯ãƒœã‚¿ãƒ³ ========= */
document.getElementById('startBtn').addEventListener('click', async ()=>{
  // iOSã®å‘ãè¨±å¯
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      await DeviceOrientationEvent.requestPermission();
    } catch (e) {
      console.warn(e);
    }
  }

  // Geolocationã‚‚ã“ã®ã‚¿ãƒƒãƒ—å†…ã§é–‹å§‹
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(()=>{}, ()=>{}, {enableHighAccuracy:true});
  }

  document.getElementById('permissionOverlay').style.display='none';
  sceneEl.style.display='block';
  hud.style.display='block';
  createPlaceEntities();
  startGPSWatch();
});
</script>

<!-- Google Maps APIï¼ˆãã®ã¾ã¾ï¼‰ -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACib9absBqRW6ErBmjg4_jXcfq-CihVYE"></script>
</body>
</html>
