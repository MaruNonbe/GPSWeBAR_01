<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS-AR æ‰‹å‹•èµ·å‹•ãƒ†ã‚¹ãƒˆ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font:14px/1.5 monospace;overflow:hidden;}
    #startGate{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:14px;background:#000;z-index:9999;}
    button{padding:12px 20px;font-size:18px;border-radius:10px;border:0;background:#2196f3;color:#fff;}
    #hud{position:fixed;top:10px;left:10px;z-index:9999}
  </style>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
</head>
<body>

<div id="hud">lat:- lon:- Â±-m</div>
<div id="startGate">
  <div>ğŸ“·+ğŸ“æ¨©é™ã‚’è¨±å¯ã—ã¦ã‹ã‚‰ã€ŒARé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
  <button id="startBtn">ARé–‹å§‹</button>
  <div id="msg" style="color:#f66"></div>
</div>

<a-scene id="scene" embedded vr-mode-ui="enabled:false"
  renderer="colorManagement:true;physicallyCorrectLights:true"
  arjs="sourceType:webcam;gpsMinDistance:1;debugUIEnabled:false;">
  <a-camera gps-camera rotation-reader></a-camera>
  <a-entity light="type:ambient;intensity:0.9"></a-entity>
  <a-entity id="poi" gps-entity-place="latitude:38.101327; longitude:140.043027">
    <a-sphere color="#ff9800" radius="0.5"></a-sphere>
  </a-entity>
</a-scene>

<script>
const hud = document.getElementById('hud');
const msg = document.getElementById('msg');
const gate = document.getElementById('startGate');

document.getElementById('startBtn').onclick = async () => {
  try {
    // ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’ç¢ºå®Ÿã«è¦æ±‚
    const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:{ideal:'environment'}}, audio:false });
    stream.getTracks().forEach(t=>t.stop());
    msg.textContent = 'âœ… ã‚«ãƒ¡ãƒ©OK';

    // ä½ç½®æƒ…å ±ã‚’å…ˆã«ãƒã‚§ãƒƒã‚¯
    await new Promise((res,rej)=>{
      navigator.geolocation.getCurrentPosition(p=>{
        hud.textContent=`lat:${p.coords.latitude.toFixed(6)} lon:${p.coords.longitude.toFixed(6)} Â±${p.coords.accuracy.toFixed(1)}m`;
        msg.textContent += ' âœ… GPS OK';
        res();
      }, e=>{
        msg.textContent='âŒ ä½ç½®æƒ…å ±å–å¾—å¤±æ•—:'+e.message;
        rej(e);
      },{enableHighAccuracy:true,timeout:8000});
    });

    // ã‚²ãƒ¼ãƒˆã‚’é–‰ã˜ã¦ARé–‹å§‹
    gate.remove();
    const scene = document.querySelector('a-scene');
    scene.style.display = 'block';

    // ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ç›£è¦–
    scene.addEventListener('camera-init', ()=>console.log('camera-init'));
    scene.addEventListener('camera-error', e=>{
      msg.textContent='âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:'+e.message;
    });

    // GPSæ›´æ–°æ™‚
    document.querySelector('[gps-camera]').addEventListener('gps-camera-update-position', e=>{
      const {latitude,longitude,accuracy}=e.detail.position;
      hud.textContent=`lat:${latitude.toFixed(6)} lon:${longitude.toFixed(6)} Â±${accuracy.toFixed(1)}m`;
    });

  }catch(e){
    msg.textContent='âŒ æ¨©é™å–å¾—ã‚¨ãƒ©ãƒ¼:'+e.name+' '+e.message;
  }
};
</script>
</body>
</html>
