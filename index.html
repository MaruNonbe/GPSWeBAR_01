<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>GPS-AR Stable (categories, auto-threshold, lazy glb)</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #hud{position:fixed;top:12px;left:12px;right:12px;z-index:9999;
       font:16px/1.55 ui-monospace,monospace;color:#fff}
  .tag{display:inline-block;background:rgba(0,0,0,.55);
       padding:8px 10px;border-radius:8px;margin-bottom:6px}
  #gate{position:fixed;inset:0;background:#000;display:flex;
        align-items:center;justify-content:center;z-index:10000}
  #gate button{font-size:18px;padding:12px 18px;border:0;border-radius:10px}
</style>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆé€šå¸¸CDN â†’ äºˆå‚™CDNã«è‡ªå‹•ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ï¼‰ -->
<script>
(async()=>{
  async function loadOne(list){ for(const u of list){
    try{ await new Promise((ok,ng)=>{const s=document.createElement('script'); s.src=u; s.onload=ok; s.onerror=ng; document.head.appendChild(s);}); return; }
    catch(_){} } throw new Error('CDN load failed'); }
  await loadOne(['https://aframe.io/releases/1.4.1/aframe.min.js',
                 'https://unpkg.com/aframe@1.4.1/dist/aframe.min.js']);
  await loadOne(['https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js',
                 'https://unpkg.com/aframe-ar.js@3.3.2/aframe-ar.min.js']);
})();
</script>
</head>
<body>

<!-- HUD -->
<div id="hud">
  <div id="latlon" class="tag">lat: -  lon: -  Â±- m</div><br>
  <div id="nearest" class="tag">nearest: -</div><br>
  <div id="dist" class="tag">distance: - m</div><br>
  <div id="status" class="tag">status: ready</div>
</div>

<!-- ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—é–‹å§‹ï¼ˆæ¨©é™ç¢ºå®ŸåŒ–ï¼‰ -->
<div id="gate"><button id="startBtn">ğŸ“· ARã‚’é–‹å§‹</button></div>

<!-- A-Frame Scene -->
<a-scene id="scene"
  embedded
  vr-mode-ui="enabled: false"
  renderer="colorManagement: true; physicallyCorrectLights: true"
  arjs="sourceType: webcam; gpsMinDistance: 1; debugUIEnabled: false;">
  <a-camera gps-camera rotation-reader></a-camera>
  <a-entity light="type:ambient; intensity:0.9"></a-entity>

  <!-- ã‚«ãƒ†ã‚´ãƒªè¦ªã¯å¸¸æ™‚ visible=trueï¼ˆå­ã®å¯è¦–åˆ‡æ›¿ã§äº‹æ•…ã‚‰ãªã„ï¼‰ -->
  <a-entity id="cat-school" visible="true"></a-entity>
  <a-entity id="cat-public" visible="true"></a-entity>
  <a-entity id="cat-hotel"  visible="true"></a-entity>
</a-scene>

<script>
/*** è¨­å®š ***/
const USE_MODEL = false;   // â† ã¾ãšã¯falseã§å®‰å®šé‹ç”¨ã€‚å¿…è¦æ™‚ã«trueã¸
const USE_SOUND = false;   // â† å¿…è¦æ™‚ã«true
// POIå®šç¾©ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ï¼‰
const POIS = [
  { id:'tas-entrance', name:'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«', lat:38.101327, lon:140.043027,
    category:'hotel', color:'#16c7d9',
    modelUrl:'model.glb', soundUrl:'sound.mp3' }
  // ä¾‹:
  // { id:'nagai-school', name:'é•·äº•â—‹â—‹å°', lat:38.xxxxx, lon:140.xxxxx, category:'school', color:'#4caf50' }
];

const hudLatlon = document.getElementById('latlon');
const hudNearest= document.getElementById('nearest');
const hudDist   = document.getElementById('dist');
const hudStatus = document.getElementById('status');
const scene     = document.getElementById('scene');

const catRoot = {
  school: document.getElementById('cat-school'),
  public: document.getElementById('cat-public'),
  hotel : document.getElementById('cat-hotel')
};

// ç”Ÿæˆã—ãŸPOIã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å‚ç…§è¡¨
const poiMap = new Map();

// POIãƒãƒ¼ãƒ‰ã‚’æ§‹ç¯‰ï¼ˆè¦ªã«å¯¾ã—ã¦å¯è¦–åˆ‡æ›¿ã™ã‚‹ï¼‰
function buildPOINode(p){
  const parent = document.createElement('a-entity');
  parent.setAttribute('id', 'poi-' + p.id);
  parent.setAttribute('gps-entity-place', `latitude:${p.lat}; longitude:${p.lon}`);
  parent.setAttribute('position', '0 1 0');              // â† Y+1mï¼ˆåŸ‹æ²¡é˜²æ­¢ï¼‰
  parent.setAttribute('visible', 'false');               // åˆæœŸã¯éè¡¨ç¤º
  parent.setAttribute('look-at', '[gps-camera]');

  // ãƒ‡ãƒãƒƒã‚°ãƒ”ãƒ³ï¼ˆå¿…ãšè¦‹ãˆã‚‹å½¢çŠ¶ï¼‰
  const pin = document.createElement('a-entity');
  pin.innerHTML = `
    <a-torus radius="0.6" radius-tubular="0.03" rotation="-90 0 0" color="${p.color||'#ff9800'}"></a-torus>
    <a-cylinder height="0.9" radius="0.12" color="${p.color||'#ff9800'}" position="0 0.45 0"></a-cylinder>
    <a-sphere radius="0.22" color="${p.color||'#ff9800'}" position="0 0.95 0"></a-sphere>
    <a-text value="${p.name}" align="center" position="0 1.35 0" color="#fff"></a-text>
  `;
  parent.appendChild(pin);

  // 3Dãƒ¢ãƒ‡ãƒ«ï¼ˆé…å»¶ãƒ­ãƒ¼ãƒ‰ç”¨ï¼šæœ€åˆã¯æ®»ã ã‘ï¼‰
  const mdl = document.createElement('a-entity');
  mdl.setAttribute('id', 'mdl-'+p.id);
  mdl.setAttribute('visible', USE_MODEL ? 'true' : 'false');
  parent.appendChild(mdl);

  // éŸ³ï¼ˆpositionalï¼‰
  const snd = document.createElement('a-entity');
  snd.setAttribute('id','snd-'+p.id);
  if (USE_SOUND && p.soundUrl) {
    snd.setAttribute('sound', `src: url(${p.soundUrl}); autoplay: false; positional: true`);
  }
  parent.appendChild(snd);

  // ã‚«ãƒ†ã‚´ãƒªé…ä¸‹ã¸
  (catRoot[p.category]||catRoot.public).appendChild(parent);

  // å‚ç…§ä¿å­˜
  poiMap.set(p.id, {p, parent, mdl, snd, loaded:false});
}

// ã™ã¹ã¦æ§‹ç¯‰
POIS.forEach(buildPOINode);

// ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼šç¢ºå®Ÿã«ã‚²ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
document.getElementById('startBtn').onclick = async () => {
  document.getElementById('gate').style.display='none';
  hudStatus.textContent = 'status: starting camera...';
  try{
    // äº‹å‰ã«ä¸€åº¦getUserMediaã—ã¦æ¨©é™ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ç¢ºå®Ÿã«å‡ºã™ï¼ˆå³åœæ­¢ï¼‰
    const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}, audio:false});
    s.getTracks().forEach(t=>t.stop());
  }catch(_){} // å¤±æ•—ã—ã¦ã‚‚AR.jså´ãŒæ”¹ã‚ã¦è¦æ±‚ã™ã‚‹

  // å¿µã®ãŸã‚AR.jsã‚½ãƒ¼ã‚¹å†èµ·å‹•
  const sys = scene.systems['arjs'];
  try{ sys?.arSource?.stop(); }catch(_){}
  try{ await sys?.arSource?.start(); }catch(_){}
};

// GPSæ›´æ–°ã§ãƒˆãƒªã‚¬åˆ¤å®š
const camEl = document.querySelector('[gps-camera]');
camEl.addEventListener('gps-camera-update-position', (e)=>{
  const {position, accuracy} = e.detail || {};
  if (!position) return;

  const lat = position.latitude, lon = position.longitude;
  const acc = (accuracy||0);
  hudLatlon.textContent = `lat:${lat.toFixed(6)}  lon:${lon.toFixed(6)}  Â±${acc.toFixed(1)} m`;

  // ã—ãã„å€¤ã¯ç²¾åº¦é€£å‹•ï¼ˆæœ€ä½25mï¼‰
  const TRIGGER = Math.max(acc*1.5, 25);

  // æœ€å¯„ã‚Šï¼†å„POIã®è¡¨ç¤ºåˆ¶å¾¡
  let nearest = {name:'-', d:Infinity};
  let inCount = 0;

  for (const {p, parent, mdl, snd, loaded} of poiMap.values()){
    const d = haversine(lat, lon, p.lat, p.lon);
    if (d < nearest.d) nearest = {name:p.name, d};

    const inRange = d < TRIGGER;
    parent.setAttribute('visible', inRange ? 'true' : 'false');

    if (inRange){
      inCount++;

      // GLBé…å»¶ãƒ­ãƒ¼ãƒ‰ï¼ˆåˆå›ã®ã¿ï¼‰
      if (USE_MODEL && p.modelUrl && !loaded){
        mdl.setAttribute('gltf-model', p.modelUrl);
        poiMap.get(p.id).loaded = true;
      }

      // ã‚µã‚¦ãƒ³ãƒ‰
      if (USE_SOUND && p.soundUrl){
        const comp = snd.components.sound;
        if (comp && !comp.isPlaying) comp.playSound();
      }
    }else{
      // ç¯„å›²å¤–ã«ãªã‚Œã°éŸ³ã‚’æ­¢ã‚ã‚‹
      const comp = snd.components?.sound;
      if (comp?.isPlaying) comp.stopSound();
    }
  }

  hudNearest.textContent = `nearest: ${isFinite(nearest.d)?nearest.name:'-'}`
  hudDist.textContent    = `distance: ${isFinite(nearest.d)?nearest.d.toFixed(1):'-'} m`;
  hudStatus.textContent  = inCount>0 ? `status: IN-RANGE (<= ${TRIGGER.toFixed(1)} m, hit:${inCount})`
                                     : `status: out of range (<= ${TRIGGER.toFixed(1)} m)`;
});

// Haversine (m)
function haversine(lat1, lon1, lat2, lon2){
  const R=6371000, toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ã‚«ãƒ¡ãƒ©/ã‚¨ãƒ©ãƒ¼ã®è¦‹ãˆã‚‹åŒ–ï¼ˆãƒ‡ãƒãƒƒã‚°ã«ä¾¿åˆ©ï¼‰
scene.addEventListener('arjs-video-loaded', ()=> hudStatus.textContent='status: camera started');
scene.addEventListener('camera-error', e=> hudStatus.textContent='status: camera-error');
</script>
</body>
</html>
