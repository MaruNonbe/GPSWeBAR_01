<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPSãƒˆãƒªã‚¬ãƒ¼ARï¼‹åœ°å›³ï¼ˆ3Dç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <!-- ï¼ˆå¿…è¦ãªã‚‰ï¼‰ã‚³ãƒ³ã‚½ãƒ¼ãƒ«è¡¨ç¤º -->
  <!--
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  -->

  <style>
    :root { --tab-h: 50px; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
      background: #000;
    }

    /* ã‚¿ãƒ– */
    #tabs {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--tab-h);
      background: #000;
      display: flex;
      z-index: 10000;
    }
    #tabs button {
      flex: 1;
      border: none;
      background: #000;
      color: #fff;
      font-size: 16px;
    }
    #tabs button.active { background: #333; }

    /* ARã‚·ãƒ¼ãƒ³ã¯ã‚¿ãƒ–ã®ä¸‹ã«è²¼ã‚Šä»˜ã‘ */
    a-scene {
      position: fixed !important;
      top: var(--tab-h);
      left: 0;
      right: 0;
      bottom: 0;
      width: 100% !important;
      height: calc(100vh - var(--tab-h)) !important;
      z-index: 1;
      display: none; /* è¨±å¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§ã¯éè¡¨ç¤º */
    }

    /* HUD(ç¾åœ¨ä½ç½®) */
    #hud {
      position: fixed;
      top: calc(var(--tab-h) + 8px);
      left: 8px;
      z-index: 10001;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 14px;
      line-height: 1.4;
      padding: 6px 8px;
      border-radius: 4px;
      white-space: pre-line;
      max-width: 90vw;
      display: none;
    }

    /* ãƒãƒƒãƒ—è¡¨ç¤º */
    #map-view {
      position: fixed;
      top: var(--tab-h);
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 5000;
      display: none;
    }
    #map { width: 100%; height: 100%; }

    /* è¨±å¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #permissionOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    #permissionOverlay button {
      margin-top: 20px;
      background: #007bff;
      border: none;
      color: #fff;
      padding: 14px 26px;
      font-size: 18px;
      border-radius: 8px;
    }
  </style>
</head>
<body>

  <!-- å…¨ç”»é¢ã®è¨±å¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="permissionOverlay">
    <div>ARè¡¨ç¤ºã®ãŸã‚ã«<br>ã‚«ãƒ¡ãƒ©ã¨ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚</div>
    <button id="startBtn">ARã‚’é–‹å§‹ã™ã‚‹</button>
  </div>

  <!-- ã‚¿ãƒ– -->
  <div id="tabs">
    <button id="tab-ar" class="active">ARè¡¨ç¤º</button>
    <button id="tab-map">èµ°è¡Œãƒãƒƒãƒ—</button>
  </div>

  <!-- HUD -->
  <div id="hud">ä½ç½®ã‚’å–å¾—ä¸­â€¦</div>

  <!-- ARã‚·ãƒ¼ãƒ³ -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="antialias: true; alpha: true"
    id="ar-scene"
  >
    <a-assets>
      <!-- ã‚·ãƒ³ãƒ—ãƒ«ãªéŸ³æºï¼ˆè‡ªç”±ã«å·®ã—æ›¿ãˆå¯ï¼‰ -->
      <audio id="ding" src="https://cdn.aframe.io/basic-guide/audio/backgroundnoise.wav"></audio>
    </a-assets>

    <!-- GPSç”¨ã‚«ãƒ¡ãƒ© -->
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <!-- ãƒãƒƒãƒ—è¡¨ç¤º -->
  <div id="map-view">
    <div id="map"></div>
  </div>

<script>
/* ===== 1. ãƒ­ã‚°é€ä¿¡ç”¨GASã®URL ===== */
const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw_uhqYjG25qdhdrZ6zCZgjTCKPVypqmTcgKenXBtt4LSBCaoARHYSAYxtMEHijY1rSdA/exec';

function sendLog(p){
  fetch(LOG_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(p)
  }).catch(e => console.warn('log fail', e));
}

/* ===== 2. 10åœ°ç‚¹ã®å®šç¾© =====
   åŠå¾„ã¯è¡¨ç¤ºã—ã‚„ã™ã„ã‚ˆã†ã« 50m ã«ã—ã¦ã„ã¾ã™
*/
const PLACES = [
  { id: 'tas-park',         name: 'TasParkHotel',       lat: 38.10148128126027,  lon: 140.0433090680094,  radius: 100 },
  { id: 'MichinoEkiNagai',  name: 'MichinoEkiNagai',    lat: 38.108970970886325, lon: 140.04382939078403, radius: 100 },
  { id: 'MNagaiShougakkou', name: 'MNagaiShougakkou',   lat: 38.107796313044474, lon: 140.04269068239356, radius: 100 },
  { id: 'Kozakurakan',      name: 'Kozakurakan',        lat: 38.110963329145335, lon: 140.03632275489852, radius: 100 },
  { id: 'Marudaiougiya',    name: 'Marudaiougiya',      lat: 38.11228246118919,  lon: 140.036198935986,   radius: 100 },
  { id: 'Nagaisiyakusho',   name: 'Nagaisiyakusho',     lat: 38.1063333593554,   lon: 140.033892868012,   radius: 100 },
  { id: 'NagaiKougyokoukou',name: 'NagaiKougyokoukou',  lat: 38.114426209437404, lon: 140.03013087985815, radius: 100 },
  { id: 'Nagaikoukou',      name: 'Nagaikoukou',        lat: 38.097283861825424, lon: 140.0380452392042,  radius: 100 },
  { id: 'MinamiNagai',      name: 'MinamiNagai',        lat: 38.09769549394771,  lon: 140.03458623775896, radius: 100 },
  { id: 'Kurunt',           name: 'Kurunt',             lat: 38.10491876278905,  lon: 140.03466346205656, radius: 100 }
];

const hud = document.getElementById('hud');

/* ===== è·é›¢è¨ˆç®—ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰ ===== */
function distanceMeter(lat1, lon1, lat2, lon2){
  const R = 6378137;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ===== 3. 3Dã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆ =====
   - ãœã‚“ã¶ scale="10 10 10"
   - ç”»é¢ã‹ã‚‰å°‘ã—é›¢ã—ã¦ position="0 1.5 -6"
*/
function createPlaceEntities(){
  const scene = document.querySelector('a-scene');

  PLACES.forEach((p, idx) => {
    const wrapper = document.createElement('a-entity');
    wrapper.setAttribute('id', 'place-' + p.id);
    wrapper.setAttribute('position', '0 1.5 -6');  // å°‘ã—å‰æ–¹
    wrapper.setAttribute('visible', 'false');

    // å…¥å®¤ç”¨ã®éŸ³
    const snd = document.createElement('a-sound');
    snd.setAttribute('id', 'sound-' + p.id);
    snd.setAttribute('src', '#ding');
    snd.setAttribute('autoplay', 'false');
    wrapper.appendChild(snd);

    let child;

    switch(idx){
      case 0: // èµ¤ã„ç®±
        child = document.createElement('a-box');
        child.setAttribute('color', '#ff4444');
        break;
      case 1: // é’ã„çƒ
        child = document.createElement('a-sphere');
        child.setAttribute('color', '#448aff');
        break;
      case 2: // ç·‘ã®å††éŒ
        child = document.createElement('a-cone');
        child.setAttribute('color', '#4caf50');
        break;
      case 3: // ã‚ªãƒ¬ãƒ³ã‚¸å††æŸ±
        child = document.createElement('a-cylinder');
        child.setAttribute('color', '#ff9800');
        break;
      case 4: // ç´«ãƒˆãƒ¼ãƒ©ã‚¹ï¼ˆgeometryã§ä½œã‚‹ï¼‰
        child = document.createElement('a-entity');
        child.setAttribute('geometry', 'primitive: torus; radius: 0.8; radiusTubular: 0.12');
        child.setAttribute('material', 'color: #9c27b0');
        break;
      case 5: // æ°´è‰²ã®å››é¢ä½“
        child = document.createElement('a-entity');
        child.setAttribute('geometry', 'primitive: tetrahedron; radius: 1');
        child.setAttribute('material', 'color: #00bcd4');
        break;
      case 6: // é»„ç·‘ã®ç®±
        child = document.createElement('a-box');
        child.setAttribute('color', '#cddc39');
        break;
      case 7: // ã‚ªãƒ¬ãƒ³ã‚¸ã®å°çƒ
        child = document.createElement('a-sphere');
        child.setAttribute('color', '#ff6f00');
        break;
      case 8: // èŒ¶è‰²ã®å††éŒ
        child = document.createElement('a-cone');
        child.setAttribute('color', '#795548');
        break;
      case 9:
      default: // æ°´è‰²ã®å¤§ãã‚ç®±
        child = document.createElement('a-box');
        child.setAttribute('color', '#03a9f4');
        break;
    }

    // â˜…ã“ã“ã§ã‚µã‚¤ã‚º10å€
    child.setAttribute('scale', '10 10 10');

    // ãã‚‹ãã‚‹å›ã™
    child.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear');

    wrapper.appendChild(child);
    scene.appendChild(wrapper);

    // å†…éƒ¨çŠ¶æ…‹
    p._isInside = false;
  });
}

/* ===== GPSç›£è¦–ï¼†ãƒ­ã‚° ===== */
let lastPos = null;
let lastSentAt = 0;
let map, mapPolyline, mapPath = [];

function startGPSWatch(){
  navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const acc = pos.coords.accuracy;
    lastPos = {lat, lon, acc};

    hud.textContent = `ğŸ“ ç¾åœ¨ä½ç½®\nlat:${lat.toFixed(6)}\nlon:${lon.toFixed(6)}\nç²¾åº¦:Â±${acc.toFixed(1)}m`;

    // å„åœ°ç‚¹ã¨ã®è·é›¢ã§è¡¨ç¤ºON/OFF
    PLACES.forEach(p => {
      const dist = distanceMeter(lat, lon, p.lat, p.lon);
      const ent  = document.getElementById('place-' + p.id);
      const snd  = document.getElementById('sound-' + p.id);
      const near = dist <= p.radius;

      if (ent) ent.setAttribute('visible', near);

      // å…¥ã£ãŸç¬é–“ã ã‘ãƒ­ã‚°ï¼†éŸ³
      if (!p._isInside && near){
        sendLog({place_id: p.id, event: 'enter', lat, lon});
        if (snd && snd.components && snd.components.sound){
          snd.components.sound.playSound();
        }
      }
      if (p._isInside && !near){
        sendLog({place_id: p.id, event: 'leave', lat, lon});
      }
      p._isInside = near;
    });

    // ãƒãƒƒãƒ—å‘ã‘ã«ã‚‚ä¿å­˜
    if (map){
      const posLatLng = {lat, lng: lon};
      mapPath.push(posLatLng);
      mapPolyline.setPath(mapPath);
      map.setCenter(posLatLng);
    }

  }, err => {
    hud.textContent = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆ' + err.message + 'ï¼‰';
  }, {enableHighAccuracy: true, maximumAge: 0, timeout: 5000});

  // 5ç§’ãŠãã®ä½ç½®ãƒ­ã‚°
  setInterval(() => {
    if (!lastPos) return;
    const now = Date.now();
    if (now - lastSentAt < 5000) return;
    sendLog({place_id: 'current', event: 'position', lat: lastPos.lat, lon: lastPos.lon});
    lastSentAt = now;
  }, 5000);
}

/* ===== Googleãƒãƒƒãƒ—åˆæœŸåŒ– ===== */
function initMap(){
  const center = lastPos ? {lat: lastPos.lat, lng: lastPos.lon} : {lat: 38.1014, lng: 140.0433};
  map = new google.maps.Map(document.getElementById('map'), {
    center,
    zoom: 16
  });
  mapPolyline = new google.maps.Polyline({
    map,
    path: [],
    strokeColor: '#ff0000',
    strokeWeight: 3
  });
}

/* ===== ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ===== */
const tabAr   = document.getElementById('tab-ar');
const tabMap  = document.getElementById('tab-map');
const sceneEl = document.getElementById('ar-scene');
const mapView = document.getElementById('map-view');

tabAr.addEventListener('click', () => {
  tabAr.classList.add('active');
  tabMap.classList.remove('active');
  sceneEl.style.display = 'block';
  mapView.style.display  = 'none';
});

tabMap.addEventListener('click', () => {
  tabMap.classList.add('active');
  tabAr.classList.remove('active');
  sceneEl.style.display = 'none';
  mapView.style.display  = 'block';
  if (!map) initMap();
});

/* ===== è¨±å¯ãƒœã‚¿ãƒ³ ===== */
document.getElementById('startBtn').addEventListener('click', async () => {
  // iOSã®å‘ãè¨±å¯
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      await DeviceOrientationEvent.requestPermission();
    } catch (e) {
      console.warn('orientation err', e);
    }
  }

  // geolocationã‚‚ã“ã®ã‚¯ãƒªãƒƒã‚¯å†…ã§èµ·å‹•
  if (navigator.geolocation){
    navigator.geolocation.getCurrentPosition(()=>{}, ()=>{}, {enableHighAccuracy:true});
  }

  // è¡¨ç¤ºã‚’å‡ºã™
  document.getElementById('permissionOverlay').style.display = 'none';
  sceneEl.style.display = 'block';
  hud.style.display      = 'block';

  // 3Dã‚’ä½œã£ã¦ã‹ã‚‰GPSç›£è¦–é–‹å§‹
  createPlaceEntities();
  startGPSWatch();
});
</script>

<!-- Google Maps APIï¼ˆãã®ã¾ã¾ï¼‰ -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACib9absBqRW6ErBmjg4_jXcfq-CihVYE"></script>
</body>
</html>
