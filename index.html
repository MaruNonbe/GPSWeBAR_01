<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS ARï¼‹ãƒãƒƒãƒ—ï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆä»»æ„ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <style>
    /* ç”»é¢å…¨ä½“ãƒªã‚»ãƒƒãƒˆ */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: sans-serif;
    }

    /* --- ã‚¿ãƒ–ãƒãƒ¼ --- */
    #tabbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 42px;
      background: rgba(0,0,0,0.55);
      display: flex;
      z-index: 99999; /* â†æœ€å‰é¢ */
      backdrop-filter: blur(4px);
    }
    #tabbar button {
      flex: 1;
      border: none;
      background: transparent;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    #tabbar button.active {
      background: rgba(255,255,255,0.18);
    }

    /* --- ARè¡¨ç¤ºã‚¨ãƒªã‚¢ --- */
    #ar-pane {
      position: absolute;
      top: 42px;      /* ã‚¿ãƒ–ã®é«˜ã•ã¶ã‚“ä¸‹ã’ã‚‹ */
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* HUD */
    #hud {
      position: fixed;
      top: 48px; /* ã‚¿ãƒ–ã®ä¸‹ã«å‡ºã™ */
      left: 8px;
      z-index: 9999;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 12px;
      line-height: 1.4;
      padding: 6px 8px;
      border-radius: 4px;
      max-width: 90vw;
      white-space: pre-line;
    }

    /* --- ãƒãƒƒãƒ—ã‚¨ãƒªã‚¢ --- */
    #map-pane {
      position: absolute;
      top: 42px;
      left: 0;
      right: 0;
      bottom: 0;
      display: none;  /* åˆæœŸã¯éè¡¨ç¤º */
    }
    #map {
      width: 100%;
      height: 100%;
    }

    /* iPhoneã®ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒœã‚¿ãƒ³ */
    #sensorButton {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #007bff;
      color: #fff;
      padding: 14px 26px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      z-index: 99999;
    }
  </style>
</head>
<body>

  <!-- ã‚¿ãƒ– -->
  <div id="tabbar">
    <button id="tab-ar" class="active">ARè¡¨ç¤º</button>
    <button id="tab-map">èµ°è¡Œãƒãƒƒãƒ—</button>
  </div>

  <!-- ARãƒ‘ãƒãƒ« -->
  <div id="ar-pane">
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      renderer="antialias: true; alpha: true"
    >
      <a-camera gps-camera rotation-reader></a-camera>
      <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ã®å°ç®± -->
      <a-box position="0 0 -2" depth="0.2" height="0.2" width="0.2" color="#00FFAA"></a-box>
    </a-scene>
  </div>

  <!-- ãƒãƒƒãƒ—ãƒ‘ãƒãƒ« -->
  <div id="map-pane">
    <div id="map"></div>
  </div>

  <!-- HUD -->
  <div id="hud">ä½ç½®ã‚’å–å¾—ä¸­â€¦</div>

  <!-- iPhoneç”¨: ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒœã‚¿ãƒ³ -->
  <button id="sensorButton">ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<script>
/* ====== 1. è¨­å®š ====== */
const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw_uhqYjG25qdhdrZ6zCZgjTCKPVypqmTcgKenXBtt4LSBCaoARHYSAYxtMEHijY1rSdA/exec';
const GOOGLE_MAPS_API_KEY = 'ã“ã“ã«ã‚ãªãŸã®APIã‚­ãƒ¼';   // å¿…ãšç½®ãæ›ãˆ

// 10åœ°ç‚¹
const PLACES = [
  { id: 'tas-park',         name: 'TasParkHotel',       lat: 38.10148128126027, lon: 140.0433090680094, radius: 20, image: './Index/Picture/TasParkHotel.png' },
  { id: 'MichinoEkiNagai',  name: 'MichinoEkiNagai',    lat: 38.108970970886325, lon: 140.04382939078403, radius: 20, image: './Index/Picture/MichinoEkiNagai.png' },
  { id: 'MNagaiShougakkou', name: 'MNagaiShougakkou',   lat: 38.107796313044474, lon: 140.04269068239356, radius: 15, image: './Index/Picture/MNagaiShougakkou.png' },
  { id: 'Kozakurakan',      name: 'Kozakurakan',        lat: 38.110963329145335, lon: 140.03632275489852, radius: 15, image: './Index/Picture/Kozakurakan.png' },
  { id: 'Marudaiougiya',    name: 'Marudaiougiya',      lat: 38.11228246118919,  lon: 140.036198935986,   radius: 15, image: './Index/Picture/Marudaiougiya.png' },
  { id: 'Nagaisiyakusho',   name: 'Nagaisiyakusho',     lat: 38.1063333593554,   lon: 140.033892868012,   radius: 15, image: './Index/Picture/Nagaisiyakusho.png' },
  { id: 'NagaiKougyokoukou',name: 'NagaiKougyokoukou',  lat: 38.114426209437404, lon: 140.03013087985815, radius: 15, image: './Index/Picture/NagaiKougyokoukou.png' },
  { id: 'Nagaikoukou',      name: 'Nagaikoukou',        lat: 38.097283861825424, lon: 140.0380452392042,  radius: 15, image: './Index/Picture/Nagaikoukou.png' },
  { id: 'MinamiNagai',      name: 'MinamiNagai',        lat: 38.09769549394771,  lon: 140.03458623775896, radius: 15, image: './Index/Picture/MinamiNagai.png' },
  { id: 'Kurunt',           name: 'Kurunt',             lat: 38.10491876278905,  lon: 140.03466346205656, radius: 15, image: './Index/Picture/Kurunt.png' }
];

const hud = document.getElementById('hud');

/* ====== 2. ãƒ­ã‚°é€ä¿¡ ====== */
function sendLog(payload){
  fetch(LOG_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  }).catch(e => console.warn('log failed', e));
}

/* ====== 3. è·é›¢è¨ˆç®— ====== */
function distanceMeter(lat1, lon1, lat2, lon2) {
  const R = 6378137, toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ====== 4. A-Frameå´ã«ç”»åƒã‚’ç½®ã ====== */
function createPlaceEntities(){
  const scene = document.querySelector('a-scene');
  PLACES.forEach(place => {
    const img = document.createElement('a-image');
    img.setAttribute('id', 'place-' + place.id);
    img.setAttribute('src', place.image);
    img.setAttribute('position', '0 1.5 -3');
    img.setAttribute('width', '5');     // â†2å€ãã‚‰ã„ã«ã—ãŸ
    img.setAttribute('height', '2.4');  // â†ç¸¦ã‚‚2å€
    img.setAttribute('material', 'side: double;');
    img.setAttribute('visible', 'false');
    scene.appendChild(img);
    place._isInside = false;
  });
}

/* ====== 5. GPSã‚¦ã‚©ãƒƒãƒ ====== */
let lastPos = null;
let lastSentAt = 0;
let map, polyline, mapInited = false;

function startGPSWatch(){
  if(!navigator.geolocation){
    hud.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯GPSãŒä½¿ãˆã¾ã›ã‚“';
    return;
  }

  navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      lastPos = {lat, lon, acc};

      hud.textContent = `ğŸ“ ç¾åœ¨ä½ç½®\nlat:${lat.toFixed(6)}\nlon:${lon.toFixed(6)}\nç²¾åº¦:Â±${acc.toFixed(1)}m`;

      // ARã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ¶å¾¡ï¼‹enter/leaveãƒ­ã‚°
      PLACES.forEach(place => {
        const dist = distanceMeter(lat, lon, place.lat, place.lon);
        const ent = document.getElementById('place-' + place.id);
        const isNear = dist <= place.radius;
        if(ent) ent.setAttribute('visible', isNear);
        if(!place._isInside && isNear) sendLog({place_id:place.id, event:'enter', lat, lon});
        if(place._isInside && !isNear) sendLog({place_id:place.id, event:'leave', lat, lon});
        place._isInside = isNear;
      });

      // 5ç§’1å›ã®èµ°è¡Œãƒ­ã‚°
      const now = Date.now();
      if(now - lastSentAt > 5000){
        sendLog({place_id:'current', event:'position', lat, lon});
        lastSentAt = now;
      }

      // ãƒãƒƒãƒ—è¡¨ç¤ºä¸­ãªã‚‰ä½ç½®ã‚‚æ›´æ–°
      if(mapInited){
        const path = polyline.getPath();
        path.push(new google.maps.LatLng(lat, lon));
        map.setCenter({lat, lon});
      }
    },
    err => {
      hud.textContent = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“: ' + err.message;
    },
    { enableHighAccuracy:true, maximumAge:0, timeout:5000 }
  );
}

/* ====== 6. iPhoneã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒœã‚¿ãƒ³ ====== */
const sensorButton = document.getElementById('sensorButton');
sensorButton.addEventListener('click', async () => {
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const state = await DeviceOrientationEvent.requestPermission();
      if (state === 'granted') {
        alert('ã‚»ãƒ³ã‚µãƒ¼ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
        sensorButton.remove();
      } else {
        alert('ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
      }
    } catch (e) {
      alert('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯æ™‚ã®ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  } else {
    sensorButton.remove();
  }
});

/* ====== 7. ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ====== */
const tabAr  = document.getElementById('tab-ar');
const tabMap = document.getElementById('tab-map');
const arPane = document.getElementById('ar-pane');
const mapPane = document.getElementById('map-pane');

tabAr.addEventListener('click', () => {
  tabAr.classList.add('active');
  tabMap.classList.remove('active');
  arPane.style.display = 'block';
  mapPane.style.display = 'none';
});

tabMap.addEventListener('click', () => {
  tabMap.classList.add('active');
  tabAr.classList.remove('active');
  arPane.style.display = 'none';
  mapPane.style.display = 'block';
  // åˆå›ã ã‘ãƒãƒƒãƒ—åˆæœŸåŒ–
  if (!mapInited) initMap();
});

/* ====== 8. Google Maps åˆæœŸåŒ– ====== */
function initMap(){
  if (!window.google || !window.google.maps){
    alert('Google Mapsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆAPIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼‰');
    return;
  }
  map = new google.maps.Map(document.getElementById('map'), {
    center: lastPos ? {lat:lastPos.lat, lon:lastPos.lon} : {lat:38.1013, lng:140.0430},
    zoom: 16,
    mapTypeId: 'roadmap'
  });
  polyline = new google.maps.Polyline({
    map,
    path: [],
    strokeColor: '#ff0000',
    strokeOpacity: 1.0,
    strokeWeight: 3
  });
  mapInited = true;
}

/* ====== 9. èµ·å‹• ====== */
window.addEventListener('load', () => {
  createPlaceEntities();
  startGPSWatch();

  // Google Maps APIã‚’å‹•çš„èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ¼ãŒå…¥ã£ã¦ã„ã‚Œã°ãƒãƒƒãƒ—ã‚¿ãƒ–ã§ä½¿ãˆã‚‹ï¼‰
  if (GOOGLE_MAPS_API_KEY && GOOGLE_MAPS_API_KEY !== 'AIzaSyACib9absBqRW6ErBmjg4_jXcfq-CihVYE') {
    const s = document.createElement('script');
    s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}`;
    document.body.appendChild(s);
  }
});
</script>

</body>
</html>
