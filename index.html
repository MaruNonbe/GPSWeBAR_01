<script>
// --- 追加パッチ: 2秒で自動リトライ & 手動リトライを必ず出す ---
(function(){
  const scene = document.getElementById('scene');
  let videoRunning = false;

  // AR.js 側から「ビデオが来た」合図
  scene.addEventListener('arjs-video-loaded', () => {
    videoRunning = true;
    document.getElementById('retry')?.style.setProperty('display','none','important');
    document.getElementById('status').textContent = 'status: camera running';
  });

  // 2秒待っても来なければリトライUIを必ず表示し、start() を叩く
  setTimeout(async () => {
    if (videoRunning) return;
    const retry = document.getElementById('retry');
    if (retry) retry.style.setProperty('display','flex','important');

    try {
      // もう一度だけプレフライト（権限ダイアログを確実に出す）
      const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
      s.getTracks().forEach(t=>t.stop());
    } catch(e) {
      // ここに落ちるのは権限拒否。UI上の案内に任せる
    }

    // AR.js のソースを明示再起動
    const sys = scene.systems['arjs'];
    try { sys?.arSource?.stop(); } catch(_) {}
    try { await sys?.arSource?.start(); } catch(_) {}
    document.getElementById('status').textContent = 'status: retrying camera…';
  }, 2000);

  // 手動リトライ（ボタンがある場合）
  document.getElementById('retryBtn')?.addEventListener('click', async ()=>{
    const retry = document.getElementById('retry');
    if (retry) retry.style.display = 'none';
    const sys = scene.systems['arjs'];
    try { sys?.arSource?.stop(); } catch(_) {}
    try { await sys?.arSource?.start(); } catch(_) {}
    document.getElementById('status').textContent = 'status: retrying camera…';
  });
})();
</script>
