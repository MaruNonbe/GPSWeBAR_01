<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>èµ°è¡Œãƒ­ã‚°åœ°å›³ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
    #map { height: 100%; width: 100%; }
    #panel {
      position: fixed;
      top: 10px; left: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      z-index: 9999;
    }
  </style>

  <!-- âœ… Google Maps APIã‚­ãƒ¼ã‚’å…¥ã‚Œã¦ãã ã•ã„ -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACib9absBqRW6ErBmjg4_jXcfq-CihVYE"></script>

  <!-- âœ… PapaParseï¼ˆCSVã‚’JSONåŒ–ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

  <div id="panel">ğŸš— GPSãƒ­ã‚°åœ°å›³ãƒ“ãƒ¥ãƒ¼ã‚¢</div>
  <div id="map"></div>

<script>
/* ========= 1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå…¬é–‹CSVã®URL ========= */
// Googleã‚·ãƒ¼ãƒˆ â†’ [ãƒ•ã‚¡ã‚¤ãƒ«] > [å…±æœ‰] > [ãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã«é–²è¦§æ¨©é™ã‚’ä»˜ä¸]
// ãã®å¾ŒURLä¸­ã® "/edit#gid=" ã‚’ "/gviz/tq?tqx=out:csv&gid=" ã«å¤‰æ›´
const CSV_URL = 'https://docs.google.com/spreadsheets/d/1oq1ottoPDNcqE06opb9AhugWJIFvd2JCyn2u9iDqwu4/gviz/tq?tqx=out:csv&gid=0';

/* ========= 2. åˆæœŸè¨­å®š ========= */
let map;
let markers = [];
let pathLine;

/* ========= 3. Google MapåˆæœŸåŒ– ========= */
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 38.107, lng: 140.043 },
    zoom: 14,
    mapTypeId: 'roadmap'
  });

  loadCSVData();
  setInterval(loadCSVData, 5000); // 5ç§’ã”ã¨ã«æ›´æ–°
}

/* ========= 4. CSVèª­ã¿è¾¼ã¿ãƒ»æç”» ========= */
function loadCSVData() {
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    complete: function(results) {
      const rows = results.data.filter(r => r.lat && r.lon);

      if (rows.length === 0) return;

      // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
      markers.forEach(m => m.setMap(null));
      markers = [];

      const pathCoords = [];

      rows.forEach(row => {
        const lat = parseFloat(row.lat);
        const lon = parseFloat(row.lon);
        const event = row.event || '';
        const time = row.timestamp || '';

        pathCoords.push({ lat, lng: lon });

        // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
        const marker = new google.maps.Marker({
          position: { lat, lng: lon },
          map: map,
          title: `${time}\n${event}`
        });
        markers.push(marker);
      });

      // æŠ˜ã‚Œç·šã§çµŒè·¯è¡¨ç¤º
      if (pathLine) pathLine.setMap(null);
      pathLine = new google.maps.Polyline({
        path: pathCoords,
        geodesic: true,
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeWeight: 3,
        map: map
      });

      // æœ€æ–°ä½ç½®ã¸ç§»å‹•
      const latest = pathCoords[pathCoords.length - 1];
      map.panTo(latest);
    }
  });
}

/* ========= 5. èµ·å‹• ========= */
window.onload = initMap;
</script>

</body>
</html>
