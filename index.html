<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS AR / è‡ªå‰ãƒ“ãƒ‡ã‚ªèƒŒæ™¯ + è¿‘è·é›¢ãƒ†ã‚¹ãƒˆãƒ”ãƒ³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    html,body{margin:0;padding:0;height:100%;background:#000;overflow:hidden;touch-action:none}
    #bgVideo{position:fixed;inset:0;width:100vw;height:100svh;object-fit:cover;background:#000;z-index:0}
    a-scene,canvas.a-canvas,.a-loader-title{
      position:fixed!important;inset:0!important;width:100vw!important;height:100svh!important;z-index:1!important;
      max-width:100vw!important;max-height:100svh!important;overflow:hidden!important
    }
    #hud{
      position:fixed;left:12px;top:12px;z-index:9999;background:rgba(0,0,0,.6);color:#fff;
      font-family:monospace;padding:6px 10px;border-radius:8px;line-height:1.4
    }
    #perm{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:99999;
      background:#000;color:#fff;text-align:center;padding:24px;gap:16px;flex-direction:column}
    #perm button{font-size:18px;padding:12px 18px;border-radius:10px;border:0}
  </style>

  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.4.4/aframe-ar.min.js"></script>
</head>
<body>
  <!-- èƒŒæ™¯ã‚«ãƒ¡ãƒ© -->
  <video id="bgVideo" playsinline autoplay muted></video>

  <!-- HUD -->
  <div id="hud">lat: - lon: - Â±- m<br>nearest: - (- m)</div>

  <!-- ã‚«ãƒ¡ãƒ©è¨±å¯UI -->
  <div id="perm">
    <div>ã‚«ãƒ¡ãƒ©ãŒé–‹å§‹ã§ãã¾ã›ã‚“ã€‚<br>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚</div>
    <button id="askCam">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
    <pre id="err" style="white-space:pre-wrap;max-width:90%"></pre>
  </div>

  <!-- ARã‚·ãƒ¼ãƒ³ï¼ˆGPSã®ã¿ï¼‰ -->
  <a-scene
    embedded
    vr-mode-ui="enabled:false"
    renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true"
    arjs="sourceType: webcam; videoTexture:true; facingMode: environment; debugUIEnabled:false; gpsMinDistance:5;"
  >
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

<script>
/* ========= è‡ªå‰ã‚«ãƒ¡ãƒ©èƒŒæ™¯ ========= */
const bgVideo = document.getElementById('bgVideo');
const perm = document.getElementById('perm');
const askCam = document.getElementById('askCam');
const errOut = document.getElementById('err');
async function startBackgroundCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'}}, audio:false });
    bgVideo.srcObject = stream; await bgVideo.play().catch(()=>{});
    perm.style.display='none';
  }catch(e){ perm.style.display='flex'; errOut.textContent=(e.name||'')+' '+(e.message||''); }
}
askCam.addEventListener('click', startBackgroundCamera);
startBackgroundCamera();

/* ========= åœ°ç‚¹å®šç¾© ========= */
const CAT = {
  sightseeing:{ color:'#FF9500' }, // è¦³å…‰
  public:{      color:'#0A84FF' }, // å…¬å…±
  school:{      color:'#34C759' }  // å­¦æ ¡
};
const PLACES = [
  { id:'Marudaiougiya', name:'ä¸¸å¤§æ‰‡å±‹', lat:38.11228246118919,  lon:140.036198935986,   radius:150, cat:'sightseeing' },
  { id:'Kozakurakan',   name:'å°æ¡œé¤¨',   lat:38.110963329145335, lon:140.03632275489852,  radius:150, cat:'sightseeing' },
  { id:'TasPark',       name:'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«', lat:38.10148128126027, lon:140.0433090680094, radius:150, cat:'sightseeing' },
  { id:'MinamiNagai',   name:'å—é•·äº•é§…', lat:38.09769549394771,  lon:140.03458623775896, radius:150, cat:'public' },
  { id:'MichiNoEki',    name:'é“ã®é§… ã‹ã‚ã®ã¿ãªã¨é•·äº•', lat:38.108970970886325, lon:140.04382939078403, radius:150, cat:'public' },
  { id:'CityHall',      name:'é•·äº•å¸‚å½¹æ‰€', lat:38.1063333593554,  lon:140.033892868012,   radius:150, cat:'public' },
  { id:'Kurunt',        name:'ã‚¯ãƒ«ãƒ³ãƒˆ',  lat:38.10491876278905,  lon:140.03466346205656, radius:150, cat:'public' },
  { id:'NagaiTechHS',   name:'é•·äº•å·¥æ¥­é«˜æ ¡', lat:38.114426209437404, lon:140.03013087985815, radius:150, cat:'school' },
  { id:'NagaiHS',       name:'é•·äº•é«˜æ ¡',   lat:38.097283861825424, lon:140.0380452392042,  radius:150, cat:'school' },
];
const hud = document.getElementById('hud');
const toR = d=>d*Math.PI/180;
const distM=(a,b,c,d)=>{const R=6371000,dLat=toR(c-a),dLon=toR(d-b);
  const s=Math.sin(dLat/2)**2+Math.cos(toR(a))*Math.cos(toR(c))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));};
const byId={};

function makePlaceEntity(place){
  const scene=document.querySelector('a-scene');
  const e=document.createElement('a-entity');
  e.setAttribute('id','place-'+place.id);
  e.setAttribute('gps-entity-place',`latitude:${place.lat}; longitude:${place.lon}`);
  e.setAttribute('visible','false');

  const label=document.createElement('a-text');
  label.setAttribute('value',place.name);
  label.setAttribute('align','center');
  label.setAttribute('color','#FFFFFF');
  label.setAttribute('width','8');
  label.setAttribute('position','0 2 0');

  const ball=document.createElement('a-sphere');
  ball.setAttribute('radius','1');                 // å¤§ãã‚
  ball.setAttribute('color', CAT[place.cat].color);
  ball.setAttribute('scale','2 2 2');              // ã•ã‚‰ã«è¦‹ã‚„ã™ã
  ball.setAttribute('animation','property: rotation; to: 0 360 0; loop: true; dur: 6000; easing: linear');

  e.appendChild(label); e.appendChild(ball); scene.appendChild(e);
  byId[place.id]={ ent:e, inside:false, last:Infinity, def:place };
}

function createAll(){ PLACES.forEach(makePlaceEntity); }
createAll();

/* ========= ç¾åœ¨åœ°ã®ç´„8må…ˆã«ãƒ†ã‚¹ãƒˆç”¨ãƒ”ãƒ³ ========= */
let testMade=false;
function makeTestPin(lat,lon){
  const dLat = 8/111320;                  // ç´„8måŒ—æ–¹å‘
  const test = { id:'HereTest', name:'ãƒ†ã‚¹ãƒˆ(8må…ˆ)', lat:lat+dLat, lon:lon, radius:9999, cat:'public' };
  makePlaceEntity(test);
  byId[test.id].ent.setAttribute('visible','true');
}

/* ========= ä½ç½®ç›£è¦– ========= */
function update(lat,lon,acc){
  // HUDæ›´æ–°
  let nearestName='-', nearestDist='-';
  let visibles=[];
  PLACES.forEach(p=>{
    const d=distM(lat,lon,p.lat,p.lon); const st=byId[p.id]; st.last=d;
    if(d<=p.radius) visibles.push(p);
  });
  if(visibles.length){
    visibles.sort((a,b)=>byId[a.id].last - byId[b.id].last);
    nearestName = visibles[0].name;
    nearestDist = byId[visibles[0].id].last.toFixed(1)+' m';
  }
  hud.innerHTML = `lat: ${lat.toFixed(6)}  lon: ${lon.toFixed(6)}  Â±${(acc||0).toFixed(1)} m<br>nearest: ${nearestName} (${nearestDist})`;

  // è¡¨ç¤ºåˆ‡æ›¿ï¼ˆæœ€å¯„ã‚Š1ä»¶ï¼‰
  Object.values(byId).forEach(s=>s.ent.setAttribute('visible','false'));
  if(visibles.length){ byId[visibles[0].id].ent.setAttribute('visible','true'); }

  // åˆå›ã ã‘ãƒ†ã‚¹ãƒˆãƒ”ãƒ³ã‚’ä½œã‚‹
  if(!testMade){ testMade=true; makeTestPin(lat,lon); }
}

if('geolocation' in navigator){
  navigator.geolocation.watchPosition(
    p=>update(p.coords.latitude,p.coords.longitude,p.coords.accuracy),
    e=>console.warn(e),
    { enableHighAccuracy:true, maximumAge:0, timeout:10000 }
  );
}
</script>
</body>
</html>
