<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>GPSãƒ‡ãƒãƒƒã‚°ä»˜ãAR.js</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: monospace; }
      #hud {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 10px;
        border-radius: 8px;
        font-size: 15px;
        z-index: 9999;
        line-height: 1.4em;
      }
      #startBtn {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        font-size: 18px;
        border-radius: 10px;
        border: none;
        background: orange;
        color: white;
        z-index: 9999;
      }
    </style>
  </head>

  <body>
    <!-- HUDè¡¨ç¤º -->
    <div id="hud">
      <div id="latlon">lat: - lon: - Â±-m</div>
      <div id="nearest">nearest: -</div>
      <div id="distance">distance: - m</div>
      <div>10mä»¥å†…ã«è¿‘ã¥ãã¨3Dã¨éŸ³å£°ãŒå‡ºã¾ã™</div>
    </div>

    <button id="startBtn">ğŸ“¡ GPSã‚’é–‹å§‹</button>

    <!-- A-Frame + AR.js -->
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <!-- 3Dãƒ¢ãƒ‡ãƒ«ï¼ˆéè¡¨ç¤ºã§é–‹å§‹ï¼‰ -->
      <a-entity
        id="model"
        gltf-model="model.glb"
        gps-entity-place="latitude:38.108993; longitude:140.043767;"
        scale="1 1 1"
        visible="false"
      ></a-entity>

      <!-- éŸ³å£°ï¼ˆéè¡¨ç¤ºã§é–‹å§‹ï¼‰ -->
      <a-sound id="guide" src="sound.mp3" autoplay="false" position="0 2 0"></a-sound>

      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      const hudLatlon = document.getElementById("latlon");
      const hudDist = document.getElementById("distance");
      const model = document.getElementById("model");
      const sound = document.getElementById("guide");
      const btn = document.getElementById("startBtn");

      const poi = { lat: 38.108993, lon: 140.043767 }; // ç›®çš„åœ°
      const R = 6371000; // åœ°çƒåŠå¾„(m)

      function toRad(deg) { return (deg * Math.PI) / 180; }

      function calcDist(lat1, lon1, lat2, lon2) {
        const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2);
        const Î”Ï† = toRad(lat2 - lat1);
        const Î”Î» = toRad(lon2 - lon1);
        const a =
          Math.sin(Î”Ï† / 2) ** 2 +
          Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      function showErr(err) {
        const msg = {
          1: "PERMISSION_DENIEDï¼ˆæ¨©é™ï¼‰",
          2: "POSITION_UNAVAILABLEï¼ˆæ¸¬ä½ä¸èƒ½ï¼‰",
          3: "TIMEOUTï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰",
        }[err.code] || err.message;
        hudLatlon.textContent = "GPSã‚¨ãƒ©ãƒ¼: " + msg;
      }

      function updateLatLon(pos) {
        const { latitude, longitude, accuracy } = pos.coords;
        hudLatlon.textContent =
          `lat:${latitude.toFixed(6)} lon:${longitude.toFixed(6)} Â±${accuracy.toFixed(1)}m`;
        const dist = calcDist(latitude, longitude, poi.lat, poi.lon);
        hudDist.textContent = `distance: ${dist.toFixed(1)} m`;

        // 10mä»¥å†…ã§å‡ºç¾
        if (dist < 10) {
          model.setAttribute("visible", "true");
          if (!sound.components.sound.isPlaying) sound.components.sound.playSound();
        } else {
          model.setAttribute("visible", "false");
          if (sound.components.sound.isPlaying) sound.components.sound.stopSound();
        }
      }

      function startGeo() {
        if (!("geolocation" in navigator)) {
          hudLatlon.textContent = "GPSæœªå¯¾å¿œï¼ˆnavigator.geolocationãªã—ï¼‰";
          return;
        }
        const opt = { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 };
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            updateLatLon(pos);
            navigator.geolocation.watchPosition(updateLatLon, showErr, opt);
          },
          showErr,
          opt
        );
      }

      // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§é–‹å§‹ï¼ˆiOSå¯¾ç­–ï¼‰
      btn.onclick = () => {
        startGeo();
        btn.style.display = "none";
      };
    </script>
  </body>
</html>
