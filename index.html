<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPSãƒˆãƒªã‚¬ãƒ¼ARï¼‹åœ°å›³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <style>
    :root { --tab-h: 50px; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
      background: #000;
    }
    /* ã‚¿ãƒ– */
    #tabs {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--tab-h);
      background: #000;
      display: flex;
      z-index: 10000;
    }
    #tabs button {
      flex: 1;
      border: none;
      background: #000;
      color: #fff;
      font-size: 16px;
    }
    #tabs button.active { background: #333; }

    /* ARã‚·ãƒ¼ãƒ³ã¯ã‚¿ãƒ–ã®ä¸‹ã§å›ºå®šã€æœ€åˆã¯éè¡¨ç¤º */
    a-scene {
      position: fixed !important;
      top: var(--tab-h);
      left: 0;
      right: 0;
      bottom: 0;
      width: 100% !important;
      height: calc(100vh - var(--tab-h)) !important;
      z-index: 1;
      display: none;   /* â†è¨±å¯ãŒçµ‚ã‚ã‚‹ã¾ã§éš ã™ */
    }

    /* HUD */
    #hud {
      position: fixed;
      top: calc(var(--tab-h) + 8px);
      left: 8px;
      z-index: 10001;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 14px;
      line-height: 1.4;
      padding: 6px 8px;
      border-radius: 4px;
      white-space: pre-line;
      max-width: 90vw;
      display: none;   /* ARè¡¨ç¤ºã«ãªã£ã¦ã‹ã‚‰å‡ºã™ */
    }

    /* ãƒãƒƒãƒ— */
    #map-view {
      position: fixed;
      top: var(--tab-h);
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 5000;
      display: none;
    }
    #map { width: 100%; height: 100%; }

    /* è¨±å¯ãƒœã‚¿ãƒ³ï¼ˆå…¨ç”»é¢ï¼‰ */
    #permissionOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    #permissionOverlay button {
      margin-top: 20px;
      background: #007bff;
      border: none;
      color: #fff;
      padding: 14px 26px;
      font-size: 18px;
      border-radius: 8px;
    }
  </style>
</head>
<body>

  <!-- å…¨ç”»é¢ã®è¨±å¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="permissionOverlay">
    <div>ARè¡¨ç¤ºã®ãŸã‚ã«<br>ã‚«ãƒ¡ãƒ©ã¨ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚</div>
    <button id="startBtn">ARã‚’é–‹å§‹ã™ã‚‹</button>
  </div>

  <!-- ã‚¿ãƒ– -->
  <div id="tabs">
    <button id="tab-ar" class="active">ARè¡¨ç¤º</button>
    <button id="tab-map">èµ°è¡Œãƒãƒƒãƒ—</button>
  </div>

  <!-- HUD -->
  <div id="hud">ä½ç½®ã‚’å–å¾—ä¸­â€¦</div>

  <!-- ARã‚·ãƒ¼ãƒ³ -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="antialias: true; alpha: true"
    id="ar-scene"
  >
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <!-- ãƒãƒƒãƒ—è¡¨ç¤º -->
  <div id="map-view">
    <div id="map"></div>
  </div>

<script>
const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw_uhqYjG25qdhdrZ6zCZgjTCKPVypqmTcgKenXBtt4LSBCaoARHYSAYxtMEHijY1rSdA/exec';

function sendLog(p){
  fetch(LOG_ENDPOINT,{
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(p)
  }).catch(e=>console.warn('log fail',e));
}

const PLACES = [
  { id: 'tas-park',         name: 'TasParkHotel',       lat: 38.10148128126027, lon: 140.0433090680094, radius: 20, image: './Index/Picture/TasParkHotel.png' },
  { id: 'MichinoEkiNagai',  name: 'MichinoEkiNagai',    lat: 38.108970970886325, lon: 140.04382939078403, radius: 20, image: './Index/Picture/MichinoEkiNagai.png' },
  { id: 'MNagaiShougakkou', name: 'MNagaiShougakkou',   lat: 38.107796313044474, lon: 140.04269068239356, radius: 15, image: './Index/Picture/MNagaiShougakkou.png' },
  { id: 'Kozakurakan',      name: 'Kozakurakan',        lat: 38.110963329145335, lon: 140.03632275489852, radius: 15, image: './Index/Picture/Kozakurakan.png' },
  { id: 'Marudaiougiya',    name: 'Marudaiougiya',      lat: 38.11228246118919,  lon: 140.036198935986,   radius: 15, image: './Index/Picture/Marudaiougiya.png' },
  { id: 'Nagaisiyakusho',   name: 'Nagaisiyakusho',     lat: 38.1063333593554,   lon: 140.033892868012,   radius: 15, image: './Index/Picture/Nagaisiyakusho.png' },
  { id: 'NagaiKougyokoukou',name: 'NagaiKougyokoukou',  lat: 38.114426209437404, lon: 140.03013087985815, radius: 15, image: './Index/Picture/NagaiKougyokoukou.png' },
  { id: 'Nagaikoukou',      name: 'Nagaikoukou',        lat: 38.097283861825424, lon: 140.0380452392042,  radius: 15, image: './Index/Picture/Nagaikoukou.png' },
  { id: 'MinamiNagai',      name: 'MinamiNagai',        lat: 38.09769549394771,  lon: 140.03458623775896, radius: 15, image: './Index/Picture/MinamiNagai.png' },
  { id: 'Kurunt',           name: 'Kurunt',             lat: 38.10491876278905,  lon: 140.03466346205656, radius: 15, image: './Index/Picture/Kurunt.png' }
];

const hud = document.getElementById('hud');

function distanceMeter(lat1, lon1, lat2, lon2){
  const R=6378137, toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1);
  const dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function createPlaceEntities(){
  const scene = document.querySelector('a-scene');
  PLACES.forEach(p=>{
    const img=document.createElement('a-image');
    img.setAttribute('id','place-'+p.id);
    img.setAttribute('src',p.image);
    img.setAttribute('position','0 1.5 -3');
    img.setAttribute('width','5');
    img.setAttribute('height','2.4');
    img.setAttribute('material','side: double;');
    img.setAttribute('visible','false');
    scene.appendChild(img);
    p._isInside=false;
  });
}

let lastPos=null;
let lastSentAt=0;
let map, mapPolyline, mapPath=[];

function startGPSWatch(){
  navigator.geolocation.watchPosition(pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;
    const acc=pos.coords.accuracy;
    lastPos={lat,lon,acc};
    hud.textContent=`ğŸ“ ç¾åœ¨ä½ç½®\nlat:${lat.toFixed(6)}\nlon:${lon.toFixed(6)}\nç²¾åº¦:Â±${acc.toFixed(1)}m`;

    PLACES.forEach(p=>{
      const dist=distanceMeter(lat,lon,p.lat,p.lon);
      const ent=document.getElementById('place-'+p.id);
      const near=dist<=p.radius;
      if(ent) ent.setAttribute('visible',near);
      if(!p._isInside && near) sendLog({place_id:p.id,event:'enter',lat,lon});
      if(p._isInside && !near) sendLog({place_id:p.id,event:'leave',lat,lon});
      p._isInside=near;
    });

    if(map){
      const posLatLng={lat, lng:lon};
      mapPath.push(posLatLng);
      mapPolyline.setPath(mapPath);
      map.setCenter(posLatLng);
    }
  },err=>{
    hud.textContent='ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆ'+err.message+'ï¼‰';
  },{enableHighAccuracy:true, maximumAge:0, timeout:5000});

  setInterval(()=>{
    if(!lastPos) return;
    const now=Date.now();
    if(now-lastSentAt<5000) return;
    sendLog({place_id:'current',event:'position',lat:lastPos.lat,lon:lastPos.lon});
    lastSentAt=now;
  },5000);
}

function initMap(){
  const center = lastPos ? {lat:lastPos.lat,lng:lastPos.lon} : {lat:38.1014,lng:140.0433};
  map = new google.maps.Map(document.getElementById('map'),{
    center, zoom:16
  });
  mapPolyline = new google.maps.Polyline({
    map,
    path:[],
    strokeColor:'#ff0000',
    strokeWeight:3
  });
}

/* ã‚¿ãƒ– */
const tabAr=document.getElementById('tab-ar');
const tabMap=document.getElementById('tab-map');
const sceneEl=document.getElementById('ar-scene');
const mapView=document.getElementById('map-view');

tabAr.addEventListener('click',()=>{
  tabAr.classList.add('active');
  tabMap.classList.remove('active');
  sceneEl.style.display='block';
  mapView.style.display='none';
});
tabMap.addEventListener('click',()=>{
  tabMap.classList.add('active');
  tabAr.classList.remove('active');
  sceneEl.style.display='none';
  mapView.style.display='block';
  if(!map) initMap();
});

/* è¨±å¯ãƒœã‚¿ãƒ³ã®å‡¦ç† */
document.getElementById('startBtn').addEventListener('click', async ()=>{
  // iOS ã®å ´åˆã ã‘å‘ãã®è¨±å¯ã‚’å–ã‚‹
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const state = await DeviceOrientationEvent.requestPermission();
      console.log('orientation permission:', state);
    } catch (e) {
      console.warn('orientation err', e);
    }
  }

  // âœ… Geolocationã‚‚ã“ã®ã‚¯ãƒªãƒƒã‚¯å†…ã§é–‹å§‹ã™ã‚‹
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(()=>{}, ()=>{}, {enableHighAccuracy:true});
  }

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’æ¶ˆã—ã¦ARã‚¹ã‚¿ãƒ¼ãƒˆ
  document.getElementById('permissionOverlay').style.display='none';
  sceneEl.style.display='block';
  hud.style.display='block';
  createPlaceEntities();
  startGPSWatch(); // â† ã“ã“ã«ç§»å‹•
});

/* Android/PCã§æœ€åˆã‹ã‚‰å‹•ã‹ã™å ´åˆã¯ã“ã“ã§è‡ªå‹•é–‹å§‹ã‚‚ã§ãã‚‹ãŒã€ä»Šå›ã¯iPhoneå„ªå…ˆã§æ‰‹å‹•é–‹å§‹ */
</script>

<!-- Google Maps API (ã‚ãªãŸã®ã‚­ãƒ¼ã«å…¥ã‚Œæ›¿ãˆ) -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACib9absBqRW6ErBmjg4_jXcfq-CihVYE"></script>
</body>
</html>
