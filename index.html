<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPSãƒˆãƒªã‚¬ãƒ¼ARï¼ˆç¾åœ¨åœ°ã®ã¿è¡¨ç¤ºï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <!-- ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ï¼ˆä»»æ„ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <style>
    #hud {
      position: fixed;
      top: 8px;
      left: 8px;
      z-index: 9999;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 14px;
      line-height: 1.5;
      padding: 8px 10px;
      border-radius: 6px;
      white-space: pre-line;
      max-width: 90vw;
    }
    body { margin:0; overflow:hidden; }
  </style>
</head>
<body>

  <div id="hud">ä½ç½®ã‚’å–å¾—ä¸­...</div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="antialias: true; alpha: true"
  >
    <a-camera gps-camera rotation-reader></a-camera>
    <a-box position="0 0 -2" depth="0.2" height="0.2" width="0.2" color="#00FFAA"></a-box>
  </a-scene>

<script>
const hud = document.getElementById('hud');

// è·é›¢è¨ˆç®—é–¢æ•°ï¼ˆå¾Œã§æ‹¡å¼µç”¨ã«æ®‹ã—ã¦ãŠãï¼‰
function distanceMeter(lat1, lon1, lat2, lon2) {
  const R = 6378137;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// iOSã‚»ãƒ³ã‚µãƒ¼è¨±å¯
async function requestIOSPermissions() {
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const response = await DeviceOrientationEvent.requestPermission();
      if (response !== 'granted') {
        alert('ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
      }
    } catch (e) {
      console.error(e);
    }
  }
}

// GPSç›£è¦–ï¼ˆç¾åœ¨åœ°ã®ã¿ï¼‰
function startGPSWatch() {
  if (!navigator.geolocation) {
    hud.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯GPSãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
    return;
  }

  console.log('GPSã‚¦ã‚©ãƒƒãƒé–‹å§‹');

  navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      hud.textContent =
        `ğŸ“ ç¾åœ¨ã®GPS\n` +
        `lat: ${lat.toFixed(6)}\n` +
        `lon: ${lon.toFixed(6)}\n` +
        `ç²¾åº¦: Â±${pos.coords.accuracy.toFixed(1)}m`;

      // ã‚«ãƒ¡ãƒ©ä½ç½®æ›´æ–°ï¼ˆAR.jså´ï¼‰
      const cam = document.querySelector('[gps-camera]');
      if (cam && cam.components["gps-camera"]) {
        cam.setAttribute('gps-camera', `simulateLatitude: ${lat}; simulateLongitude: ${lon};`);
      }
    },
    (err) => {
      hud.textContent = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆ' + err.message + 'ï¼‰';
      console.warn('GPSã‚¨ãƒ©ãƒ¼:', err);
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );
}

// åˆæœŸåŒ–
window.addEventListener('load', async () => {
  await requestIOSPermissions();
  startGPSWatch();
});
</script>
</body>
</html>
