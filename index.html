<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>GPS-AR è¨ºæ–­èµ·å‹•</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font:14px/1.5 ui-monospace,monospace}
  #panel{position:fixed;inset:0;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;padding:16px}
  button{padding:10px 14px;border:0;border-radius:10px}
  .ok{color:#0f0}.ng{color:#f66}
  #log{max-width:900px;width:92%;white-space:pre-wrap;background:#111;padding:10px;border-radius:8px}
  video{display:none}
</style>
</head>
<body>

<div id="panel">
  <div><b>è¨ºæ–­ãƒ‘ãƒãƒ«</b>ï¼ˆé»’ç”»é¢ã«ãªã‚‹åŸå› ã‚’ç‰¹å®šã—ã¾ã™ï¼‰</div>
  <div id="camState">ğŸ“· ã‚«ãƒ¡ãƒ©: æœªå®Ÿè¡Œ</div>
  <div id="geoState">ğŸ“ ä½ç½®æƒ…å ±: æœªå®Ÿè¡Œ</div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
    <button id="btnCam">ğŸ“· ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
    <button id="btnGeo">ğŸ“ ä½ç½®æƒ…å ±é–‹å§‹</button>
    <button id="btnStart" disabled>â–¶ ARã‚’é–‹å§‹</button>
  </div>
  <div id="log"></div>
</div>

<video id="probe" playsinline muted></video>

<!-- A-Frame / AR.jsï¼ˆå¾Œã§å‹•çš„ãƒ­ãƒ¼ãƒ‰ï¼‰ -->
<script>
const $ = id => document.getElementById(id);
const camState = $('camState'), geoState = $('geoState'), log = $('log');
let camOK=false, geoOK=false;

function append(msg){ log.textContent += msg + '\n'; }

// æ¨©é™çŠ¶æ…‹ã®äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼ˆå¯¾å¿œã—ã¦ã„ã‚Œã°ï¼‰
(async () => {
  try{
    if (navigator.permissions?.query){
      const c = await navigator.permissions.query({name:'camera'});
      append('camera permission: ' + c.state);
      const g = await navigator.permissions.query({name:'geolocation'});
      append('geolocation permission: ' + g.state);
    }
  }catch(_){}
})();

$('btnCam').onclick = async () => {
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:{ideal:'environment'}}, audio:false });
    $('probe').srcObject = stream;
    await $('probe').play().catch(()=>{});
    camOK = true;
    camState.innerHTML = 'ğŸ“· ã‚«ãƒ¡ãƒ©: <span class="ok">OKï¼ˆå–å¾—ã§ãã¾ã—ãŸï¼‰</span>';
    append('camera: success');
    // ã™ãåœæ­¢
    stream.getTracks().forEach(t=>t.stop());
    checkReady();
  }catch(e){
    camOK = false;
    camState.innerHTML = 'ğŸ“· ã‚«ãƒ¡ãƒ©: <span class="ng">NG</span>';
    append('camera ERROR: ' + (e.name||'') + ' ' + (e.message||''));
    append('å¯¾å‡¦: Safariã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®ã€Œãã‚ã€â†’Webã‚µã‚¤ãƒˆã®è¨­å®šâ†’ã‚«ãƒ¡ãƒ©=è¨±å¯ / è¨­å®š>Safari>ã‚«ãƒ¡ãƒ©=è¨±å¯ / è¨­å®š>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£>ä½ç½®æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹>Safari=ã“ã®Appã®ä½¿ç”¨ä¸­');
  }
};

let geoWatchId = null;
$('btnGeo').onclick = () => {
  if (!('geolocation' in navigator)) { append('geolocation not supported'); return; }
  geoWatchId = navigator.geolocation.watchPosition(
    pos => {
      const {latitude, longitude, accuracy} = pos.coords;
      geoOK = true;
      geoState.innerHTML = `ğŸ“ ä½ç½®æƒ…å ±: <span class="ok">OK</span> lat:${latitude.toFixed(6)} lon:${longitude.toFixed(6)} Â±${accuracy.toFixed(1)}m`;
      checkReady();
    },
    err => {
      geoOK = false;
      geoState.innerHTML = 'ğŸ“ ä½ç½®æƒ…å ±: <span class="ng">NG</span>';
      append('geolocation ERROR: ' + err.code + ' ' + err.message);
      append('å¯¾å‡¦: è¨­å®š>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£>ä½ç½®æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹=ã‚ªãƒ³ â†’ Safari=ã“ã®Appã®ä½¿ç”¨ä¸­ / ã‚µã‚¤ãƒˆå€‹åˆ¥ã®ä½ç½®è¨±å¯ã‚’ã€Œè¨±å¯ã€ã«');
    },
    {enableHighAccuracy:true, maximumAge:0, timeout:10000}
  );
};

function checkReady(){
  $('btnStart').disabled = !(camOK && geoOK);
}

$('btnStart').onclick = async () => {
  // è¨ºæ–­ãƒ‘ãƒãƒ«ã‚’æ¶ˆã—ã¦ARé–‹å§‹
  if (geoWatchId!==null) navigator.geolocation.clearWatch(geoWatchId);
  $('panel').remove();

  // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­è¾¼
  await loadScript('https://aframe.io/releases/1.4.1/aframe.min.js');
  await loadScript('https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js');

  // ARã‚·ãƒ¼ãƒ³ã‚’DOMã«è¿½åŠ 
  const scene = document.createElement('a-scene');
  scene.setAttribute('embedded','');
  scene.setAttribute('vr-mode-ui','enabled: false');
  scene.setAttribute('renderer','colorManagement: true; physicallyCorrectLights: true');
  scene.setAttribute('arjs','sourceType: webcam; gpsMinDistance: 1; debugUIEnabled: false;');
  scene.innerHTML = `
    <a-camera gps-camera rotation-reader></a-camera>
    <a-entity light="type:ambient; intensity:0.9"></a-entity>
    <a-entity gps-entity-place="latitude:38.101327; longitude:140.043027">
      <a-sphere radius="0.6" color="#00bcd4"></a-sphere>
      <a-ring position="0 0 0" rotation="-90 0 0" radius-inner="0.7" radius-outer="0.9" color="#00bcd4"></a-ring>
    </a-entity>
  `;
  document.body.appendChild(scene);

  // æˆå¦ãƒ­ã‚°
  scene.addEventListener('camera-init',  () => console.log('camera-init'));
  scene.addEventListener('camera-error', e => console.warn('camera-error', e));
};

// å‹•çš„ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ­ãƒ¼ãƒ€
function loadScript(src){
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src=src; s.onload=res; s.onerror=()=>rej(new Error('load fail '+src));
    document.head.appendChild(s);
  });
}
</script>
</body>
</html>
