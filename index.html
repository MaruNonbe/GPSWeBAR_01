<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS„Éà„É™„Ç¨„ÉºARÔºàËµ∞Ë°å„É≠„Ç∞ÈÄÅ‰ø°Ôºâ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <!-- „Éá„Éê„ÉÉ„Ç∞Ôºà‰ªªÊÑèÔºâ -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <style>
    #hud {
      position: fixed;
      top: 8px;
      left: 8px;
      z-index: 9999;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 12px;
      line-height: 1.4;
      padding: 6px 8px;
      border-radius: 4px;
      max-width: 90vw;
      white-space: pre-line;
    }
    body { margin:0; overflow:hidden; }
  </style>
</head>
<body>

  <div id="hud">‰ΩçÁΩÆ„ÇíÂèñÂæó‰∏≠‚Ä¶</div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="antialias: true; alpha: true"
  >
    <a-camera gps-camera rotation-reader></a-camera>
    <a-box position="0 0 -2" depth="0.2" height="0.2" width="0.2" color="#00FFAA"></a-box>
  </a-scene>

<script>
/* ========= 1. GAS„ÅÆURL ========= */
const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw_uhqYjG25qdhdrZ6zCZgjTCKPVypqmTcgKenXBtt4LSBCaoARHYSAYxtMEHijY1rSdA/exec';

function sendLog(payload) {
  fetch(LOG_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).catch(err => console.warn('„É≠„Ç∞ÈÄÅ‰ø°Â§±Êïó:', err));
}

/* ========= 2. ÁôªÈå≤Âú∞ÁÇπ ========= */
const PLACES = [
  { id: 'tas-park',         name: 'TasParkHotel',       lat: 38.10148128126027, lon: 140.0433090680094, radius: 20, image: './Index/Picture/TasParkHotel.png' },
  { id: 'MichinoEkiNagai',  name: 'MichinoEkiNagai',    lat: 38.108970970886325, lon: 140.04382939078403, radius: 20, image: './Index/Picture/MichinoEkiNagai.png' },
  { id: 'MNagaiShougakkou', name: 'MNagaiShougakkou',   lat: 38.107796313044474, lon: 140.04269068239356, radius: 15, image: './Index/Picture/MNagaiShougakkou.png' },
  { id: 'Kozakurakan',      name: 'Kozakurakan',        lat: 38.110963329145335, lon: 140.03632275489852, radius: 15, image: './Index/Picture/Kozakurakan.png' },
  { id: 'Marudaiougiya',    name: 'Marudaiougiya',      lat: 38.11228246118919,  lon: 140.036198935986,   radius: 15, image: './Index/Picture/Marudaiougiya.png' },
  { id: 'Nagaisiyakusho',   name: 'Nagaisiyakusho',     lat: 38.1063333593554,   lon: 140.033892868012,   radius: 15, image: './Index/Picture/Nagaisiyakusho.png' },
  { id: 'NagaiKougyokoukou',name: 'NagaiKougyokoukou',  lat: 38.114426209437404, lon: 140.03013087985815, radius: 15, image: './Index/Picture/NagaiKougyokoukou.png' },
  { id: 'Nagaikoukou',      name: 'Nagaikoukou',        lat: 38.097283861825424, lon: 140.0380452392042,  radius: 15, image: './Index/Picture/Nagaikoukou.png' },
  { id: 'MinamiNagai',      name: 'MinamiNagai',        lat: 38.09769549394771,  lon: 140.03458623775896, radius: 15, image: './Index/Picture/MinamiNagai.png' },
  { id: 'Kurunt',           name: 'Kurunt',             lat: 38.10491876278905,  lon: 140.03466346205656, radius: 15, image: './Index/Picture/Kurunt.png' }
];

const hud = document.getElementById('hud');
let lastLat = null;  // Áõ¥Ëøë‰ΩçÁΩÆ„Çí‰øùÊåÅÔºàÂøÖË¶Å„Å™„Çâ‰Ωø„ÅÜÔºâ
let lastLon = null;

/* ========= 3. Ë∑ùÈõ¢Ë®àÁÆó ========= */
function distanceMeter(lat1, lon1, lat2, lon2) {
  const R = 6378137;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* ========= 4. iOSË®±ÂèØ ========= */
async function requestIOSPermissions() {
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const response = await DeviceOrientationEvent.requestPermission();
      if (response !== 'granted') {
        alert('„Éá„Éê„Ç§„Çπ„ÅÆÂêë„Åç„Çª„É≥„Çµ„Éº„ÅÆË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
      }
    } catch (e) { console.error(e); }
  }
}

/* ========= 5. A-Frame„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£ÁîüÊàê ========= */
function createPlaceEntities() {
  const scene = document.querySelector('a-scene');
  PLACES.forEach(place => {
    const img = document.createElement('a-image');
    img.setAttribute('id', 'place-' + place.id);
    img.setAttribute('src', place.image);
    img.setAttribute('position', '0 1.5 -3');
    img.setAttribute('width', '2.5');
    img.setAttribute('height', '1.2');
    img.setAttribute('material', 'side: double;');
    img.setAttribute('visible', 'false');
    scene.appendChild(img);

    // ÂÖ•ÈÄÄÂ†¥„Éï„É©„Ç∞„ÇíÊåÅ„Åü„Åõ„Çã
    place._isInside = false;
  });
}

/* ========= 6. GPS„Ç¶„Ç©„ÉÉ„ÉÅ ========= */
function startGPSWatch() {
  if (!navigator.geolocation) {
    hud.textContent = '„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„Åß„ÅØGPS„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì';
    return;
  }

  navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const accuracy = pos.coords.accuracy;

      lastLat = lat;
      lastLon = lon;

      // ‚òÖ‚òÖ „Åì„Åì„Åß„Äå‰ΩçÁΩÆÊõ¥Êñ∞„Åî„Å®„Å´ÂøÖ„ÅöË®òÈå≤„Äç„Åô„Çã ‚òÖ‚òÖ
      sendLog({
        place_id: 'current',
        event: 'position',
        lat: lat,
        lon: lon
      });

      // HUD„ÅØ„Ç∑„É≥„Éó„É´„Å´ÁèæÂú®Âú∞„Å†„Åë
      let hudText =
        `üìç ÁèæÂú®„ÅÆGPS\n` +
        `lat: ${lat.toFixed(6)}\n` +
        `lon: ${lon.toFixed(6)}\n` +
        `Á≤æÂ∫¶: ¬±${accuracy.toFixed(1)}m\n\n`;

      // ÂêÑÂú∞ÁÇπ„ÅÆÂÖ•ÈÄÄÂ†¥„ÇÇ‰ªä„Åæ„ÅßÈÄö„ÇäÂà§ÂÆö
      PLACES.forEach(place => {
        const dist = distanceMeter(lat, lon, place.lat, place.lon);
        const entity = document.getElementById('place-' + place.id);
        const isNear = dist <= place.radius;

        if (entity) {
          entity.setAttribute('visible', isNear);
        }

        // ÂÖ•„Å£„ÅüÁû¨Èñì
        if (!place._isInside && isNear) {
          sendLog({ place_id: place.id, event: 'enter', lat, lon });
        }
        // Âá∫„ÅüÁû¨Èñì
        if (place._isInside && !isNear) {
          sendLog({ place_id: place.id, event: 'leave', lat, lon });
        }
        place._isInside = isNear;

        // HUD„Å´„ÇÇÂá∫„Åô„Å™„Çâ„Åì„Åì„ÅßËøΩÂä†
        hudText += `Âú∞ÁÇπ: ${place.name} / Ë∑ùÈõ¢: ${dist.toFixed(1)}m (ÂçäÂæÑ${place.radius}m)\n`;
      });

      hud.textContent = hudText;
    },
    (err) => {
      hud.textContent = '‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„ÇìÔºà' + err.message + 'Ôºâ';
      console.warn('GPSÂèñÂæó„Ç®„É©„Éº:', err);
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );
}

/* ========= 7. ÂàùÊúüÂåñ ========= */
window.addEventListener('load', async () => {
  await requestIOSPermissions();
  createPlaceEntities();
  startGPSWatch();
});
</script>
</body>
</html>
