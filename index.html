<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS AR - æ¨©é™å…ˆå–ã‚Šãƒ–ãƒ¼ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    html, body { margin:0; height:100%; background:#000; }
    #ui { position:fixed; inset:0; display:flex; flex-direction:column; gap:12px;
          align-items:center; justify-content:center; color:#fff; z-index:99999; }
    #log { white-space:pre-wrap; text-align:left; max-width:90%; opacity:.9; }
    button { font-size:18px; padding:12px 18px; border-radius:10px; border:0; }
    #hud { position:fixed; top:10px; left:10px; z-index:9999; color:#fff;
           background:rgba(0,0,0,.5); padding:6px 10px; border-radius:6px;
           font-family:monospace; font-size:14px; display:none; }
  </style>
  <!-- A-Frame / AR.jsï¼ˆã‚ã¨ã§å‹•çš„ã«ä½¿ã†ã®ã§å…ˆã«èª­ã¿è¾¼ã‚“ã§OKï¼‰-->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
</head>
<body>
  <div id="hud">Loading...</div>

  <!-- èµ·å‹•UI -->
  <div id="ui">
    <div>èƒŒæ™¯ãŒçœŸã£ç™½ï¼çœŸã£é»’ã®å ´åˆã¯ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</div>
    <button id="startBtn">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
    <pre id="log"></pre>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const log = (m)=>($('#log').textContent = String(m || ''));

    $('#startBtn').addEventListener('click', async () => {
      try {
        // 1) ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œèµ·å› ã§ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’å–å¾—ï¼ˆç’°å¢ƒã‚«ãƒ¡ãƒ©å¸Œæœ›ï¼‰
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } }, audio: false
        });
        // ã™ãè§£æ”¾ï¼ˆAR.jsãŒå–ã‚Šç›´ã—ã¾ã™ï¼‰
        stream.getTracks().forEach(t=>t.stop());

        // 2) UIã‚’éš ã™
        $('#ui').style.display = 'none';
        $('#hud').style.display = 'block';

        // 3) A-Frameã‚·ãƒ¼ãƒ³ã‚’å‹•çš„ã«ä½œæˆï¼ˆè¨±å¯å–å¾—å¾Œã«åˆæœŸåŒ–ï¼‰
        const scene = document.createElement('a-scene');
        scene.setAttribute('vr-mode-ui', 'enabled: false');
        scene.setAttribute('embedded', '');
        scene.setAttribute('renderer', 'colorManagement: true; physicallyCorrectLights: true');
        scene.setAttribute('arjs', 'sourceType: webcam; gpsMinDistance: 5; debugUIEnabled: false;');

        const cam = document.createElement('a-camera');
        cam.setAttribute('gps-camera', '');
        cam.setAttribute('rotation-reader', '');
        scene.appendChild(cam);

        // â˜…ãƒ†ã‚¹ãƒˆç”¨ï¼šä½•ã‹1å€‹ã ã‘ï¼ˆè¿‘å ´ã§ã‚‚é ç›®ã§ã‚‚OKï¼‰
        const test = document.createElement('a-sphere');
        test.setAttribute('gps-entity-place', 'latitude: 38.108993; longitude: 140.043767;'); // é“ã®é§…
        test.setAttribute('radius', '1');
        test.setAttribute('color', '#ff9900');
        scene.appendChild(test);

        document.body.appendChild(scene);

        // 4) ä½ç½®HUD
        if ('geolocation' in navigator) {
          navigator.geolocation.watchPosition(pos => {
            $('#hud').textContent =
              `lat: ${pos.coords.latitude.toFixed(6)}  lon: ${pos.coords.longitude.toFixed(6)}  Â±${pos.coords.accuracy.toFixed(1)}m`;
          }, err => {
            $('#hud').textContent = 'ä½ç½®å–å¾—ã‚¨ãƒ©ãƒ¼: ' + err.message;
          }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
        }

      } catch(e) {
        log(`âŒ getUserMediaå¤±æ•—\nname: ${e.name}\nmessage: ${e.message}\n\nSafariã®ã€Œãƒšãƒ¼ã‚¸è¨­å®šã€â†’ ã‚«ãƒ¡ãƒ©: è¨±å¯ ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nè¨­å®š > Safari > ã‚«ãƒ¡ãƒ© ã‚‚ã€Œè¨±å¯ã€ã«ã—ã¦ãã ã•ã„ã€‚`);
      }
    });
  </script>
</body>
</html>
