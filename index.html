<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS-AR (3D + éŸ³å£° + è·é›¢ã§å‡ºç¾)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden}
    #hud{position:fixed;top:10px;left:10px;right:10px;display:flex;flex-direction:column;gap:6px;z-index:9999;font:14px/1.4 ui-monospace,monospace;color:#fff}
    .tag{display:inline-block;background:rgba(0,0,0,.55);padding:6px 10px;border-radius:8px;width:max-content;max-width:100%}
    #audioGate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.9);z-index:10000}
    #audioGate button{font-size:18px;padding:12px 18px;border:0;border-radius:12px}
  </style>

  <!-- A-Frame / AR.jsï¼ˆGPSï¼‰ -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
</head>
<body>

  <!-- HUD -->
  <div id="hud">
    <div id="latlon"   class="tag">lat: -  lon: -  Â±- m</div>
    <div id="nearest"  class="tag">nearest: -</div>
    <div id="distTag"  class="tag">distance: - m</div>
    <div id="hint"     class="tag">10 mä»¥å†…ã«è¿‘ã¥ãã¨3Dã¨éŸ³å£°ãŒå‡ºã¾ã™</div>
  </div>

  <!-- iOSã®è‡ªå‹•å†ç”Ÿå¯¾ç­–ï¼ˆæœ€åˆã«ã‚¿ãƒƒãƒ—ã—ã¦AudioContextã‚’è§£æ”¾ï¼‰ -->
  <div id="audioGate">
    <button id="audioBtn">ğŸ”Š éŸ³å£°ã‚’æœ‰åŠ¹ã«ã—ã¦ARé–‹å§‹</button>
  </div>

  <!-- A-Frame Scene -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true; physicallyCorrectLights: true"
    arjs="sourceType: webcam; gpsMinDistance: 1; debugUIEnabled: false;"
  >
    <!-- ã‚«ãƒ¡ãƒ©ï¼ˆGPSã§ä½ç½®ãƒ»ãƒ‡ãƒã‚¤ã‚¹æ–¹ä½ã§å‘ãï¼‰ -->
    <a-camera gps-camera rotation-reader></a-camera>

    <!-- ç’°å¢ƒå…‰ï¼†ã‚„ã‚„å¼·ã‚ã®å¹³è¡Œå…‰ï¼ˆãƒ¢ãƒ‡ãƒ«ã‚’è¦‹ã‚„ã™ãï¼‰ -->
    <a-entity light="type:ambient; intensity:0.9"></a-entity>
    <a-entity light="type:directional; intensity:0.6" position="1 2 1"></a-entity>

    <!-- â–¼ POIï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ã€‚JSã§åº§æ¨™/å¯è¦–/éŸ³å£°åˆ¶å¾¡ã—ã¾ã™ -->
    <a-entity id="poi"
              visible="false"
              look-at="[gps-camera]">
//      <!-- 3Dãƒ¢ãƒ‡ãƒ«ï¼ˆå·®ã—æ›¿ãˆOKï¼‰ -->
//      <a-entity id="model"
//                gltf-model="model.glb"
//                scale="1 1 1"
//                position="0 0 0"
//                crossorigin="anonymous">
//      </a-entity>
//
//      <!-- éŸ³å£°ã‚¬ã‚¤ãƒ‰ï¼ˆå·®ã—æ›¿ãˆOKï¼‰ -->
//      <a-sound id="voice"
//               src="sound.mp3"
//               autoplay="false"
//               loop="false"
//               position="0 2 0">
//      </a-sound>
    </a-entity>

  </a-scene>

<script>
/* ========= è¨­å®š ========= */
const POI = {
  name: 'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«',
  lat:  38.101327,
  lon: 140.043027
};
const SHOW_DIST = 10;   // ä½•ãƒ¡ãƒ¼ãƒˆãƒ«ä»¥å†…ã§è¡¨ç¤ºï¼†éŸ³å£°å†ç”Ÿã™ã‚‹ã‹
/* ======================= */

const hudLatlon = document.getElementById('latlon');
const hudNearest= document.getElementById('nearest');
const distTag   = document.getElementById('distTag');

const scene = document.querySelector('a-scene');
const camEl = document.querySelector('[gps-camera]');
const poiEl = document.getElementById('poi');
const voice = document.getElementById('voice');

/* Haversineè·é›¢(m) */
function dist(lat1, lon1, lat2, lon2){
  const R=6371000; const toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* iOSã®éŸ³å£°å†ç”Ÿã‚²ãƒ¼ãƒˆï¼ˆæœ€åˆã®ã‚¿ãƒƒãƒ—ã§AudioContextã‚’é–‹ãï¼‰ */
document.getElementById('audioBtn').addEventListener('click', async () => {
  try{
    const ctx = AFRAME.utils.audioContext || new (window.AudioContext||window.webkitAudioContext)();
    if (ctx.state === 'suspended') await ctx.resume();
  }catch(_){}
  document.getElementById('audioGate').style.display='none';
});

/* POIã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«GPSåº§æ¨™ã‚’ã‚»ãƒƒãƒˆ */
poiEl.setAttribute('gps-entity-place', `latitude: ${POI.lat}; longitude: ${POI.lon}`);

/* GPSæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã§HUDãƒ»è·é›¢ãƒ»å¯è¦–ï¼†éŸ³å£°ã‚’åˆ¶å¾¡ */
let wasVisible = false;
let wasPlayed  = false;

camEl.addEventListener('gps-camera-update-position', (e) => {
  const {position, accuracy} = e.detail; // {latitude, longitude}, accuracy
  const lat = position.latitude;
  const lon = position.longitude;

  // HUDæ›´æ–°
  hudLatlon.textContent = `lat:${lat.toFixed(6)}  lon:${lon.toFixed(6)}  Â±${(accuracy||0).toFixed(1)} m`;
  hudNearest.textContent = `nearest: ${POI.name}`;

  // POIã¾ã§ã®è·é›¢
  const d = dist(lat, lon, POI.lat, POI.lon);
  distTag.textContent = `distance: ${d.toFixed(1)} m`;

  // è·é›¢ã§å‡ºç¾/éè¡¨ç¤º
  const inside = d <= SHOW_DIST;
  poiEl.setAttribute('visible', inside);

  // éŸ³å£°ï¼šå…¥ã£ãŸç¬é–“ã«ä¸€å›ã ã‘å†ç”Ÿã€å‡ºãŸã‚‰åœæ­¢
  if (inside && !wasPlayed) {
    voice.components.sound.stopSound(); // å¿µã®ãŸã‚åœæ­¢â†’
    voice.components.sound.playSound(); // å†ç”Ÿ
    wasPlayed = true;
  }
  if (!inside && wasVisible) {
    voice.components.sound.stopSound();
    wasPlayed = false;
  }

  wasVisible = inside;
});
</script>
</body>
</html>
