<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPSãƒˆãƒªã‚¬ãƒ¼ARï¼ˆã‚«ãƒ†ã‚´ãƒªè‰²åˆ†ã‘ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.jsï¼ˆåˆå‰ä¸­ã«å‹•ã„ã¦ã„ãŸçµ„ã¿åˆã‚ã›ï¼‰ -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <!-- erudaï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ã€‚ä¸è¦ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆOKï¼‰ -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script> -->

  <style>
    body { margin:0; overflow:hidden; }

    #hud {
      position: fixed;
      top: 8px;
      left: 8px;
      z-index: 9999;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 12px;
      line-height: 1.4;
      padding: 6px 8px;
      border-radius: 4px;
      max-width: 90vw;
      white-space: pre-line;
    }

    #sensorButton {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #007bff;
      color: #fff;
      padding: 14px 26px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      z-index: 10000;
    }
  </style>
</head>
<body>

  <!-- å·¦ä¸Šã®GPSè¡¨ç¤º -->
  <div id="hud">ä½ç½®ã‚’å–å¾—ä¸­â€¦</div>

  <!-- ARã‚·ãƒ¼ãƒ³ï¼ˆåˆå‰ä¸­ã¨åŒã˜æ§‹æˆï¼‰ -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="antialias: true; alpha: true"
  >
    <!-- å®Ÿæ©ŸGPSã‚«ãƒ¡ãƒ© -->
    <a-camera gps-camera rotation-reader></a-camera>

    <!-- â˜…ãƒ‡ãƒãƒƒã‚°ç”¨ã®ç·‘ç®±ã¯å‰Šé™¤ã—ã¾ã—ãŸ -->
    <!-- <a-box position="0 0 -2" depth="0.2" height="0.2" width="0.2" color="#00FFAA"></a-box> -->
  </a-scene>

  <!-- iPhoneç”¨ï¼šã‚»ãƒ³ã‚µãƒ¼ã‚’æ˜ç¤ºçš„ã«æœ‰åŠ¹åŒ–ã™ã‚‹ãƒœã‚¿ãƒ³ -->
  <button id="sensorButton">ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<script>
/* ========= 1. ãƒ­ã‚°é€ä¿¡ç”¨ï¼ˆGASï¼‰ ========= */
const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw_uhqYjG25qdhdrZ6zCZgjTCKPVypqmTcgKenXBtt4LSBCaoARHYSAYxtMEHijY1rSdA/exec';

function sendLog(payload) {
  fetch(LOG_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).catch(err => console.warn('ãƒ­ã‚°é€ä¿¡å¤±æ•—:', err));
}

/* ========= 2. ã‚«ãƒ†ã‚´ãƒªå®šç¾© ========= */
const GROUPS = {
  sightseeing: { label: 'è¦³å…‰',        color: '#ff7f7f' },  // èµ¤ç³»
  public:      { label: 'å…¬å…±æ–½è¨­',    color: '#7fff7f' },  // ç·‘ç³»
  school:      { label: 'å­¦æ ¡',        color: '#7f7fff' }   // é’ç³»
};

/* ========= 3. ç™»éŒ²ã™ã‚‹åœ°ç‚¹ =========
   ç”»åƒã¯ /Index/Picture/ ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ PNG ã‚’ä½¿ç”¨ã—ã¾ã™
   ï¼ˆGitHub ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«åã¨å¤§æ–‡å­—å°æ–‡å­—ã¾ã§å¿…ãšä¸€è‡´ã•ã›ã¦ãã ã•ã„ï¼‰
*/
const PLACES = [
  // è¦³å…‰
  { id:'TasParkHotel',      name:'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«',       lat:38.10148128126027,  lon:140.0433090680094,  radius:50, group:'sightseeing', image:'Index/Picture/TasParkHotel.png' },
  { id:'MichinoEkiNagai',   name:'é“ã®é§… ã‹ã‚ã®ã¿ãªã¨é•·äº•', lat:38.108970970886325, lon:140.04382939078403, radius:50, group:'sightseeing', image:'Index/Picture/MichinoEkiNagai.png' },
  { id:'Kozakurakan',       name:'å°æ¡œé¤¨',                  lat:38.110963329145335, lon:140.03632275489852, radius:50, group:'sightseeing', image:'Index/Picture/Kozakurakan.png' },
  { id:'Marudaiougiya',     name:'ä¸¸å¤§æ‰‡å±‹',                lat:38.11228246118919,  lon:140.036198935986,   radius:50, group:'sightseeing', image:'Index/Picture/Marudaiougiya.png' },

  // å…¬å…±æ–½è¨­
  { id:'MinamiNagai',       name:'å—é•·äº•é§…',                lat:38.09769549394771,  lon:140.03458623775896, radius:50, group:'public', image:'Index/Picture/MinamiNagai.png' },
  { id:'Nagaisiyakusho',    name:'é•·äº•å¸‚å½¹æ‰€',              lat:38.1063333593554,   lon:140.033892868012,   radius:50, group:'public', image:'Index/Picture/Nagaisiyakusho.png' },
  { id:'Kurunt',            name:'ã‚¯ãƒ«ãƒ³ãƒˆ',                lat:38.10491876278905,  lon:140.03466346205656, radius:50, group:'public', image:'Index/Picture/Kurunt.png' },

  // å­¦æ ¡
  { id:'MNagaiShougakkou',  name:'é•·äº•å°å­¦æ ¡',              lat:38.107796313044474, lon:140.04269068239356, radius:50, group:'school', image:'Index/Picture/MNagaiShougakkou.png' },
  { id:'NagaiKougyokoukou', name:'é•·äº•å·¥æ¥­é«˜æ ¡',            lat:38.114426209437404, lon:140.03013087985815, radius:50, group:'school', image:'Index/Picture/NagaiKougyokoukou.png' },
  { id:'Nagaikoukou',       name:'é•·äº•é«˜æ ¡',                lat:38.097283861825424, lon:140.0380452392042,  radius:50, group:'school', image:'Index/Picture/Nagaikoukou.png' }
];

const hud = document.getElementById('hud');

/* ========= 4. è·é›¢è¨ˆç®— ========= */
function distanceMeter(lat1, lon1, lat2, lon2) {
  const R = 6378137;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* ========= 5. å„åœ°ç‚¹ç”¨ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œæˆ =========
   ã“ã“ã§ã€Œã‚«ãƒ©ãƒ¼ãƒ©ãƒ™ãƒ«ï¼‹å†™çœŸï¼‹ãƒ†ã‚­ã‚¹ãƒˆã€ã‚’1ã¤ã®è¦ª <a-entity> ã«ã¾ã¨ã‚ã¾ã™
*/
function createPlaceEntities() {
  const scene = document.querySelector('a-scene');

  PLACES.forEach(place => {
    const groupInfo = GROUPS[place.group] || GROUPS.sightseeing;
    const parent = document.createElement('a-entity');
    parent.setAttribute('id', 'place-' + place.id);
    parent.setAttribute('position', '0 1.5 -3'); // ã‚«ãƒ¡ãƒ©å‰ 3m ãã‚‰ã„
    parent.setAttribute('visible', 'false');

    // èƒŒæ™¯ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆã‚«ãƒ†ã‚´ãƒªè‰²ï¼‰
    const bg = document.createElement('a-plane');
    bg.setAttribute('width', '2.6');
    bg.setAttribute('height', '1.6');
    bg.setAttribute('color', groupInfo.color);
    bg.setAttribute('opacity', '0.75');
    bg.setAttribute('position', '0 0 0'); // è¦ªã®ä¸­å¿ƒ
    parent.appendChild(bg);

    // å ´æ‰€åãƒ†ã‚­ã‚¹ãƒˆ
    const title = document.createElement('a-text');
    title.setAttribute('value', `[${groupInfo.label}] ${place.name}`);
    title.setAttribute('align', 'center');
    title.setAttribute('width', '4');
    title.setAttribute('color', '#ffffff');
    title.setAttribute('position', '0 0.55 0.01');
    parent.appendChild(title);

    // å†™çœŸï¼ˆIndex/Picture ã® PNGï¼‰
    const img = document.createElement('a-image');
    img.setAttribute('src', place.image);
    img.setAttribute('width', '2.3');
    img.setAttribute('height', '1.0');
    img.setAttribute('position', '0 -0.25 0.02');
    img.setAttribute('material', 'side: double;');
    parent.appendChild(img);

    /* å°†æ¥ GLB ã‚’ç½®ãå ´åˆã®ä¾‹ï¼ˆä»Šã¯ä½¿ã‚ãªã„ã®ã§ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
    const model = document.createElement('a-entity');
    model.setAttribute('gltf-model', `Index/3DModel/${place.id}.glb`);
    model.setAttribute('position', '0 -1 0.05');
    model.setAttribute('scale', '0.5 0.5 0.5');
    parent.appendChild(model);
    */

    scene.appendChild(parent);

    // çŠ¶æ…‹ãƒ•ãƒ©ã‚°
    place._isInside = false;
  });
}

/* ========= 6. GPS ç›£è¦–ã—ã¦è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡ ========= */
let lastPos = null;
let lastSentAt = 0;

function startGPSWatch() {
  if (!navigator.geolocation) {
    hud.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯GPSãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
    return;
  }

  navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      lastPos = { lat, lon, acc };

      hud.textContent =
        `ğŸ“ ç¾åœ¨ã®GPS\nlat: ${lat.toFixed(6)}\nlon: ${lon.toFixed(6)}\nç²¾åº¦: Â±${acc.toFixed(1)}m`;

      PLACES.forEach(place => {
        const dist = distanceMeter(lat, lon, place.lat, place.lon);
        const parent = document.getElementById('place-' + place.id);
        if (!parent) return;

        const isNear = dist <= place.radius;

        parent.setAttribute('visible', isNear);

        if (!place._isInside && isNear) {
          sendLog({ place_id: place.id, event: 'enter', lat, lon, dist });
        }
        if (place._isInside && !isNear) {
          sendLog({ place_id: place.id, event: 'leave', lat, lon, dist });
        }
        place._isInside = isNear;
      });
    },
    (err) => {
      hud.textContent = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆ' + err.message + 'ï¼‰';
      console.warn('GPSå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );

  // 5ç§’ã”ã¨ã«ã€Œã„ã¾ã“ã“ã€ã‚’ãƒ­ã‚°
  setInterval(() => {
    if (!lastPos) return;
    const now = Date.now();
    if (now - lastSentAt < 5000) return;
    sendLog({
      place_id: 'current',
      event: 'position',
      lat: lastPos.lat,
      lon: lastPos.lon,
      acc: lastPos.acc
    });
    lastSentAt = now;
  }, 5000);
}

/* ========= 7. iPhoneå‘ã‘ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒœã‚¿ãƒ³ ========= */
const sensorButton = document.getElementById('sensorButton');

sensorButton.addEventListener('click', async () => {
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const state = await DeviceOrientationEvent.requestPermission();
      if (state === 'granted') {
        sensorButton.remove();
      } else {
        alert('ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
      }
    } catch (e) {
      alert('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  } else {
    sensorButton.remove(); // Android ç­‰ã§ã¯ä¸è¦
  }
});

/* ========= 8. åˆæœŸåŒ– ========= */
window.addEventListener('load', () => {
  createPlaceEntities();  // PNGï¼‹ã‚«ãƒ©ãƒ¼ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆ
  startGPSWatch();        // GPSç›£è¦–é–‹å§‹
});
</script>

</body>
</html>
