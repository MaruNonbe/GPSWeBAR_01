<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>GPS-AR (stable start + diagnostics)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #hud{position:fixed;top:12px;left:12px;right:12px;z-index:9999;
       font:16px/1.5 ui-monospace,monospace;color:#fff}
  .tag{display:inline-block;background:rgba(0,0,0,.55);padding:8px 10px;border-radius:8px}
  #status{margin-top:6px;white-space:pre-wrap}
  #gate{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:10000}
  #gate button{font-size:18px;padding:12px 18px;border:0;border-radius:10px}
</style>

<!-- A-Frame / AR.jsï¼ˆGPSï¼‰ -->
<script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
</head>
<body>

<!-- HUD -->
<div id="hud">
  <div id="latlon" class="tag">lat: -  lon: -  Â±- m</div><br>
  <div id="near"   class="tag">nearest: -</div><br>
  <div id="dist"   class="tag">distance: - m</div><br>
  <div id="status" class="tag">status: ready</div>
</div>

<!-- é–‹å§‹ã‚²ãƒ¼ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§æ¨©é™ã‚’æ´ã‚€ï¼‰ -->
<div id="gate"><button id="startBtn">ğŸ“· ARã‚’é–‹å§‹</button></div>

<!-- A-Frame Scene -->
<a-scene id="scene"
  embedded
  vr-mode-ui="enabled: false"
  renderer="colorManagement: true; physicallyCorrectLights: true"
  arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false">
  <a-camera gps-camera rotation-reader></a-camera>
  <a-entity light="type:ambient; intensity:0.9"></a-entity>

  <!-- è¦ªã‚’å¸¸æ™‚è¡¨ç¤ºï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ã™ã‚‹å ´åˆã‚‚è¦ªã¯ visible=true ã«ï¼‰ -->
  <a-entity id="poiRoot"
    gps-entity-place="latitude:38.101327; longitude:140.043027;"
    position="0 1 0" visible="true">

    <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ”ãƒ³ï¼ˆå¸¸ã«è¦‹ãˆã‚‹å½¢çŠ¶ï¼‰ -->
    <a-entity id="debugPin" visible="false">
      <a-torus radius="0.6" radius-tubular="0.03" rotation="-90 0 0" color="#16c7d9"></a-torus>
      <a-cylinder height="0.9" radius="0.12" color="#16c7d9" position="0 0.45 0"></a-cylinder>
      <a-sphere   radius="0.22" color="#16c7d9" position="0 0.95 0"></a-sphere>
    </a-entity>

    <!-- 3Dãƒ¢ãƒ‡ãƒ«ï¼ˆå¿…è¦ãªã‚‰URLå·®æ›¿ãˆï¼‰ -->
    <a-entity id="model" gltf-model="model.glb" scale="1 1 1" position="0 0 0" visible="false"></a-entity>

    <!-- éŸ³å£°ï¼ˆæ—¢å®šOFFï¼‰ -->
    <a-entity id="sound" sound="src: url(sound.mp3); autoplay: false; positional: true"></a-entity>
  </a-entity>
</a-scene>

<script>
/* ===== è¨­å®š ===== */
const POI = { lat: 38.101327, lon: 140.043027 }; // ã‚¿ã‚¹ãƒ‘å…¥å£
const USE_MODEL = false;  // â† ãƒ¢ãƒ‡ãƒ«ã¯æœ€åˆOFFï¼ˆå®‰å®šå¾Œã« trueï¼‰
const USE_SOUND = false;  // â† éŸ³ã¯æœ€åˆOFFï¼ˆå¿…è¦æ™‚ trueï¼‰
/* ================= */

const hudLatlon = document.getElementById('latlon');
const hudNear   = document.getElementById('near');
const hudDist   = document.getElementById('dist');
const hudStatus = document.getElementById('status');

const scene   = document.getElementById('scene');
const gate    = document.getElementById('gate');
const pin     = document.getElementById('debugPin');
const model   = document.getElementById('model');
const soundEl = document.getElementById('sound');
const camEl   = document.querySelector('[gps-camera]');

// 3Dãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰ãƒ­ã‚°
model.addEventListener('model-loaded', ()=> setStatus('model-loaded'));
model.addEventListener('model-error',  ()=> setStatus('model-error: check GLB URL'));

// AR.js ã‚«ãƒ¡ãƒ©ã‚¤ãƒ™ãƒ³ãƒˆ
scene.addEventListener('camera-init',    ()=> setStatus('camera-init'));
scene.addEventListener('camera-error', e => setStatus('camera-error: ' + (e && e.detail && e.detail.error && e.detail.error.message || 'unknown')));

// GPSæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
camEl.addEventListener('gps-camera-update-position', (e) => {
  const { position, accuracy } = e.detail;
  const lat = position.latitude, lon = position.longitude;
  hudLatlon.textContent = `lat:${fmt(lat)}  lon:${fmt(lon)}  Â±${fmt(accuracy)} m`;

  const d = haversine(lat, lon, POI.lat, POI.lon);
  hudDist.textContent = `distance: ${d.toFixed(1)} m`;

  const TRIGGER = Math.max((accuracy||20) * 1.5, 25); // ã—ãã„å€¤ã‚’ç²¾åº¦é€£å‹•ï¼‹ä¸‹é™25m
  hudNear.textContent = 'nearest: ' + (d < TRIGGER ? 'IN' : 'OUT');

  if (d < TRIGGER) {
    pin.setAttribute('visible', 'true');              // ã¾ãšãƒ”ãƒ³ã ã‘ç¢ºå®Ÿã«
    model.setAttribute('visible', USE_MODEL ? 'true' : 'false');
    if (USE_SOUND) { if (!soundEl.components.sound?.isPlaying) soundEl.components.sound.playSound(); }
    setStatus(`IN-RANGE (< ${TRIGGER.toFixed(1)} m)`);
  } else {
    pin.setAttribute('visible', 'false');
    model.setAttribute('visible', 'false');
    if (soundEl.components.sound?.isPlaying) soundEl.components.sound.stopSound();
    setStatus('out of range');
  }
});

// === ã‚¹ã‚¿ãƒ¼ãƒˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ä¸€åº¦ã ã‘ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’æ´ã‚€ â†’ è§£æ”¾ â†’ AR.js ===
document.getElementById('startBtn').onclick = async () => {
  try {
    setStatus('requesting camera (environment)...');
    const testStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    // å–å¾—æˆåŠŸ â†’ ã™ãè§£æ”¾ï¼ˆAR.js ã«è­²ã‚‹ï¼‰
    testStream.getTracks().forEach(t => t.stop());
    setStatus('permission granted. starting AR.js...');
  } catch(err) {
    setStatus('getUserMedia failed: ' + err.name + ' / ' + err.message +
              '\nSafariã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã€ŒaAã€â†’ã“ã®Webã‚µã‚¤ãƒˆã®è¨­å®šâ†’ã‚«ãƒ¡ãƒ©/ãƒã‚¤ã‚¯/ä½ç½®æƒ…å ±ã‚’ã€Œè¨±å¯ã€ã«ã—ã¦ãã ã•ã„ã€‚');
    return; // æ¨©é™ãªã‘ã‚Œã°ã“ã“ã§çµ‚äº†
  }
  // ã‚²ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
  gate.style.display = 'none';
  // ã“ã“ã‹ã‚‰AR.jsãŒã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é–‹å§‹ï¼ˆcamera-init/camera-errorã§çµæœãŒå‡ºã¾ã™ï¼‰
};

// === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
function setStatus(msg){ hudStatus.textContent = 'status: ' + msg; }
function fmt(v){ return (v==null || isNaN(v)) ? '-' : Number(v).toFixed(1); }
function haversine(lat1, lon1, lat2, lon2){
  const R=6371000, toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
</script>
</body>
</html>
