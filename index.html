<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>GPS-AR (stable start + debug pin)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #hud{position:fixed;top:12px;left:12px;right:12px;z-index:9999;
       font:16px/1.5 ui-monospace,monospace;color:#fff}
  .tag{display:inline-block;background:rgba(0,0,0,.55);
       padding:8px 10px;border-radius:8px}
  #status{margin-top:6px}
  #gate{position:fixed;inset:0;background:#000;display:flex;
        align-items:center;justify-content:center;z-index:10000}
  #gate button{font-size:18px;padding:12px 18px;border:0;border-radius:10px}
</style>

<!-- A-Frame / AR.jsï¼ˆGPSï¼‰ -->
<script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
</head>
<body>

<!-- HUD -->
<div id="hud">
  <div id="latlon" class="tag">lat: -  lon: -  Â±- m</div><br>
  <div id="dist"   class="tag">distance: - m</div><br>
  <div id="status" class="tag">status: ready</div>
</div>

<!-- 1ã‚¿ãƒƒãƒ—é–‹å§‹ï¼ˆè¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ç¢ºå®Ÿã«å‡ºã™ï¼‰ -->
<div id="gate"><button id="startBtn">ðŸ“· ARã‚’é–‹å§‹</button></div>

<!-- A-Frame Scene -->
<a-scene id="scene"
  embedded
  vr-mode-ui="enabled: false"
  renderer="colorManagement: true; physicallyCorrectLights: true"
  arjs="sourceType: webcam; gpsMinDistance: 1; debugUIEnabled: false;">
  <a-camera gps-camera></a-camera>
  <a-entity light="type:ambient; intensity:0.9"></a-entity>

  <!-- å‡ºç¾å¯¾è±¡ï¼ˆè¦ªï¼‰ã€‚POIã«ã‚¢ãƒ³ã‚«ãƒ¼ã€‚ -->
  <a-entity id="poiRoot"
    gps-entity-place="latitude:38.101327; longitude:140.043027;"
    position="0 1 0"              <!-- åœ°é¢ã«åŸ‹ã‚‚ã‚Œé˜²æ­¢ã§Y=+1m -->
    visible="false">

    <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ”ãƒ³ï¼ˆå¸¸ã«è¦‹ãˆã‚‹å½¢ï¼‰ -->
    <a-entity id="debugPin">
      <a-torus radius="0.6" radius-tubular="0.03" rotation="-90 0 0" color="#16c7d9"></a-torus>
      <a-cylinder height="0.9" radius="0.12" color="#16c7d9" position="0 0.45 0"></a-cylinder>
      <a-sphere radius="0.22" color="#16c7d9" position="0 0.95 0"></a-sphere>
    </a-entity>

    <!-- 3Dãƒ¢ãƒ‡ãƒ«ï¼ˆæœ€åˆã¯OFFï¼‰ -->
    <a-entity id="model" gltf-model="model.glb" scale="1 1 1" position="0 0 0" visible="false"></a-entity>

    <!-- éŸ³å£°ï¼ˆæœ€åˆã¯OFFï¼å¿…è¦æ™‚ã®ã¿å†ç”Ÿï¼‰ -->
    <a-entity id="sound" sound="src: url(sound.mp3); autoplay: false; positional: true"></a-entity>
  </a-entity>
</a-scene>

<script>
  // ===== è¨­å®š =====
  const POI = { lat: 38.101327, lon: 140.043027 }; // ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯å…¥å£
  const TRIGGER_M = 30;                             // èª¤å·®å¸åŽã®ãŸã‚10â†’30m
  const USE_MODEL = false;                          // â˜…æœ€åˆã‚ªãƒ•
  const USE_SOUND = false;                          // â˜…æœ€åˆã‚ªãƒ•
  // =================

  const hudLatlon = document.getElementById('latlon');
  const hudDist   = document.getElementById('dist');
  const hudStatus = document.getElementById('status');
  const poiRoot   = document.getElementById('poiRoot');
  const model     = document.getElementById('model');
  const soundEnt  = document.getElementById('sound');
  const camEl     = document.querySelector('[gps-camera]');
  const scene     = document.getElementById('scene');

  // ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰æˆå¦ã‚’HUDã«è¡¨ç¤º
  model.addEventListener('model-loaded', ()=> hudStatus.textContent = 'status: model-loaded');
  model.addEventListener('model-error', ()=> hudStatus.textContent = 'status: model-error (model.glbã‚’ç¢ºèª)');

  // é–‹å§‹ãƒœã‚¿ãƒ³ï¼šã‚«ãƒ¡ãƒ©ã‚’ä¸€åº¦ã ã‘æ˜Žç¤ºå–å¾—â†’å³åœæ­¢â†’ã‚²ãƒ¼ãƒˆé–‰ã˜ã‚‹
  document.getElementById('startBtn').onclick = async () => {
    try {
      hudStatus.textContent = 'status: requesting camera...';
      const s = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' } }, audio:false
      });
      s.getTracks().forEach(t=>t.stop()); // ã™ãåœæ­¢ï¼ˆAR.jsãŒå†å–å¾—ï¼‰
      document.getElementById('gate').style.display='none';
      hudStatus.textContent = 'status: starting camera...';
    } catch (e) {
      hudStatus.textContent = 'status: camera denied';
      alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Safariã®ã‚µã‚¤ãƒˆè¨­å®šã§ã€Œã‚«ãƒ¡ãƒ©ãƒ»ä½ç½®æƒ…å ±ã€ã‚’è¨±å¯ã«ã—ã¦ãã ã•ã„ã€‚');
    }
  };

  // AR.js ã®ãƒ“ãƒ‡ã‚ªãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰çŠ¶æ…‹è¡¨ç¤º
  scene.addEventListener('arjs-video-loaded', () => {
    hudStatus.textContent = 'status: camera running';
  });
  scene.addEventListener('camera-error', () => {
    hudStatus.textContent = 'status: camera error';
  });

  // GPSæ›´æ–°ã§è·é›¢è¨ˆç®—ï¼†å‡ºç¾åˆ¶å¾¡
  camEl.addEventListener('gps-camera-update-position', (e) => {
    const {position, accuracy} = e.detail || {};
    if (!position) return;

    const {latitude:lat, longitude:lon} = position;
    hudLatlon.textContent = `lat:${lat.toFixed(6)}  lon:${lon.toFixed(6)}  Â±${(accuracy||0).toFixed(1)} m`;

    const d = haversine(lat, lon, POI.lat, POI.lon);
    hudDist.textContent = `distance: ${d.toFixed(1)} m`;

    if (d < TRIGGER_M) {
      // IN range
      poiRoot.setAttribute('visible', 'true');
      model.setAttribute('visible', USE_MODEL ? 'true':'false');

      if (USE_SOUND) {
        if (!soundEnt.components.sound?.isPlaying) soundEnt.components.sound.playSound();
      } else {
        if (soundEnt.components.sound?.isPlaying) soundEnt.components.sound.stopSound();
      }
      hudStatus.textContent = `status: IN-RANGE (< ${TRIGGER_M} m)`;
    } else {
      // OUT range
      poiRoot.setAttribute('visible', 'false');
      if (soundEnt.components.sound?.isPlaying) soundEnt.components.sound.stopSound();
      hudStatus.textContent = 'status: out of range';
    }
  });

  // è·é›¢(m)
  function haversine(lat1, lon1, lat2, lon2){
    const R=6371000, toRad=d=>d*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }
</script>
</body>
</html>
