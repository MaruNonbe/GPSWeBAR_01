<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPSãƒˆãƒªã‚¬ãƒ¼ARï¼ˆåç§°ï¼‹ç”»åƒæ‹¡å¤§ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; }
    #hud {
      position: fixed;
      top: 8px; left: 8px;
      z-index: 9999;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 13px;
      line-height: 1.5;
      padding: 8px 10px;
      border-radius: 5px;
      white-space: pre-line;
    }
  </style>
</head>
<body>

  <div id="hud">ä½ç½®ã‚’å–å¾—ä¸­â€¦</div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="antialias: true; alpha: true">
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

<script>
/* ========= 1. ãƒ­ã‚°é€ä¿¡è¨­å®š ========= */
const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw_uhqYjG25qdhdrZ6zCZgjTCKPVypqmTcgKenXBtt4LSBCaoARHYSAYxtMEHijY1rSdA/exec';

function sendLog(payload) {
  fetch(LOG_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).catch(err => console.warn('ãƒ­ã‚°é€ä¿¡å¤±æ•—:', err));
}

/* ========= 2. ç™»éŒ²åœ°ç‚¹ ========= */
const PLACES = [
  { id: 'tas-park',         name: 'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«',       lat: 38.10148128126027, lon: 140.0433090680094, radius: 20, image: './Index/Picture/TasParkHotel.png' },
  { id: 'michinoeki',       name: 'é“ã®é§…ã‹ã‚ã®ã¿ãªã¨é•·äº•', lat: 38.108970970886325, lon: 140.04382939078403, radius: 20, image: './Index/Picture/MichinoEkiNagai.png' },
  { id: 'nagaishou',        name: 'é•·äº•å°å­¦æ ¡',             lat: 38.107796313044474, lon: 140.04269068239356, radius: 15, image: './Index/Picture/MNagaiShougakkou.png' },
  { id: 'kozakurakan',      name: 'å°æ¡œé¤¨',                 lat: 38.110963329145335, lon: 140.03632275489852, radius: 15, image: './Index/Picture/Kozakurakan.png' },
  { id: 'marudai',          name: 'ä¸¸å¤§æ‰‡å±‹',               lat: 38.11228246118919,  lon: 140.036198935986,   radius: 15, image: './Index/Picture/Marudaiougiya.png' },
  { id: 'cityhall',         name: 'é•·äº•å¸‚å½¹æ‰€',             lat: 38.1063333593554,   lon: 140.033892868012,   radius: 15, image: './Index/Picture/Nagaisiyakusho.png' },
  { id: 'kougyoukou',       name: 'é•·äº•å·¥æ¥­é«˜æ ¡',           lat: 38.114426209437404, lon: 140.03013087985815, radius: 15, image: './Index/Picture/NagaiKougyokoukou.png' },
  { id: 'koukou',           name: 'é•·äº•é«˜æ ¡',               lat: 38.097283861825424, lon: 140.0380452392042,  radius: 15, image: './Index/Picture/Nagaikoukou.png' },
  { id: 'minaminagai',      name: 'å—é•·äº•é§…',               lat: 38.09769549394771,  lon: 140.03458623775896, radius: 15, image: './Index/Picture/MinamiNagai.png' },
  { id: 'kurunt',           name: 'ãã‚‹ã‚“ã¨',               lat: 38.10491876278905,  lon: 140.03466346205656, radius: 15, image: './Index/Picture/Kurunt.png' }
];

const hud = document.getElementById('hud');

/* ========= 3. è·é›¢è¨ˆç®— ========= */
function distanceMeter(lat1, lon1, lat2, lon2) {
  const R = 6378137;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* ========= 4. ARã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆ ========= */
function createPlaceEntities() {
  const scene = document.querySelector('a-scene');
  PLACES.forEach(place => {
    const container = document.createElement('a-entity');
    container.setAttribute('gps-entity-place', `latitude: ${place.lat}; longitude: ${place.lon};`);

    // ç”»åƒï¼ˆ2å€ã‚µã‚¤ã‚ºï¼‰
    const img = document.createElement('a-image');
    img.setAttribute('src', place.image);
    img.setAttribute('width', '5');  // å…ƒã®2å€
    img.setAttribute('height', '2.4');
    img.setAttribute('position', '0 1.5 0');
    container.appendChild(img);

    // ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå ´æ‰€åï¼‰
    const text = document.createElement('a-text');
    text.setAttribute('value', place.name);
    text.setAttribute('align', 'center');
    text.setAttribute('color', '#FFFF00');
    text.setAttribute('position', '0 2.3 0');
    text.setAttribute('width', '8');
    container.appendChild(text);

    container.setAttribute('id', 'place-' + place.id);
    container.setAttribute('visible', 'false');
    scene.appendChild(container);

    place._isInside = false;
  });
}

/* ========= 5. GPSç›£è¦–ï¼‹HUDæ›´æ–° ========= */
let lastPos = null;
let lastSentAt = 0;

function startGPSWatch() {
  if (!navigator.geolocation) {
    hud.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯GPSãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
    return;
  }

  navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const accuracy = pos.coords.accuracy;
      lastPos = { lat, lon, accuracy };

      let nearPlace = null;
      PLACES.forEach(place => {
        const dist = distanceMeter(lat, lon, place.lat, place.lon);
        const entity = document.getElementById('place-' + place.id);
        const isNear = dist <= place.radius;
        if (entity) entity.setAttribute('visible', isNear);
        if (isNear) nearPlace = place.name;
        if (!place._isInside && isNear)
          sendLog({ place_id: place.id, event: 'enter', lat, lon });
        if (place._isInside && !isNear)
          sendLog({ place_id: place.id, event: 'leave', lat, lon });
        place._isInside = isNear;
      });

      // HUDæ›´æ–°
      hud.textContent =
        `ğŸ“ ç¾åœ¨ã®GPS\nlat: ${lat.toFixed(6)}\nlon: ${lon.toFixed(6)}\nç²¾åº¦: Â±${accuracy.toFixed(1)}m\n\n` +
        (nearPlace ? `ğŸ¯ ç¾åœ¨åœ°: ${nearPlace}` : `ï¼ˆç™»éŒ²åœ°ç‚¹å¤–ï¼‰`);
    },
    err => {
      hud.textContent = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆ' + err.message + 'ï¼‰';
      console.warn('GPSå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );

  // 5ç§’ã”ã¨ã«ä½ç½®ãƒ­ã‚°é€ä¿¡
  setInterval(() => {
    if (!lastPos) return;
    const now = Date.now();
    if (now - lastSentAt < 5000) return;
    sendLog({ place_id: 'current', event: 'position', lat: lastPos.lat, lon: lastPos.lon });
    lastSentAt = now;
  }, 5000);
}

/* ========= 6. åˆæœŸåŒ– ========= */
window.addEventListener('load', () => {
  createPlaceEntities();
  startGPSWatch();
});
</script>

<!-- iPhoneç”¨ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒœã‚¿ãƒ³ -->
<button id="sensorButton" style="
  position: fixed; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: #007bff; color: white;
  padding: 14px 26px; border: none;
  border-radius: 8px; font-size: 18px;
  z-index: 9999;">ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<script>
const sensorButton = document.getElementById('sensorButton');
sensorButton.addEventListener('click', async () => {
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const state = await DeviceOrientationEvent.requestPermission();
      if (state === 'granted') {
        alert('ã‚»ãƒ³ã‚µãƒ¼ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
        sensorButton.remove();
      } else {
        alert('ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
      }
    } catch (e) {
      alert('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  } else {
    sensorButton.remove(); // Androidã¯ä¸è¦
  }
});
</script>

</body>
</html>
