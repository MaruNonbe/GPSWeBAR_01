<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPSãƒˆãƒªã‚¬ãƒ¼ARï¼ˆæœ€çµ‚å®‰å®šç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆä»»æ„ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <style>
    #hud {
      position: fixed;
      top: 8px;
      left: 8px;
      z-index: 9999;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 12px;
      line-height: 1.4;
      padding: 6px 8px;
      border-radius: 4px;
      max-width: 90vw;
      white-space: pre-line;
    }
    body { margin:0; overflow:hidden; }
  </style>
</head>
<body>

  <!-- ç¾åœ¨ã®GPSã‚’è¡¨ç¤º -->
  <div id="hud">ä½ç½®ã‚’å–å¾—ä¸­â€¦</div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="antialias: true; alpha: true"
  >
    <!-- å®Ÿéš›ã®GPSä½ç½®ã«åŒæœŸã™ã‚‹ã‚«ãƒ¡ãƒ© -->
    <a-camera gps-camera rotation-reader></a-camera>

    <!-- è·é›¢ãŒè¿‘ã¥ãã¨è¡¨ç¤ºã•ã‚Œã‚‹ç”»åƒ -->
    <a-image
      id="near-content"
      src="./Index/Picture/TasParkHotel.png"
      position="0 1.5 -3"
      width="2.5"
      height="1.2"
      material="side: double;"
      visible="false"
    ></a-image>

    <!-- ãƒ‡ãƒãƒƒã‚°ç¢ºèªç”¨ãƒœãƒƒã‚¯ã‚¹ -->
    <a-box position="0 0 -2" depth="0.2" height="0.2" width="0.2" color="#00FFAA"></a-box>
  </a-scene>

  <script>
  const TARGET = { lat: 38.10148128126027, lon: 140.0433090680094 };
  const THRESHOLD_M = 10;
  const hud = document.getElementById('hud');
  const nearContent = document.getElementById('near-content');

  // è·é›¢è¨ˆç®—ï¼ˆmï¼‰
  function distanceMeter(lat1, lon1, lat2, lon2) {
    const R = 6378137;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // GPSç›£è¦–é–‹å§‹
  function startGPSWatch() {
    if (!navigator.geolocation) {
      hud.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯GPSãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
      return;
    }

    console.log('GPSã‚¦ã‚©ãƒƒãƒé–‹å§‹');

    navigator.geolocation.watchPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        console.log('ğŸ“å–å¾—æˆåŠŸ:', lat, lon);

        const dist = distanceMeter(lat, lon, TARGET.lat, TARGET.lon);

        hud.textContent =
          `ç¾åœ¨ã®GPS:\nlat: ${lat.toFixed(6)}\nlon: ${lon.toFixed(6)}\n\n` +
          `ç™»éŒ²GPS:\nlat: ${TARGET.lat}\nlon: ${TARGET.lon}\n\n` +
          `è·é›¢: ${dist.toFixed(2)} m\n(${THRESHOLD_M}mä»¥å†…ã§è¡¨ç¤º)`;

        // ä¸€å®šè·é›¢ä»¥å†…ãªã‚‰ç”»åƒã‚’è¡¨ç¤º
        nearContent.setAttribute('visible', dist <= THRESHOLD_M);
      },
      (err) => {
        console.warn('GPSå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
        hud.textContent = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆ' + err.message + 'ï¼‰';
      },
      { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
    );
  }

  // iOSã‚»ãƒ³ã‚µãƒ¼è¨±å¯
  async function requestIOSPermissions() {
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        const response = await DeviceOrientationEvent.requestPermission();
        if (response === 'granted') {
          console.log('âœ… Device orientation permission granted');
        } else {
          alert('ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ã€Œå†èª­ã¿è¾¼ã¿ã€å¾Œã«è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
        }
      } catch (e) {
        console.error('Device orientation permission error:', e);
      }
    }

    if (navigator.permissions) {
      const result = await navigator.permissions.query({ name: 'geolocation' });
      if (result.state === 'denied') {
        alert('ä½ç½®æƒ…å ±ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ã€Œè¨­å®š > Safari > ä½ç½®æƒ…å ±ã€ã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
      }
    }
  }

  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚
  window.addEventListener('load', async () => {
    await requestIOSPermissions();
    startGPSWatch();
  });
  </script>
</body>
</html>
