<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS AR (camera preflight)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#000; }
    #permOverlay{
      position:fixed; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center; gap:16px;
      background:#000; color:#fff; z-index:99999; text-align:center; padding:24px;
      font-family: -apple-system, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
    }
    #permBtn{ font-size:18px; padding:14px 20px; border-radius:10px; border:0; cursor:pointer; }
    #permMsg{ opacity:.9; line-height:1.6; }
  </style>

  <!-- A-Frame / AR.jsï¼ˆGPSç”¨ï¼‰-->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
</head>
<body>

  <!-- æ¨©é™ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆï¼ˆ1ã¤ã ã‘ã«ã™ã‚‹ï¼‰ -->
  <div id="permOverlay">
    <div id="permMsg">
      èƒŒæ™¯ãŒçœŸã£é»’ï¼çœŸã£ç™½ã®å ´åˆã¯ã‚«ãƒ¡ãƒ©æ¨©é™ãŒæœªè¨±å¯ã§ã™ã€‚<br>
      ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
    </div>
    <button id="permBtn">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
  </div>

  <!-- iOSå®‰å®šåŒ–ã®ãŸã‚ã®ä¸€æ™‚ videoï¼ˆéè¡¨ç¤ºï¼‰ -->
  <video id="camPreflight" playsinline muted style="display:none"></video>

  <!-- ARã‚·ãƒ¼ãƒ³ï¼šæ¨©é™ä»˜ä¸å¾Œã®å†èª­è¾¼ã§èµ·å‹• -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="colorManagement: true; physicallyCorrectLights: true"
    arjs="sourceType: webcam; gpsMinDistance: 1; debugUIEnabled: false;"
  >
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <script>
    const overlay = document.getElementById('permOverlay');
    const btn     = document.getElementById('permBtn');
    const vid     = document.getElementById('camPreflight');

    // ã™ã§ã«è¨±å¯æ¸ˆã¿ãªã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éš ã™
    if (navigator.permissions && navigator.permissions.query) {
      navigator.permissions.query({ name: 'camera' })
        .then(st => { if (st.state === 'granted') overlay.style.display = 'none'; })
        .catch(()=>{});
    }

    btn.addEventListener('click', async () => {
      try {
        // ç’°å¢ƒã‚«ãƒ¡ãƒ©ã‚’è¦æ±‚ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¿…é ˆï¼‰
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } }, audio: false
        });

        // iOSã§ä¸€ç¬ã‚¢ã‚¿ãƒƒãƒã—ã¦å†ç”Ÿã™ã‚‹ã¨å®‰å®š
        vid.srcObject = stream;
        await vid.play().catch(()=>{});

        // ã™ãåœæ­¢ã—ã€æ¨©é™ä»˜ä¸çŠ¶æ…‹ã§ AR.js ã‚’åˆæœŸåŒ–ã—ç›´ã™
        stream.getTracks().forEach(t => t.stop());
        overlay.style.display = 'none';
        location.reload();
      } catch (e) {
        alert([
          'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚',
          'Safariã®ã€Œãƒšãƒ¼ã‚¸è¨­å®šã€â†’ã€Œã‚«ãƒ¡ãƒ©ï¼šè¨±å¯ã€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
          'è¨­å®šã‚¢ãƒ—ãƒª â†’ Safari â†’ ã‚«ãƒ¡ãƒ© ã§ã‚‚ã€Œè¨±å¯ã€ã«ã§ãã¾ã™ã€‚',
          e && e.name ? `(${e.name})` : ''
        ].join('\n'));
        console.error(e);
      }
    });
  </script>
</body>
</html>
