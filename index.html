<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPSãƒˆãƒªã‚¬ãƒ¼ARï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥3Dãƒãƒ¼ã‚«ãƒ¼ï¼‹ãƒ©ãƒ™ãƒ«ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <!-- ï¼ˆä»»æ„ï¼‰ã‚¹ãƒãƒ›ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ« -->
  <!--
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  -->

  <style>
    body { margin:0; overflow:hidden; }
    #hud {
      position: fixed;
      top: 8px;
      left: 8px;
      z-index: 9999;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 12px;
      line-height: 1.4;
      padding: 6px 8px;
      border-radius: 4px;
      max-width: 90vw;
      white-space: pre-line;
    }
    #sensorButton {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #007bff;
      color: #fff;
      padding: 14px 26px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      z-index: 10000;
    }
  </style>
</head>
<body>

  <!-- ç”»é¢å·¦ä¸Šã®GPSè¡¨ç¤º -->
  <div id="hud">ä½ç½®ã‚’å–å¾—ä¸­â€¦</div>

  <!-- ARã‚·ãƒ¼ãƒ³ -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="antialias: true; alpha: true"
  >
    <!-- å®Ÿæ©ŸGPSã‚«ãƒ¡ãƒ© -->
    <a-camera gps-camera rotation-reader></a-camera>

    <!-- å¸¸æ™‚è¦‹ãˆã‚‹ãƒ†ã‚¹ãƒˆç”¨ãƒœãƒƒã‚¯ã‚¹ï¼ˆã‚«ãƒ¡ãƒ©å‰ 2mï¼‰-->
    <a-box position="0 0 -2" depth="0.2" height="0.2" width="0.2" color="#00FFAA"></a-box>
  </a-scene>

  <!-- iPhoneç”¨ï¼šã‚»ãƒ³ã‚µãƒ¼ã‚’æ˜ç¤ºçš„ã«æœ‰åŠ¹åŒ–ã™ã‚‹ãƒœã‚¿ãƒ³ -->
  <button id="sensorButton">ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<script>
/* ========= 1. GASã®URLï¼ˆå¿…è¦ãªã‚‰å·®ã—æ›¿ãˆï¼‰ ========= */
const LOG_ENDPOINT =
  'https://script.google.com/macros/s/AKfycbw_uhqYjG25qdhdrZ6zCZgjTCKPVypqmTcgKenXBtt4LSBCaoARHYSAYxtMEHijY1rSdA/exec';

// ãƒ­ã‚°é€ä¿¡ç”¨ã®å…±é€šé–¢æ•°
function sendLog(payload) {
  fetch(LOG_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).catch(err => {
    console.warn('ãƒ­ã‚°é€ä¿¡å¤±æ•—:', err);
  });
}

/* ========= 2. ç™»éŒ²åœ°ç‚¹ï¼ˆã‚«ãƒ†ã‚´ãƒªè¿½åŠ ï¼‰ =========
   category: 'tourism' | 'public' | 'school'
*/
const PLACES = [
  // è¦³å…‰
  { id: 'tas-park',          name: 'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«',        lat: 38.10148128126027, lon: 140.0433090680094, radius: 50, category: 'tourism' },
  { id: 'Kozakurakan',       name: 'å°æ¡œé¤¨',                  lat: 38.110963329145335, lon: 140.03632275489852, radius: 50, category: 'tourism' },
  { id: 'Marudaiougiya',     name: 'ä¸¸å¤§æ‰‡å±‹',                lat: 38.11228246118919,  lon: 140.036198935986,   radius: 50, category: 'tourism' },

  // å…¬å…±æ–½è¨­
  { id: 'MichinoEkiNagai',   name: 'é“ã®é§… ã‹ã‚ã®ã¿ãªã¨é•·äº•', lat: 38.108970970886325, lon: 140.04382939078403, radius: 50, category: 'public' },
  { id: 'Nagaisiyakusho',    name: 'é•·äº•å¸‚å½¹æ‰€',              lat: 38.1063333593554,   lon: 140.033892868012,   radius: 50, category: 'public' },
  { id: 'MinamiNagai',       name: 'å—é•·äº•é§…',                lat: 38.09769549394771,  lon: 140.03458623775896, radius: 50, category: 'public' },
  { id: 'Kurunt',            name: 'ã‚¯ãƒ«ãƒ³ãƒˆ',                lat: 38.10491876278905,  lon: 140.03466346205656, radius: 50, category: 'public' },

  // å­¦æ ¡
  { id: 'MNagaiShougakkou',  name: 'é•·äº•å°å­¦æ ¡',              lat: 38.107796313044474, lon: 140.04269068239356, radius: 50, category: 'school' },
  { id: 'NagaiKougyokoukou', name: 'é•·äº•å·¥æ¥­é«˜æ ¡',            lat: 38.114426209437404, lon: 140.03013087985815, radius: 50, category: 'school' },
  { id: 'Nagaikoukou',       name: 'é•·äº•é«˜æ ¡',                lat: 38.097283861825424, lon: 140.0380452392042,  radius: 50 category: 'school' }
];

const hud = document.getElementById('hud');

/* ========= 3. è·é›¢ã‚’ãƒ¡ãƒ¼ãƒˆãƒ«ã§è¨ˆç®— ========= */
function distanceMeter(lat1, lon1, lat2, lon2) {
  const R = 6378137;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* ========= 4. å„åœ°ç‚¹ç”¨ã® 3Dãƒãƒ¼ã‚«ãƒ¼ï¼‹ãƒ©ãƒ™ãƒ«ã‚’ã‚·ãƒ¼ãƒ³ã«è¿½åŠ  ========= */

// ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è¦‹ãŸç›®
const CATEGORY_STYLE = {
  tourism: {   // è¦³å…‰
    color: '#ffcc33',
    shape: 'cone',
    labelSuffix: 'è¦³å…‰'
  },
  public: {    // å…¬å…±æ–½è¨­
    color: '#33ccff',
    shape: 'box',
    labelSuffix: 'å…¬å…±æ–½è¨­'
  },
  school: {    // å­¦æ ¡
    color: '#ff6666',
    shape: 'sphere',
    labelSuffix: 'å­¦æ ¡'
  }
};

function createPlaceEntities() {
  const scene = document.querySelector('a-scene');

  PLACES.forEach(place => {
    const style = CATEGORY_STYLE[place.category] || CATEGORY_STYLE.tourism;

    // ãƒ«ãƒ¼ãƒˆï¼ˆã“ã® visible ã‚’ ON/OFF ã™ã‚‹ï¼‰
    const root = document.createElement('a-entity');
    root.setAttribute('id', 'place-' + place.id);
    root.setAttribute('position', '0 1.5 -3'); // ã‚«ãƒ¡ãƒ©å‰ 3m
    root.setAttribute('visible', 'false');
    scene.appendChild(root);

    // 3Dæœ¬ä½“ï¼ˆã‚«ãƒ†ã‚´ãƒªã”ã¨ã«å½¢ã¨è‰²ã‚’å¤‰æ›´ï¼‰
    let body;
    switch (style.shape) {
      case 'cone':   // è¦³å…‰
        body = document.createElement('a-cone');
        body.setAttribute('radius-bottom', '0.35');
        body.setAttribute('radius-top', '0.0');
        body.setAttribute('height', '0.7');
        break;
      case 'sphere': // å­¦æ ¡
        body = document.createElement('a-sphere');
        body.setAttribute('radius', '0.35');
        break;
      default:       // å…¬å…±æ–½è¨­ï¼box
        body = document.createElement('a-box');
        body.setAttribute('width',  '0.55');
        body.setAttribute('height', '0.55');
        body.setAttribute('depth',  '0.55');
        break;
    }
    body.setAttribute('color', style.color);
    body.setAttribute('position', '0 0 0');
    root.appendChild(body);

    // ãƒ©ãƒ™ãƒ«èƒŒæ™¯
    const labelBg = document.createElement('a-plane');
    labelBg.setAttribute('width', '2.6');
    labelBg.setAttribute('height', '0.6');
    labelBg.setAttribute('color', '#000');
    labelBg.setAttribute('opacity', '0.6');
    labelBg.setAttribute('position', '0 0.9 0');
    root.appendChild(labelBg);

    // ãƒ©ãƒ™ãƒ«æ–‡å­—
    const label = document.createElement('a-entity');
    label.setAttribute(
      'text',
      `value: ${place.name}ï¼ˆ${style.labelSuffix}ï¼‰; align: center; width: 2.5; color: #fff;`
    );
    label.setAttribute('position', '0 0.9 0.01');
    root.appendChild(label);

    // å†…éƒ¨çŠ¶æ…‹
    place._isInside = false;
  });
}

/* ========= 5. GPSç›£è¦–ï¼šè¡¨ç¤ºã¨ãƒ­ã‚° ========= */
let lastPos = null;
let lastSentAt = 0;

function startGPSWatch() {
  if (!navigator.geolocation) {
    hud.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯GPSãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
    return;
  }

  navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      lastPos = { lat, lon, acc };

      // æœ€ã‚‚è¿‘ã„åœ°ç‚¹ã‚’æ¢ã™
      let nearestPlace = null;
      let nearestDist = Infinity;
      let inRangeCount = 0;

      PLACES.forEach(place => {
        const dist = distanceMeter(lat, lon, place.lat, place.lon);
        const entity = document.getElementById('place-' + place.id);
        const isNear = dist <= place.radius;

        if (entity) {
          entity.setAttribute('visible', isNear);
        }

        if (isNear) inRangeCount++;

        if (dist < nearestDist) {
          nearestDist = dist;
          nearestPlace = place;
        }

        // å…¥é€€å ´ãƒ­ã‚°
        if (!place._isInside && isNear) {
          sendLog({ place_id: place.id, event: 'enter', lat, lon });
        }
        if (place._isInside && !isNear) {
          sendLog({ place_id: place.id, event: 'leave', lat, lon });
        }
        place._isInside = isNear;
      });

      const nearestStr = nearestPlace
        ? `${nearestPlace.name}ï¼ˆç´„${nearestDist.toFixed(1)}mï¼‰`
        : 'ãªã—';

      // HUDæ›´æ–°
      hud.textContent =
        `ğŸ“ ç¾åœ¨ã®GPS\n` +
        `lat: ${lat.toFixed(6)}\n` +
        `lon: ${lon.toFixed(6)}\n` +
        `ç²¾åº¦: Â±${acc.toFixed(1)}m\n\n` +
        `nearest: ${nearestStr}\n` +
        `in-range: ${inRangeCount} ä»¶`;

      // 5ç§’ã”ã¨ã«ç¾åœ¨ä½ç½®ãƒ­ã‚°
      const now = Date.now();
      if (now - lastSentAt > 5000) {
        sendLog({ place_id: 'current', event: 'position', lat, lon });
        lastSentAt = now;
      }
    },
    (err) => {
      hud.textContent = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆ' + err.message + 'ï¼‰';
      console.warn('GPSå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );
}

/* ========= 6. iPhoneå‘ã‘ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒœã‚¿ãƒ³ ========= */
const sensorButton = document.getElementById('sensorButton');

sensorButton.addEventListener('click', async () => {
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const state = await DeviceOrientationEvent.requestPermission();
      if (state === 'granted') {
        sensorButton.remove();
      } else {
        alert('ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
      }
    } catch (e) {
      alert('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  } else {
    sensorButton.remove(); // Android/PCãªã©ä¸è¦ãªç’°å¢ƒ
  }
});

/* ========= 7. åˆæœŸåŒ– ========= */
window.addEventListener('load', () => {
  createPlaceEntities();
  startGPSWatch();
});
</script>

</body>
</html>
