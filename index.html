<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS„Éà„É™„Ç¨„ÉºARÔºà„Çª„É≥„Çµ„ÉºË®±ÂèØÔºã„É≠„Ç∞Ôºâ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <!-- „Éá„Éê„ÉÉ„Ç∞Ôºà‰ªªÊÑèÔºâ -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <style>
    body { margin:0; overflow:hidden; }
    #hud {
      position: fixed; top: 8px; left: 8px; z-index: 9999;
      background: rgba(0,0,0,0.55); color: #fff;
      font-size: 12px; line-height: 1.4; padding: 6px 8px; border-radius: 4px;
      max-width: 90vw; white-space: pre-line;
    }
    #sensorButton {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #007bff; color: #fff; padding: 14px 26px; border: none;
      border-radius: 8px; font-size: 18px; z-index: 10000;
    }
  </style>
</head>
<body>

  <!-- ÁîªÈù¢Â∑¶‰∏ä„ÅÆGPSË°®Á§∫ -->
  <div id="hud">‰ΩçÁΩÆ„ÇíÂèñÂæó‰∏≠‚Ä¶</div>

  <!-- AR„Ç∑„Éº„É≥ -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="antialias: true; alpha: true"
  >
    <!-- ÂÆüÊ©üGPS„Ç´„É°„É© -->
    <a-camera gps-camera rotation-reader></a-camera>

    <!-- ‰ΩçÁΩÆÁ¢∫Ë™çÁî®„ÅÆÂ∞è„Åï„Å™ÁÆ±ÔºàÊçÆ„ÅàÁΩÆ„ÅçÔºâ -->
    <a-box position="0 0 -2" depth="0.2" height="0.2" width="0.2" color="#00FFAA"></a-box>
  </a-scene>

  <!-- iPhoneÁî®Ôºö„Çª„É≥„Çµ„Éº„ÇíÊòéÁ§∫ÁöÑ„Å´ÊúâÂäπÂåñ„Åô„Çã„Éú„Çø„É≥ -->
  <button id="sensorButton">„Çª„É≥„Çµ„Éº„ÇíÊúâÂäπ„Å´„Åô„Çã</button>

<script>
/* ========= 1. GAS„ÅÆURLÔºà„Åù„ÅÆ„Åæ„ÅæÔºâ ========= */
const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw_uhqYjG25qdhdrZ6zCZgjTCKPVypqmTcgKenXBtt4LSBCaoARHYSAYxtMEHijY1rSdA/exec';
function sendLog(payload) {
  fetch(LOG_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).catch(err => console.warn('„É≠„Ç∞ÈÄÅ‰ø°Â§±Êïó:', err));
}

/* ========= 2. Âú∞ÁÇπÔºà„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†Ôºâ =========
   category: Ë¶≥ÂÖâ / ÂÖ¨ÂÖ±ÊñΩË®≠ / Â≠¶Ê†°
*/
const PLACES = [
  { id:'tas-park',          name:'„Çø„Çπ„Éë„Éº„ÇØ„Éõ„ÉÜ„É´',        category:'Ë¶≥ÂÖâ',   lat:38.10148128126027,  lon:140.0433090680094,  radius:20 },
  { id:'Kozakurakan',       name:'Â∞èÊ°úÈ§®',                  category:'Ë¶≥ÂÖâ',   lat:38.110963329145335, lon:140.03632275489852, radius:15 },
  { id:'Marudaiougiya',     name:'‰∏∏Â§ßÊâáÂ±ã',                category:'Ë¶≥ÂÖâ',   lat:38.11228246118919,  lon:140.036198935986,   radius:15 },

  { id:'MinamiNagai',       name:'ÂçóÈï∑‰∫ïÈßÖ',                category:'ÂÖ¨ÂÖ±ÊñΩË®≠', lat:38.09769549394771, lon:140.03458623775896, radius:15 },
  { id:'MichinoEkiNagai',   name:'ÈÅì„ÅÆÈßÖ „Åã„Çè„ÅÆ„Åø„Å™„Å®Èï∑‰∫ï', category:'ÂÖ¨ÂÖ±ÊñΩË®≠', lat:38.108970970886325,lon:140.04382939078403, radius:20 },
  { id:'Nagaisiyakusho',    name:'Èï∑‰∫ïÂ∏ÇÂΩπÊâÄ',              category:'ÂÖ¨ÂÖ±ÊñΩË®≠', lat:38.1063333593554,  lon:140.033892868012,   radius:15 },
  { id:'Kurunt',            name:'„ÇØ„É´„É≥„Éà',                category:'ÂÖ¨ÂÖ±ÊñΩË®≠', lat:38.10491876278905, lon:140.03466346205656, radius:15 },

  { id:'NagaiKougyokoukou', name:'Èï∑‰∫ïÂ∑•Ê•≠È´òÊ†°',            category:'Â≠¶Ê†°',   lat:38.114426209437404, lon:140.03013087985815, radius:15 },
  { id:'Nagaikoukou',       name:'Èï∑‰∫ïÈ´òÊ†°',                category:'Â≠¶Ê†°',   lat:38.097283861825424, lon:140.0380452392042,  radius:15 }
];

/* ========= 2.5 „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„ÅÆÂΩ¢Áä∂„Å®Ëâ≤ =========
   Ë¶≥ÂÖâ=ÁêÉ(gold), ÂÖ¨ÂÖ±ÊñΩË®≠=Á´ãÊñπ‰Ωì(blue), Â≠¶Ê†°=ÂÜÜÈåê(green)
*/
const CATEGORY_STYLE = {
  'Ë¶≥ÂÖâ':       { primitive:'a-sphere',     color:'#ffb703', extra:{} },
  'ÂÖ¨ÂÖ±ÊñΩË®≠':   { primitive:'a-box',        color:'#2196f3', extra:{} },
  'Â≠¶Ê†°':       { primitive:'a-cone',       color:'#2ecc71', extra:{ 'radius-bottom':'0.6', 'radius-top':'0.0', height:'1.0' } }
};

const hud = document.getElementById('hud');

/* ========= 3. Ë∑ùÈõ¢Ôºà„É°„Éº„Éà„É´Ôºâ ========= */
function distanceMeter(lat1, lon1, lat2, lon2) {
  const R = 6378137, toRad = x => x*Math.PI/180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ========= 4. ÂêÑÂú∞ÁÇπ„ÅÆ3D„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºàÂΩ¢Ôºã„É©„Éô„É´Ôºâ„ÇíÁîüÊàê ========= */
function createPlaceEntities() {
  const scene = document.querySelector('a-scene');

  PLACES.forEach(place => {
    // Ë¶™Ôºà„Åì„ÅÆvisible„Å†„ÅëÂàá„ÇäÊõø„Åà„ÇãÔºâ
    const root = document.createElement('a-entity');
    root.setAttribute('id', 'place-' + place.id);
    root.setAttribute('position', '0 1.3 -3'); // „Ç´„É°„É©Ââç3m„ÉªÈ´ò„Åï1.3m
    root.setAttribute('visible', 'false');

    // ÂΩ¢Áä∂
    const style = CATEGORY_STYLE[place.category] || CATEGORY_STYLE['Ë¶≥ÂÖâ'];
    const shape = document.createElement(style.primitive);
    shape.setAttribute('color', style.color);
    // „Çµ„Ç§„Ç∫ÂÖ±ÈÄö
    shape.setAttribute('scale', '0.9 0.9 0.9');
    // ËøΩÂä†„Éë„É©„É°„Éº„ÇøÔºàcone„ÅÆÂçäÂæÑ„Å™„Å©Ôºâ
    Object.entries(style.extra).forEach(([k,v]) => shape.setAttribute(k, v));
    root.appendChild(shape);

    // „É©„Éô„É´ÔºàÂ†¥ÊâÄÂêçÔºâ
    const label = document.createElement('a-text');
    label.setAttribute('value', place.name);
    label.setAttribute('align', 'center');
    label.setAttribute('color', '#ffffff');
    label.setAttribute('position', '0 1.0 0'); // ÂΩ¢„ÅÆÂ∞ë„Åó‰∏ä
    label.setAttribute('width', '3.5');
    label.setAttribute('negate', 'false'); // ‰∏°Èù¢Ë°®Á§∫
    root.appendChild(label);

    // Ôºà‰ªªÊÑèÔºâË¶ñË™ç„Åó„ÇÑ„Åô„ÅÑ„É™„É≥„Ç∞„Éô„Éº„Çπ
    const ring = document.createElement('a-ring');
    ring.setAttribute('radius-inner', '0.55');
    ring.setAttribute('radius-outer', '0.65');
    ring.setAttribute('rotation', '-90 0 0');
    ring.setAttribute('position', '0 -0.6 0');
    ring.setAttribute('color', '#ffffff');
    ring.setAttribute('opacity', '0.5');
    root.appendChild(ring);

    scene.appendChild(root);

    // Áä∂ÊÖã„Éï„É©„Ç∞
    place._isInside = false;
  });
}

/* ========= 5. GPSÁõ£Ë¶ñÔºàË°®Á§∫ÔºÜ„É≠„Ç∞Ôºâ ========= */
let lastPos = null;
let lastSentAt = 0;

function startGPSWatch() {
  if (!navigator.geolocation) {
    hud.textContent = '„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„Åß„ÅØGPS„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì';
    return;
  }

  navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      lastPos = { lat, lon, acc };

      hud.textContent =
        `üìç ÁèæÂú®„ÅÆGPS\nlat: ${lat.toFixed(6)}\nlon: ${lon.toFixed(6)}\nÁ≤æÂ∫¶: ¬±${acc.toFixed(1)}m`;

      PLACES.forEach(place => {
        const dist = distanceMeter(lat, lon, place.lat, place.lon);
        const root = document.getElementById('place-' + place.id);
        const isNear = dist <= place.radius;

        if (root) root.setAttribute('visible', isNear);

        if (!place._isInside && isNear) sendLog({ place_id: place.id, event: 'enter', lat, lon });
        if ( place._isInside && !isNear) sendLog({ place_id: place.id, event: 'leave', lat, lon });
        place._isInside = isNear;
      });
    },
    (err) => {
      hud.textContent = '‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„ÇìÔºà' + err.message + 'Ôºâ';
      console.warn('GPSÂèñÂæó„Ç®„É©„Éº:', err);
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );

  // 5Áßí„Åî„Å®„Å´ÁèæÂú®Âú∞„É≠„Ç∞
  setInterval(() => {
    if (!lastPos) return;
    const now = Date.now();
    if (now - lastSentAt < 5000) return;
    sendLog({ place_id: 'current', event: 'position', lat: lastPos.lat, lon: lastPos.lon });
    lastSentAt = now;
  }, 5000);
}

/* ========= 6. iPhoneÂêë„Åë„Çª„É≥„Çµ„ÉºË®±ÂèØ„Éú„Çø„É≥ÔºàÊçÆ„ÅàÁΩÆ„ÅçÔºâ ========= */
const sensorButton = document.getElementById('sensorButton');
sensorButton.addEventListener('click', async () => {
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const state = await DeviceOrientationEvent.requestPermission();
      if (state === 'granted') {
        sensorButton.remove();
      } else {
        alert('„Çª„É≥„Çµ„Éº„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü');
      }
    } catch (e) {
      alert('„Çª„É≥„Çµ„ÉºË®±ÂèØ„É™„ÇØ„Ç®„Çπ„Éà‰∏≠„Å´„Ç®„É©„Éº: ' + e);
    }
  } else {
    sensorButton.remove();
  }
});

/* ========= 7. ÂàùÊúüÂåñ ========= */
window.addEventListener('load', () => {
  createPlaceEntities();
  startGPSWatch();
});
</script>

</body>
</html>
