
      await sys?.arSource?.start();
      setStatus('camera-init');
    } catch(e){
      setStatus('manual camera-start failed: '+e.message);
    }
  }, {once:true});
};

// GPS更新で距離を計算し、親の可視を切替
camEl.addEventListener('gps-camera-update-position', (e)=>{
  const {position, accuracy=20} = e.detail;
  const {latitude:lat, longitude:lon} = position;

  hud.latlon.textContent = `lat:${lat.toFixed(6)}  lon:${lon.toFixed(6)}  ±${accuracy.toFixed(1)} m`;

  // いちばん近いPOI
  let best = {name:'-', d: Infinity, poi:null};
  for (const p of POIS){
    const d = haversine(lat, lon, p.lat, p.lon);
    if (d < best.d){ best = {name:p.name, d, poi:p}; }
  }
  hud.near.textContent = `nearest: ${best.name}`;
  hud.dist.textContent = `distance: ${isFinite(best.d)?best.d.toFixed(1):'-'} m`;

  // 精度に応じてしきい値を自動調整（最低25m）
  const trigger = Math.max(accuracy * 1.5, 25);
  if (best.d < trigger){
    poiRoot.setAttribute('visible', 'true');   // ← 親だけ切替
    setStatus(`IN-RANGE (< ${trigger.toFixed(0)} m)`);
  } else {
    poiRoot.setAttribute('visible', 'false');
    setStatus('out of range');
  }
});

function haversine(lat1, lon1, lat2, lon2){
  const R=6371000, toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
</script>
</body>
</html>


うまくいかない時の判断ポイント（ここだけ見れば原因が分かります）


HUDが camera-init に到達しない → 端末/ブラウザ状態（タブ・権限・プライベート・WebGL/WebXR）。


camera-init は出たが lat/lon が - のまま → 屋内でGPSが入っていない。


distance が数百 m のまま / 近づいても表示されない → トリガーが厳しい or 親の可視切替対象ミス。




「午前中は動いた」のは事実です。その時の“状態”を上の手順で忠実に復元し、
さらに最小構成コードに戻せば、再現できます。
そこからカテゴリ分けやGLB/音声を親の可視切替を守りつつ段階的に足していけばOKです。

