<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS AR (iOSå¾©æ—§ç‰ˆ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;}
    #hud{position:fixed;left:12px;top:12px;background:rgba(0,0,0,.5);color:#fff;
         font-family:monospace;padding:8px 12px;border-radius:8px;z-index:9998}
    #permOverlay{position:fixed;inset:0;display:flex;flex-direction:column;gap:16px;
      align-items:center;justify-content:center;background:#000;color:#fff;
      z-index:9999;text-align:center;padding:24px}
    #permOverlay button{font-size:18px;padding:12px 18px;border:0;border-radius:10px}
    #preview{position:fixed;left:8px;bottom:8px;width:160px;height:120px;object-fit:cover;
      z-index:9999;border-radius:8px;display:none;box-shadow:0 0 0 2px rgba(255,255,255,.3)}
  </style>

  <!-- A-Frame / AR.jsï¼ˆiOS 18 å®‰å®šç‰ˆã‚’æ˜ç¤ºï¼‰ -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.4.4/aframe-ar.min.js"></script>
</head>
<body>

  <!-- ä½ç½®ï¼†ç²¾åº¦è¡¨ç¤º -->
  <div id="hud">lat: - lon: - Â±-m</div>

  <!-- æ¨©é™ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆ -->
  <div id="permOverlay">
    <div>èƒŒæ™¯ãŒçœŸã£é»’ï¼çœŸã£ç™½ã®å ´åˆã¯ã‚«ãƒ¡ãƒ©æ¨©é™ãŒæœªè¨±å¯ã§ã™ã€‚<br>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
    <button id="permBtn">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
    <div style="opacity:.8;font-size:14px;line-height:1.6">
      ã‚‚ã—æ˜ ã‚‰ãªã„å ´åˆï¼šSafariã®ã€Œãƒšãƒ¼ã‚¸è¨­å®šã€â†’ ã‚«ãƒ¡ãƒ©ï¼è¨±å¯ï¼<br>
      è¨­å®šã‚¢ãƒ—ãƒª â†’ Safari â†’ ã‚«ãƒ¡ãƒ© â†’ è¨±å¯ ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
    </div>
  </div>

  <!-- æ˜ åƒãŒæ¥ã¦ã„ã‚‹ã‹ã®ç›®è¦–ç”¨ã‚µãƒ ãƒ -->
  <video id="preview" playsinline muted></video>

  <!-- ARã‚·ãƒ¼ãƒ³ -->
  <a-scene
    vr-mode-ui="enabled:false"
    embedded
    renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true"
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled:false; facingMode: environment; gpsMinDistance:5;"
  >
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <script>
    // ===== 1) ã‚«ãƒ¡ãƒ©æ¨©é™ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆ =====
    const overlay = document.getElementById('permOverlay');
    const btn = document.getElementById('permBtn');
    const preview = document.getElementById('preview');

    // æ—¢ã«è¨±å¯æ¸ˆã¿ãªã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å¤–ã™
    if (navigator.permissions?.query) {
      navigator.permissions.query({name:'camera'}).then(s=>{
        if (s.state==='granted') overlay.style.display='none';
      }).catch(()=>{});
    }

    btn.addEventListener('click', async ()=>{
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:{ideal:'environment'} }, audio:false
        });
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç¢ºèª
        preview.srcObject = stream; preview.style.display='block';
        await preview.play().catch(()=>{});
        // ã™ãè§£æ”¾ï¼ˆAR.jsãŒå–ã‚Šç›´ã™ï¼‰
        stream.getTracks().forEach(t=>t.stop());
        overlay.style.display='none';
        // æ¨©é™ãŒé€šã£ãŸçŠ¶æ…‹ã§å†åˆæœŸåŒ–
        location.reload();
      }catch(e){
        alert('ã‚«ãƒ¡ãƒ©å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: '+(e.name||'')+' '+(e.message||''));
      }
    });

    // ===== 2) åœ°ç‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆè‰²ã¯ã‚«ãƒ†ã‚´ãƒªã§å›ºå®šï¼‰ =====
    const CAT = {
      sightseeing: { color:'#FF9500', label:'è¦³å…‰' },
      public:      { color:'#0A84FF', label:'å…¬å…±æ–½è¨­' },
      school:      { color:'#34C759', label:'å­¦æ ¡' }
    };
    const PLACES = [
      // è¦³å…‰
      { id:'Marudaiougiya', name:'ä¸¸å¤§æ‰‡å±‹', lat:38.11228246118919, lon:140.036198935986, radius:60, cat:'sightseeing' },
      { id:'Kozakurakan',   name:'å°æ¡œé¤¨',   lat:38.110963329145335, lon:140.03632275489852, radius:60, cat:'sightseeing' },
      { id:'TasPark',       name:'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«', lat:38.10148128126027, lon:140.0433090680094, radius:60, cat:'sightseeing' },
      // å…¬å…±æ–½è¨­
      { id:'MinamiNagai',   name:'å—é•·äº•é§…', lat:38.09769549394771, lon:140.03458623775896, radius:60, cat:'public' },
      { id:'MichiNoEki',    name:'é“ã®é§… ã‹ã‚ã®ã¿ãªã¨é•·äº•', lat:38.108970970886325, lon:140.04382939078403, radius:60, cat:'public' },
      { id:'CityHall',      name:'é•·äº•å¸‚å½¹æ‰€', lat:38.1063333593554, lon:140.033892868012, radius:60, cat:'public' },
      { id:'Kurunt',        name:'ã‚¯ãƒ«ãƒ³ãƒˆ', lat:38.10491876278905, lon:140.03466346205656, radius:60, cat:'public' },
      // å­¦æ ¡
      { id:'NagaiTechHS',   name:'é•·äº•å·¥æ¥­é«˜æ ¡', lat:38.114426209437404, lon:140.03013087985815, radius:60, cat:'school' },
      { id:'NagaiHS',       name:'é•·äº•é«˜æ ¡',     lat:38.097283861825424, lon:140.0380452392042, radius:60, cat:'school' },
    ];

    // ===== 3) ä½ç½®ã¨å¯è¦–åˆ¶å¾¡ï¼ˆæœ€ã‚‚è¿‘ã„1ä»¶ã®ã¿ï¼‰ =====
    const hud = document.getElementById('hud');
    const byId = {};
    function haversine(lat1,lon1,lat2,lon2){
      const R=6371000, toR=x=>x*Math.PI/180;
      const dLat=toR(lat2-lat1), dLon=toR(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toR(lat1))*Math.cos(toR(lat2))*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    function createEntities(){
      const scene=document.querySelector('a-scene');
      PLACES.forEach(p=>{
        const wrap=document.createElement('a-entity');
        wrap.setAttribute('id','place-'+p.id);
        wrap.setAttribute('gps-entity-place',`latitude: ${p.lat}; longitude: ${p.lon}`);
        wrap.setAttribute('visible','false');

        // ãƒ©ãƒ™ãƒ«
        const label=document.createElement('a-text');
        label.setAttribute('value',p.name);
        label.setAttribute('align','center');
        label.setAttribute('color','#FFFFFF');
        label.setAttribute('width','6');
        label.setAttribute('position','0 1.2 0');
        // ãƒãƒ¼ã‚«ãƒ¼
        const ball=document.createElement('a-sphere');
        const col=CAT[p.cat].color;
        ball.setAttribute('radius','0.5');
        ball.setAttribute('color',col);
        ball.setAttribute('scale','0.4 0.4 0.4');
        ball.setAttribute('animation','property: rotation; to: 0 360 0; loop: true; dur: 6000; easing: linear');

        wrap.appendChild(label);
        wrap.appendChild(ball);
        scene.appendChild(wrap);
        byId[p.id]={ entity:wrap, inside:false, lastDist:Infinity };
      });
    }

    function updateVisibility(lat,lon,acc){
      hud.textContent=`lat: ${lat.toFixed(6)}  lon: ${lon.toFixed(6)}  Â±${(acc||0).toFixed(1)} m`;
      const visibles=[];
      PLACES.forEach(p=>{
        const d=haversine(lat,lon,p.lat,p.lon);
        const st=byId[p.id];
        st.lastDist=d;
        if(d<=p.radius) visibles.push(p);

        // Enter / Leave ãƒ­ã‚°
        const isIn=(d<=p.radius);
        if(isIn && !st.inside){
          st.inside=true;
          console.log(`[Enter] ${p.name} (cat:${CAT[p.cat].label}) dist:${d.toFixed(1)}m radius:${p.radius}m`);
        }else if(!isIn && st.inside){
          st.inside=false;
          console.log(`[Leave] ${p.name} (cat:${CAT[p.cat].label}) lastDist:${d.toFixed(1)}m`);
        }
      });

      // æœ€ã‚‚è¿‘ã„1ä»¶ã ã‘è¡¨ç¤º
      Object.values(byId).forEach(s=>s.entity.setAttribute('visible','false'));
      if(visibles.length){
        visibles.sort((a,b)=>byId[a.id].lastDist - byId[b.id].lastDist);
        const near=visibles[0];
        byId[near.id].entity.setAttribute('visible','true');
      }
    }

    // å®Ÿè¡Œ
    createEntities();
    if('geolocation' in navigator){
      navigator.geolocation.watchPosition(
        pos=>{
          const {latitude,longitude,accuracy}=pos.coords;
          updateVisibility(latitude,longitude,accuracy);
        },
        err=>{ console.warn(err); },
        { enableHighAccuracy:true, maximumAge:0, timeout:10000 }
      );
    }else{
      hud.textContent='Geolocation ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
    }
  </script>
</body>
</html>
