<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS AR / è‡ªå‰ãƒ“ãƒ‡ã‚ªèƒŒæ™¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; touch-action:none; }
    /* èƒŒæ™¯ãƒ“ãƒ‡ã‚ªã‚’å…¨é¢ã«å›ºå®š */
    #bgVideo{
      position:fixed; inset:0; width:100vw; height:100svh; object-fit:cover;
      z-index:0; background:#000;
    }
    /* A-Frame/AR.js ã‚’å…¨é¢å›ºå®šï¼ˆãƒ“ãƒ‡ã‚ªã®ä¸Šã«é‡ã­ã‚‹ï¼‰ */
    a-scene, canvas.a-canvas, .a-loader-title{
      position:fixed !important; inset:0 !important;
      width:100vw !important; height:100svh !important; z-index:1 !important;
      max-width:100vw !important; max-height:100svh !important; overflow:hidden !important;
    }
    /* ä½ç½®æƒ…å ±HUD */
    #hud{
      position:fixed; left:12px; top:12px; z-index:9999;
      background:rgba(0,0,0,.6); color:#fff; font-family:monospace;
      padding:6px 10px; border-radius:8px;
    }
    /* ã‚«ãƒ¡ãƒ©è¨±å¯ã‚¬ã‚¤ãƒ‰ï¼ˆå¿…è¦æ™‚ã®ã¿è¡¨ç¤ºï¼‰ */
    #perm {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:99999;
      background:#000; color:#fff; text-align:center; padding:24px; gap:16px; flex-direction:column;
    }
    #perm button { font-size:18px; padding:12px 18px; border-radius:10px; border:0; }
  </style>

  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆå®‰å®šç‰ˆï¼‰ -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.4.4/aframe-ar.min.js"></script>
</head>
<body>
  <!-- 1) èƒŒæ™¯ã‚«ãƒ¡ãƒ©ï¼ˆè‡ªå‰ï¼‰ -->
  <video id="bgVideo" playsinline autoplay muted></video>

  <!-- 2) ä½ç½®è¡¨ç¤ºHUD -->
  <div id="hud">lat: - lon: - Â±- m</div>

  <!-- 3) è¨±å¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆå¿…è¦æ™‚ï¼‰ -->
  <div id="perm">
    <div>ã‚«ãƒ¡ãƒ©ãŒé–‹å§‹ã§ãã¾ã›ã‚“ã€‚<br>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚</div>
    <button id="askCam">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
    <pre id="err" style="white-space:pre-wrap;max-width:90%"></pre>
  </div>

  <!-- 4) ARã‚·ãƒ¼ãƒ³ï¼ˆGPSã®ã¿ä½¿ç”¨ï¼‰ -->
  <a-scene
    embedded
    vr-mode-ui="enabled:false"
    renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true"
    arjs="sourceType: webcam; videoTexture:true; facingMode: environment; debugUIEnabled:false; gpsMinDistance:5;"
  >
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <script>
    // ===== è‡ªå‰ã®ã‚«ãƒ¡ãƒ©èƒŒæ™¯ã‚’èµ·å‹• =====
    const bgVideo = document.getElementById('bgVideo');
    const perm = document.getElementById('perm');
    const askCam = document.getElementById('askCam');
    const errOut = document.getElementById('err');

    async function startBackgroundCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } }, audio: false
        });
        bgVideo.srcObject = stream;
        await bgVideo.play().catch(()=>{});
        perm.style.display = 'none';
      } catch (e) {
        perm.style.display = 'flex';
        errOut.textContent = (e.name||'') + ' ' + (e.message||'');
      }
    }
    askCam.addEventListener('click', startBackgroundCamera);
    // åˆå›è‡ªå‹•ãƒˆãƒ©ã‚¤ï¼ˆå¤±æ•—ã—ãŸã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒå‡ºã‚‹ï¼‰
    startBackgroundCamera();

    // ===== ä½ç½®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆæœ€å¯„ã‚Š1ä»¶ï¼Enter/Leaveãƒ­ã‚°ï¼‰ =====
    const CAT = {
      sightseeing:{ color:'#FF9500' }, // è¦³å…‰ï¼šä¸¸å¤§æ‰‡å±‹ãƒ»å°æ¡œé¤¨ãƒ»ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯
      public:{      color:'#0A84FF' }, // å…¬å…±ï¼šå—é•·äº•é§…ãƒ»é“ã®é§…ãƒ»å¸‚å½¹æ‰€ãƒ»ã‚¯ãƒ«ãƒ³ãƒˆ
      school:{      color:'#34C759' }  // å­¦æ ¡ï¼šé•·äº•å·¥æ¥­é«˜æ ¡ãƒ»é•·äº•é«˜æ ¡
    };
    const PLACES = [
      { id:'Marudaiougiya', name:'ä¸¸å¤§æ‰‡å±‹', lat:38.11228246118919,  lon:140.036198935986,   radius:60, cat:'sightseeing' },
      { id:'Kozakurakan',   name:'å°æ¡œé¤¨',   lat:38.110963329145335, lon:140.03632275489852,  radius:60, cat:'sightseeing' },
      { id:'TasPark',       name:'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«', lat:38.10148128126027, lon:140.0433090680094, radius:60, cat:'sightseeing' },
      { id:'MinamiNagai',   name:'å—é•·äº•é§…', lat:38.09769549394771,  lon:140.03458623775896, radius:60, cat:'public' },
      { id:'MichiNoEki',    name:'é“ã®é§… ã‹ã‚ã®ã¿ãªã¨é•·äº•', lat:38.108970970886325, lon:140.04382939078403, radius:60, cat:'public' },
      { id:'CityHall',      name:'é•·äº•å¸‚å½¹æ‰€', lat:38.1063333593554,  lon:140.033892868012,   radius:60, cat:'public' },
      { id:'Kurunt',        name:'ã‚¯ãƒ«ãƒ³ãƒˆ',  lat:38.10491876278905,  lon:140.03466346205656, radius:60, cat:'public' },
      { id:'NagaiTechHS',   name:'é•·äº•å·¥æ¥­é«˜æ ¡', lat:38.114426209437404, lon:140.03013087985815, radius:60, cat:'school' },
      { id:'NagaiHS',       name:'é•·äº•é«˜æ ¡',   lat:38.097283861825424, lon:140.0380452392042,  radius:60, cat:'school' },
    ];

    const hud = document.getElementById('hud');
    const toR = d=>d*Math.PI/180;
    const distM = (a,b,c,d)=>{
      const R=6371000, dLat=toR(c-a), dLon=toR(d-b);
      const s=Math.sin(dLat/2)**2 + Math.cos(toR(a))*Math.cos(toR(c))*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
    };

    const byId={};
    function createEntities(){
      const scene=document.querySelector('a-scene');
      PLACES.forEach(p=>{
        const e=document.createElement('a-entity');
        e.setAttribute('id','place-'+p.id);
        e.setAttribute('gps-entity-place',`latitude:${p.lat}; longitude:${p.lon}`);
        e.setAttribute('visible','false');

        const label=document.createElement('a-text');
        label.setAttribute('value',p.name);
        label.setAttribute('align','center');
        label.setAttribute('color','#FFFFFF');
        label.setAttribute('width','6');
        label.setAttribute('position','0 1.2 0');

        const ball=document.createElement('a-sphere');
        ball.setAttribute('radius','0.5');
        ball.setAttribute('color', CAT[p.cat].color);
        ball.setAttribute('scale','0.4 0.4 0.4');
        ball.setAttribute('animation','property: rotation; to: 0 360 0; loop: true; dur: 6000; easing: linear');

        e.appendChild(label); e.appendChild(ball); scene.appendChild(e);
        byId[p.id]={ ent:e, inside:false, last:Infinity };
      });
    }

    function update(lat,lon,acc){
      hud.textContent=`lat: ${lat.toFixed(6)}  lon: ${lon.toFixed(6)}  Â±${(acc||0).toFixed(1)} m`;

      const visibles=[];
      PLACES.forEach(p=>{
        const d=distM(lat,lon,p.lat,p.lon); const st=byId[p.id]; st.last=d;
        const inR = d<=p.radius;
        if(inR) visibles.push(p);
        if(inR && !st.inside){ st.inside=true;  console.log('[Enter]', p.name, d.toFixed(1)+'m'); }
        if(!inR && st.inside){ st.inside=false; console.log('[Leave]', p.name, d.toFixed(1)+'m'); }
      });

      Object.values(byId).forEach(s=>s.ent.setAttribute('visible','false'));
      if(visibles.length){
        visibles.sort((a,b)=>byId[a.id].last - byId[b.id].last);
        byId[visibles[0].id].ent.setAttribute('visible','true');
      }
    }

    createEntities();
    if('geolocation' in navigator){
      navigator.geolocation.watchPosition(
        p=>update(p.coords.latitude, p.coords.longitude, p.coords.accuracy),
        e=>console.warn(e),
        { enableHighAccuracy:true, maximumAge:0, timeout:10000 }
      );
    }
  </script>
</body>
</html>
