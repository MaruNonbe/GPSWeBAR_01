<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS-AR (camera-first)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden}
    #hud{position:fixed;top:10px;left:10px;right:10px;display:flex;flex-direction:column;gap:6px;z-index:9999;font:14px/1.4 ui-monospace,monospace;color:#fff}
    .tag{display:inline-block;background:rgba(0,0,0,.55);padding:6px 10px;border-radius:8px;width:max-content;max-width:100%}
    #notice{background:#e65100}
    #gate{position:fixed;inset:0;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;background:#000;color:#fff;z-index:10000}
    #gate button{font-size:18px;padding:12px 18px;border:0;border-radius:10px}
  </style>

  <!-- A-Frame / AR.js / look-at ã¯ã€Œã‚ã¨ã§ã€èª­ã¿è¾¼ã‚€ -->
  <script defer src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
  <script defer src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>
</head>
<body>

  <!-- æ¨©é™ã‚²ãƒ¼ãƒˆï¼ˆã“ã“ã§ã‚«ãƒ¡ãƒ©ã‚’å…ˆã«ç¢ºä¿ï¼‰ -->
  <div id="gate">
    <div style="opacity:.9;text-align:center">AR ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã‚«ãƒ¡ãƒ©æ¨©é™ãŒå¿…è¦ã§ã™ã€‚</div>
    <button id="startBtn">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
    <div id="err" style="max-width:90%;text-align:center;color:#ffbdbd"></div>
  </div>

  <!-- HUD -->
  <div id="hud" style="display:none">
    <div id="latlon" class="tag">lat: - lon: - Â±- m</div>
    <div id="nearest" class="tag">nearest: -</div>
    <div id="notice" class="tag" style="display:none">æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼æœªå–å¾— â†’ å‰æ–¹2mãƒ”ãƒ³ã‚’è¡¨ç¤ºä¸­</div>
  </div>

  <!-- A-Frame ã‚·ãƒ¼ãƒ³ã¯å¾Œã§å‹•çš„ã«æŒ¿å…¥ -->
  <div id="sceneHost"></div>

<script>
/* ---------------- è¨­å®šï¼ˆç›®çš„åœ°ï¼‰ ---------------- */
const POIS = [
  { name: 'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«', lat: 38.101327, lon: 140.043027 }
];
/* ------------------------------------------------ */

const gate = document.getElementById('gate');
const startBtn = document.getElementById('startBtn');
const err = document.getElementById('err');

startBtn.onclick = async () => {
  try {
    // 1) å…ˆã«ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’ç¢ºä¿ï¼ˆèƒŒé¢ã‚«ãƒ¡ãƒ©å¸Œæœ›ï¼‰
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } }, audio: false
    });
    // 2) ã™ãã«åœæ­¢ï¼ˆAR.js ãŒå–ã‚Šç›´ã™ï¼‰
    stream.getTracks().forEach(t => t.stop());

    // 3) ã‚·ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
    buildScene();

    // 4) ã‚²ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
    gate.style.display = 'none';
    document.getElementById('hud').style.display = '';
  } catch(e){
    err.textContent = 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¨­å®šâ†’Safariâ†’ã‚«ãƒ¡ãƒ© ã‚’ã€Œè¨±å¯ã€ã«ã—ã¦ãã ã•ã„ã€‚';
  }
};

function buildScene(){
  const host = document.getElementById('sceneHost');

  host.innerHTML = `
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="alpha: true; physicallyCorrectLights: true; colorManagement: true"
    arjs="sourceType: webcam; cameraPosition: back; videoTexture: true; debugUIEnabled: false;"
  >
    <a-entity light="type:ambient; intensity:0.9"></a-entity>
    <a-camera gps-camera rotation-reader></a-camera>
    <a-entity id="aheadPin" visible="false">
      <a-sphere radius="0.25" color="#00bcd4"></a-sphere>
      <a-ring radius-inner="0.23" radius-outer="0.28" rotation="-90 0 0" color="#00bcd4"></a-ring>
    </a-entity>
  </a-scene>
  `;

  setupLogic();
}

function setupLogic(){
  const hudLatlon = document.getElementById('latlon');
  const hudNearest = document.getElementById('nearest');
  const hudNotice  = document.getElementById('notice');
  const scene = document.querySelector('a-scene');
  const camEl = document.querySelector('[gps-camera]');

  // ---- æ–¹ä½ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆ2ç§’ä»¥å†…ã«deviceorientationãŒæ¥ãªã‘ã‚Œã°ç™ºå‹•ï¼‰
  let headingOk = false;
  let headingTimer = setTimeout(()=>{ if(!headingOk) enableFallback(); }, 2000);

  function onOrient(){
    headingOk = true;
    clearTimeout(headingTimer);
    const ahead = document.getElementById('aheadPin');
    if (ahead) ahead.setAttribute('visible', false);
    hudNotice.style.display = 'none';
    window.removeEventListener('deviceorientation', onOrient);
  }
  window.addEventListener('deviceorientation', onOrient);

  function enableFallback(){
    const ahead = document.getElementById('aheadPin');
    if (!ahead) return;
    ahead.setAttribute('visible', true);
    hudNotice.style.display = '';
    const cam = document.querySelector('[gps-camera]');
    const tick = () => {
      if (!cam.object3D) { requestAnimationFrame(tick); return; }
      const dir = new THREE.Vector3(0,0,-1).applyQuaternion(cam.object3D.quaternion).normalize();
      const pos = cam.object3D.position.clone().add(dir.multiplyScalar(2));
      pos.y = (cam.object3D.position.y||0) + 0.5;
      ahead.object3D.position.copy(pos);
      requestAnimationFrame(tick);
    };
    tick();
  }

  // ---- GPS ã§HUDæ›´æ–°ã¨POIé…ç½®
  let placed = false;
  camEl.addEventListener('gps-camera-update-position', (e) => {
    const {position, accuracy} = e.detail;
    const {latitude:lat, longitude:lon} = position;
    hudLatlon.textContent = `lat: ${lat.toFixed(6)}  lon: ${lon.toFixed(6)}  Â±${(accuracy||0).toFixed(1)} m`;

    // æœ€å¯„ã‚Š
    let nearest = {name:'-', d:Infinity};
    for (const p of POIS){
      const d = haversine(lat, lon, p.lat, p.lon);
      if (d < nearest.d) nearest = {name:p.name, d};
    }
    hudNearest.textContent = `nearest: ${nearest.name} (${isFinite(nearest.d)?nearest.d.toFixed(1):'-'} m)`;

    if (!placed){
      placed = true;
      for (const p of POIS){
        const e = document.createElement('a-entity');
        e.setAttribute('gps-entity-place', `latitude: ${p.lat}; longitude: ${p.lon}`);
        e.setAttribute('look-at', '[gps-camera]');
        e.innerHTML = `
          <a-sphere radius="0.6" color="#ff9800"></a-sphere>
          <a-text value="${p.name}" align="center" position="0 1 0" color="#fff"></a-text>
        `;
        scene.appendChild(e);
      }
    }
  });
}

function haversine(lat1, lon1, lat2, lon2){
  const R=6371000, toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
</script>
</body>
</html>
