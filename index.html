<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS-AR å®Œå…¨å¾©æ—§ç‰ˆ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font:14px/1.5 monospace;overflow:hidden;}
    #startGate{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:14px;background:#000;z-index:9999;}
    button{padding:12px 20px;font-size:18px;border-radius:10px;border:0;background:#2196f3;color:#fff;}
    #hud{position:fixed;top:10px;left:10px;z-index:9999}
  </style>

  <!-- A-Frame / AR.js -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
</head>
<body>

<div id="hud">lat:- lon:- Â±-m</div>

<div id="startGate">
  <div>ğŸ“·+ğŸ“æ¨©é™ã‚’è¨±å¯ã—ã¦ã‹ã‚‰ã€ŒARé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
  <button id="startBtn">ARé–‹å§‹</button>
  <div id="msg" style="color:#f66"></div>
</div>

<a-scene id="scene" embedded vr-mode-ui="enabled:false"
  renderer="colorManagement:true;physicallyCorrectLights:true"
  arjs="sourceType: camera; videoTexture: true; gpsMinDistance: 1; debugUIEnabled: false;">
  <a-camera gps-camera rotation-reader></a-camera>
  <a-entity light="type:ambient;intensity:0.9"></a-entity>
  <a-entity id="poi" gps-entity-place="latitude:38.101327; longitude:140.043027">
    <a-sphere color="#ff9800" radius="0.5"></a-sphere>
    <a-text value="ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«" align="center" position="0 1 0" color="#fff"></a-text>
  </a-entity>
</a-scene>

<script>
const hud = document.getElementById('hud');
const msg = document.getElementById('msg');
const gate = document.getElementById('startGate');

document.getElementById('startBtn').onclick = async () => {
  try {
    // --- ã‚«ãƒ¡ãƒ©æ¨©é™ ---
    const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:{ideal:'environment'}}, audio:false });
    stream.getTracks().forEach(t=>t.stop());
    msg.textContent = 'âœ… ã‚«ãƒ¡ãƒ©OK';

    // --- ä½ç½®æƒ…å ±æ¨©é™ ---
    await new Promise((res,rej)=>{
      navigator.geolocation.getCurrentPosition(p=>{
        hud.textContent=`lat:${p.coords.latitude.toFixed(6)} lon:${p.coords.longitude.toFixed(6)} Â±${p.coords.accuracy.toFixed(1)}m`;
        msg.textContent += ' âœ… GPS OK';
        res();
      }, e=>{
        msg.textContent='âŒ ä½ç½®æƒ…å ±å–å¾—å¤±æ•—:'+e.message;
        rej(e);
      },{enableHighAccuracy:true,timeout:8000});
    });

    // --- æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ï¼ˆiOSç‰¹æœ‰ï¼‰ ---
    if (window.DeviceOrientationEvent && DeviceOrientationEvent.requestPermission) {
      try {
        const state = await DeviceOrientationEvent.requestPermission();
        if (state === 'granted') console.log('orientation ok');
        else console.warn('orientation not granted');
      } catch(err) {
        console.warn('orientation permission error', err);
      }
    }

    // --- ã‚²ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹ ---
    gate.remove();

    // --- ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦– ---
    const scene = document.querySelector('a-scene');
    scene.addEventListener('camera-init', () => console.log('camera-init'));
    scene.addEventListener('camera-error', e => {
      msg.textContent='âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:'+e.message;
    });

    // GPSæ›´æ–°æ™‚ã«HUDæ›´æ–°
    document.querySelector('[gps-camera]').addEventListener('gps-camera-update-position', e=>{
      const {latitude,longitude,accuracy}=e.detail.position;
      hud.textContent=`lat:${latitude.toFixed(6)} lon:${longitude.toFixed(6)} Â±${accuracy.toFixed(1)}m`;
    });

  }catch(e){
    msg.textContent='âŒ æ¨©é™å–å¾—ã‚¨ãƒ©ãƒ¼:'+e.name+' '+e.message;
  }
};
</script>
</body>
</html>
