<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>GPS-AR (categories + accuracy trigger)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #hud{position:fixed;top:12px;left:12px;right:12px;z-index:10;
       font:16px/1.5 ui-monospace,monospace;color:#fff}
  .tag{display:inline-block;background:rgba(0,0,0,.55);
       padding:8px 10px;border-radius:8px}
  #status{margin-top:6px}
  #gate{position:fixed;inset:0;background:#000;display:flex;
        align-items:center;justify-content:center;z-index:20}
  #gate button{font-size:18px;padding:12px 18px;border:0;border-radius:10px}
</style>

<!-- A-Frame / AR.jsï¼ˆGPSï¼‰ -->
<script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
</head>
<body>

<!-- HUDï¼ˆä¸Šã«å›ºå®šã€‚é–‹å§‹å¾Œã¯ gate ã‚’å¿…ãšéžè¡¨ç¤ºã«ã™ã‚‹ï¼‰ -->
<div id="hud">
  <div id="latlon" class="tag">lat: -  lon: -  Â±- m</div><br>
  <div id="dist"   class="tag">distance: - m</div><br>
  <div id="status" class="tag">status: ready</div>
</div>

<!-- ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—é–‹å§‹ï¼ˆã‚«ãƒ¡ãƒ©è¨±å¯å‡ºã—ãƒ»è¢«ã‚Šå¯¾ç­–ã§é–‹å§‹å¾Œã«æ¶ˆã™ï¼‰ -->
<div id="gate"><button id="startBtn">ðŸ“· ARã‚’é–‹å§‹</button></div>

<!-- A-Frame Scene -->
<a-scene id="scene"
  embedded
  vr-mode-ui="enabled: false"
  renderer="colorManagement: true; physicallyCorrectLights: true"
  arjs="sourceType: webcam; gpsMinDistance: 1; debugUIEnabled: false">
  <a-camera gps-camera rotation-reader></a-camera>
  <a-entity light="type:ambient; intensity:0.9"></a-entity>

  <!-- â–¼ ã‚«ãƒ†ã‚´ãƒªè¦ªãƒŽãƒ¼ãƒ‰ï¼ˆã“ã“ã§å¯è¦–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼‰ -->
  <!-- å­¦æ ¡ -->
  <a-entity id="cat-school"
    gps-entity-place="latitude:38.101327; longitude:140.043027;"
    position="0 1 0" visible="false">
    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ”ãƒ³ï¼ˆå¸¸ã«è»½ã„å½¢çŠ¶ï¼‰ -->
    <a-entity>
      <a-torus radius="0.6" radius-tubular="0.03" rotation="-90 0 0" color="#16c7d9"></a-torus>
      <a-cylinder height="0.9" radius="0.12" color="#16c7d9" position="0 0.45 0"></a-cylinder>
      <a-sphere radius="0.22" color="#16c7d9" position="0 0.95 0"></a-sphere>
    </a-entity>
    <!-- ï¼ˆé‡ã„ï¼‰GLBã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFFï¼šå¿…è¦æ™‚ã ã‘ visible ã‚’ true ã« -->
    <a-entity id="model-school" gltf-model="school.glb" scale="1 1 1" visible="false"></a-entity>
    <a-entity id="sound-school" sound="src: url(school.mp3); autoplay: false; positional: true"></a-entity>
  </a-entity>

  <!-- å…¬å…±æ–½è¨­ï¼ˆä¾‹ï¼šè‰²é•ã„ãƒ”ãƒ³ï¼‰ -->
  <a-entity id="cat-public"
    gps-entity-place="latitude:38.101900; longitude:140.043500;"
    position="0 1 0" visible="false">
    <a-entity>
      <a-torus radius="0.6" radius-tubular="0.03" rotation="-90 0 0" color="#ff9800"></a-torus>
      <a-cylinder height="0.9" radius="0.12" color="#ff9800" position="0 0.45 0"></a-cylinder>
      <a-sphere radius="0.22" color="#ff9800" position="0 0.95 0"></a-sphere>
    </a-entity>
    <a-entity id="model-public" gltf-model="public.glb" scale="1 1 1" visible="false"></a-entity>
    <a-entity id="sound-public" sound="src: url(public.mp3); autoplay: false; positional: true"></a-entity>
  </a-entity>
</a-scene>

<script>
/* ================= è¨­å®š ================= */
const USE_MODEL = false;  // â» GLBã¯æ—¢å®šOFFï¼ˆé‡ã•å¯¾ç­–ï¼‰
const USE_SOUND = false;  // å¿…è¦æ™‚ true
// ç›£è¦–å¯¾è±¡ã‚«ãƒ†ã‚´ãƒªï¼ˆid ã¨ ãƒ©ãƒ™ãƒ«ï¼‰
const CATEGORIES = [
  { id: 'cat-school', label: 'school', modelId: 'model-school', soundId: 'sound-school',
    // ä¾¿å®œä¸Šï¼šè·é›¢è¡¨ç¤ºç”¨ã«POIåº§æ¨™ã‚‚æŒãŸã›ã‚‹ï¼ˆgps-entity-place ã¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
    lat: 38.101327, lon: 140.043027
  },
  { id: 'cat-public', label: 'public', modelId: 'model-public', soundId: 'sound-public',
    lat: 38.101900, lon: 140.043500
  }
];
/* ======================================= */

const hudLatlon = document.getElementById('latlon');
const hudDist   = document.getElementById('dist');
const hudStatus = document.getElementById('status');

// â¹ ã‚²ãƒ¼ãƒˆã®è¢«ã‚Šã‚’ç¢ºå®Ÿã«å¤–ã™
document.getElementById('startBtn').onclick = () => {
  document.getElementById('gate').style.display = 'none';
  hudStatus.textContent = 'status: starting camera...';
};

// è¿½åŠ ï¼šã‚«ãƒ¡ãƒ©ã®é–‹å§‹ã‚’æ¤œçŸ¥ã—ã¦çŠ¶æ…‹è¡¨ç¤ºï¼ˆé»’ç”»é¢åˆ‡ã‚Šåˆ†ã‘ï¼‰
document.querySelector('a-scene').addEventListener('arjs-video-loaded', () => {
  hudStatus.textContent = 'status: camera running';
});

// Haversineï¼ˆmï¼‰
function haversine(lat1, lon1, lat2, lon2){
  const R=6371000, toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ä½ç½®æ›´æ–° â†’ å„ã‚«ãƒ†ã‚´ãƒªã®ã€Œè¦ªã€ã‚’ã¾ã¨ã‚ã¦å¯è¦–åˆ‡æ›¿ï¼ˆâ¶,âºï¼‰
const camEl = document.querySelector('[gps-camera]');
camEl.addEventListener('gps-camera-update-position', (e) => {
  const {position, accuracy} = e.detail || {};
  const lat = position?.latitude, lon = position?.longitude;

  // HUD
  if (lat!=null && lon!=null){
    hudLatlon.textContent = `lat:${lat.toFixed(6)}  lon:${lon.toFixed(6)}  Â±${(accuracy||0).toFixed(1)} m`;
  }

  let nearestD = Infinity;

  CATEGORIES.forEach(cat => {
    const parent = document.getElementById(cat.id);
    const model  = document.getElementById(cat.modelId);
    const sound  = document.getElementById(cat.soundId);

    if (!parent || lat==null || lon==null){ return; }

    const d = haversine(lat, lon, cat.lat, cat.lon);
    if (isFinite(d) && d < nearestD) nearestD = d;

    // â· ç²¾åº¦é€£å‹•ã®ã—ãã„å€¤ï¼šæœ€ä½Ž25mã€ç²¾åº¦Ã—1.5ã‚’å„ªå…ˆ
    const trigger = Math.max((accuracy || 0) * 1.5, 25);

    if (d <= trigger){
      parent.setAttribute('visible', 'true');           // â† è¦ªã§å¯è¦–åŒ–ï¼ˆå­ã¯å¸¸æ™‚visibleæƒ³å®šï¼‰
      model?.setAttribute('visible', USE_MODEL ? 'true':'false'); // GLBã¯è¨­å®šã«å¾“ã†
      if (USE_SOUND){
        if (!sound?.components?.sound?.isPlaying) sound.components.sound.playSound();
      }else{
        if (sound?.components?.sound?.isPlaying) sound.components.sound.stopSound();
      }
    }else{
      parent.setAttribute('visible', 'false');          // â† è¦ªã”ã¨éžè¡¨ç¤º
      if (sound?.components?.sound?.isPlaying) sound.components.sound.stopSound();
    }
  });

  hudDist.textContent = `distance: ${isFinite(nearestD) ? nearestD.toFixed(1) : '-'} m`;
  hudStatus.textContent = 'status: tracking...';
});

// â¸ Y=0åŸ‹æ²¡å¯¾ç­–ï¼šã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªè¦ªã¯ position="0 1 0" ã‚’HTMLå´ã§è¨­å®šæ¸ˆã¿
//    ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã“ã“ã§ã•ã‚‰ã«å‹•çš„è£œæ­£ã‚‚å¯èƒ½ï¼‰
</script>
</body>
</html>
