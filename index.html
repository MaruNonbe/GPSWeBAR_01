<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS â†’ ã‚«ãƒ¡ãƒ©å‰3m ARç”»åƒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; }
    #hud {
      position:fixed; top:8px; left:8px; z-index:9999;
      background:rgba(0,0,0,0.55); color:#fff;
      padding:6px 8px; font-size:12px; border-radius:4px;
      white-space:pre-line;
    }
  </style>
</head>
<body>

<div id="hud">GPSå–å¾—ä¸­â€¦ï¼ˆæœ€å¤§30ç§’ã‹ã‹ã‚‹å ´åˆã‚ã‚Šï¼‰</div>

<a-scene
  embedded
  vr-mode-ui="enabled:false"
  arjs="sourceType: webcam; debugUIEnabled:false;"
  renderer="alpha:true; antialias:true">

  <!-- ã‚«ãƒ¡ãƒ© -->
  <a-camera id="camera" gps-camera rotation-reader></a-camera>

</a-scene>

<script>
/* ====== å¯¾è±¡åœ°ç‚¹ ====== */
const PLACES = [
  { name:'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«',
    lat:38.10148128126027, lon:140.0433090680094,
    radius:100,
    img:'Index/Picture/TasParkHotel.png'
  },
  { name:'é“ã®é§… ã‹ã‚ã®ã¿ãªã¨é•·äº•',
    lat:38.108970970886325, lon:140.04382939078403,
    radius:100,
    img:'Index/Picture/MichinoEkiNagai.png'
  },
  { name:'é•·äº•å°å­¦æ ¡',
    lat:38.107796313044474, lon:140.04269068239356,
    radius:100,
    img:'Index/Picture/MNagaiShougakkou.png'
  },
  { name:'å°æ¡œé¤¨',
    lat:38.110963329145335, lon:140.03632275489852,
    radius:100,
    img:'Index/Picture/Kozakurakan.png'
  },
  { name:'ä¸¸å¤§æ‰‡å±‹',
    lat:38.11228246118919, lon:140.036198935986,
    radius:100,
    img:'Index/Picture/Marudaiougiya.png'
  },
  { name:'é•·äº•å¸‚å½¹æ‰€',
    lat:38.1063333593554, lon:140.033892868012,
    radius:100,
    img:'Index/Picture/Nagaisiyakusho.png'
  }
];

/* ====== HUD ====== */
const hud = document.getElementById("hud");

/* ====== è·é›¢è¨ˆç®— ====== */
function distanceMeter(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lat2 - lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ====== 3må‰ã«å›ºå®šç”»åƒã‚’é…ç½® ====== */
const cameraEl = document.getElementById("camera");

const popup = document.createElement("a-image");
popup.setAttribute("id", "popupImage");
popup.setAttribute("position", "0 1.5 -3");  // â† ã‚«ãƒ¡ãƒ©å‰3mç¢ºå®š
popup.setAttribute("width", "3");
popup.setAttribute("height", "1.5");
popup.setAttribute("visible", "false");
cameraEl.appendChild(popup);

/* ====== GPSç›£è¦– ====== */
navigator.geolocation.watchPosition(
  pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const acc = pos.coords.accuracy;

    let nearestName = "";
    let nearestDist = 999999;

    PLACES.forEach(p => {
      const d = distanceMeter(lat, lon, p.lat, p.lon);

      if (d < nearestDist) {
        nearestName = p.name;
        nearestDist = d;
      }

      if (d <= p.radius) {
        popup.setAttribute("src", p.img);
        popup.setAttribute("visible", "true");
      }
    });

    hud.textContent =
      `ğŸ“ ç¾åœ¨ã®GPS\nlat: ${lat.toFixed(6)}\nlon: ${lon.toFixed(6)}\nç²¾åº¦: Â±${acc.toFixed(1)}m\n\n` +
      `nearest: ${nearestName}ï¼ˆç´„${nearestDist.toFixed(1)}mï¼‰`;
  },

  err => {
    hud.textContent = "GPSå–å¾—ã‚¨ãƒ©ãƒ¼: " + err.message;
  },

  { enableHighAccuracy:true, timeout:30000, maximumAge:0 }
);
</script>

</body>
</html>
