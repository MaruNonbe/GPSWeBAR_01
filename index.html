<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPSç”»åƒARï¼ˆIndex/Pictureç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; }
    #hud {
      position: fixed;
      top: 8px;
      left: 8px;
      z-index: 9999;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 12px;
      line-height: 1.4;
      padding: 6px 8px;
      border-radius: 4px;
      max-width: 90vw;
      white-space: pre-line;
    }
  </style>
</head>
<body>

  <!-- å·¦ä¸Šã®GPSè¡¨ç¤º -->
  <div id="hud">ä½ç½®ã‚’å–å¾—ä¸­â€¦</div>

  <!-- ARã‚·ãƒ¼ãƒ³ -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="antialias: true; alpha: true"
  >
    <!-- å®Ÿæ©ŸGPSã‚«ãƒ¡ãƒ© -->
    <a-camera gps-camera rotation-reader></a-camera>

    <!-- å‹•ä½œç¢ºèªç”¨ï¼šå¸¸ã«ã‚«ãƒ¡ãƒ©å‰ã«è¦‹ãˆã‚‹å°ã•ãªç®± -->
    <a-box position="0 0 -2"
           depth="0.2" height="0.2" width="0.2"
           color="#00FFAA"></a-box>
  </a-scene>

<script>
/* ========= 1. ç™»éŒ²åœ°ç‚¹ã¨ç”»åƒï¼ˆIndex/Pictureï¼‰ =========
   â€» ãƒ•ã‚¡ã‚¤ãƒ«åã¯ GitHub ã«ã‚ã‚‹ png ã¨å®Œå…¨ä¸€è‡´ã•ã›ã¦ãã ã•ã„
*/
const PLACES = [
  { id:'tas-park',          name:'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«',
    lat:38.10148128126027,  lon:140.0433090680094,
    radius:50, img:'Index/Picture/TasParkHotel.png' },

  { id:'MichinoEkiNagai',   name:'é“ã®é§… ã‹ã‚ã®ã¿ãªã¨é•·äº•',
    lat:38.108970970886325, lon:140.04382939078403,
    radius:50, img:'Index/Picture/MichinoEkiNagai.png' },

  { id:'MNagaiShougakkou',  name:'é•·äº•å°å­¦æ ¡',
    lat:38.107796313044474, lon:140.04269068239356,
    radius:50, img:'Index/Picture/MNagaiShougakkou.png' },

  { id:'Kozakurakan',       name:'å°æ¡œé¤¨',
    lat:38.110963329145335, lon:140.03632275489852,
    radius:50, img:'Index/Picture/Kozakurakan.png' },

  { id:'Marudaiougiya',     name:'ä¸¸å¤§æ‰‡å±‹',
    lat:38.11228246118919,  lon:140.036198935986,
    radius:50, img:'Index/Picture/Marudaiougiya.png' },

  { id:'Nagaisiyakusho',    name:'é•·äº•å¸‚å½¹æ‰€',
    lat:38.1063333593554,   lon:140.033892868012,
    radius:50, img:'Index/Picture/Nagaisiyakusho.png' },

  { id:'NagaiKougyokoukou', name:'é•·äº•å·¥æ¥­é«˜æ ¡',
    lat:38.114426209437404, lon:140.03013087985815,
    radius:50, img:'Index/Picture/NagaiKougyokoukou.png' },

  { id:'Nagaikoukou',       name:'é•·äº•é«˜æ ¡',
    lat:38.097283861825424, lon:140.0380452392042,
    radius:50, img:'Index/Picture/Nagaikoukou.png' },

  { id:'MinamiNagai',       name:'å—é•·äº•é§…',
    lat:38.09769549394771,  lon:140.03458623775896,
    radius:50, img:'Index/Picture/MinamiNagai.png' },

  { id:'Kurunt',            name:'ã‚¯ãƒ«ãƒ³ãƒˆ',
    lat:38.10491876278905,  lon:140.03466346205656,
    radius:50, img:'Index/Picture/Kurunt.png' }
];

const hud = document.getElementById('hud');

/* ========= 2. è·é›¢è¨ˆç®—ï¼ˆmï¼‰ ========= */
function distanceMeter(lat1, lon1, lat2, lon2) {
  const R = 6378137;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lat2 - lon1);
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* ========= 3. å„åœ°ç‚¹ã”ã¨ã® a-image ã‚’ä½œæˆ =========
   ãƒ»gps-entity-place ã§ç¾åœ°ã«å›ºå®š
   ãƒ»look-at ã§å¸¸ã«ã‚«ãƒ¡ãƒ©ã®æ–¹å‘ã‚’å‘ã
   ãƒ»æœ€åˆã¯ visible="false"
*/
function createPlaceEntities() {
  const scene = document.querySelector('a-scene');

  PLACES.forEach(place => {
    const img = document.createElement('a-image');
    img.setAttribute('id', 'place-' + place.id);
    img.setAttribute('gps-entity-place',
      `latitude: ${place.lat}; longitude: ${place.lon};`);
    img.setAttribute('src', place.img);
    img.setAttribute('look-at', '[gps-camera]');
    img.setAttribute('scale', '10 5 1');      // å°‘ã—å¤§ãã‚
    img.setAttribute('visible', 'false');
    scene.appendChild(img);

    place._isInside = false;
  });
}

/* ========= 4. GPSç›£è¦–ï¼šä¸€å®šè·é›¢å†…ã§ç”»åƒã‚’è¡¨ç¤º ========= */
function startGPSWatch() {
  if (!navigator.geolocation) {
    hud.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯GPSãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
    return;
  }

  navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;

      // æœ€å¯„ã‚Šåœ°ç‚¹ã‚’æ¢ã™
      let nearestName = 'ãªã—';
      let nearestDist = Infinity;

      PLACES.forEach(place => {
        const dist = distanceMeter(lat, lon, place.lat, place.lon);
        const entity = document.getElementById('place-' + place.id);
        const isNear = dist <= place.radius;  // åŠå¾„å†…ã‹ï¼Ÿ

        if (entity) {
          entity.setAttribute('visible', isNear);
        }

        if (dist < nearestDist) {
          nearestDist = dist;
          nearestName = place.name;
        }

        place._isInside = isNear;
      });

      hud.textContent =
        `ğŸ“ ç¾åœ¨ã®GPS\n` +
        `lat: ${lat.toFixed(6)}\n` +
        `lon: ${lon.toFixed(6)}\n` +
        `ç²¾åº¦: Â±${acc.toFixed(1)}m\n\n` +
        `nearest: ${nearestName}ï¼ˆç´„${nearestDist.toFixed(1)}mï¼‰`;
    },
    (err) => {
      hud.textContent = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆ' + err.message + 'ï¼‰';
      console.warn('GPSå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );
}

/* ========= 5. åˆæœŸåŒ– ========= */
window.addEventListener('load', () => {
  createPlaceEntities();
  startGPSWatch();
});
</script>

</body>
</html>
