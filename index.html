<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS AR (camera preflight)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- iOSã§ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å†ç”Ÿå¿…é ˆ -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#000; }
    #permOverlay{
      position:fixed; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center; gap:16px;
      background:#000; color:#fff; z-index:9999; text-align:center; padding:24px;
    }
    #permBtn{
      font-size:18px; padding:14px 20px; border-radius:10px; border:0; cursor:pointer;
    }
    #permMsg{ opacity:.85; line-height:1.6; }
  </style>

  <!-- A-Frame / AR.jsï¼ˆGPSç”¨ï¼‰-->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
</head>
<body>

  <!-- â¶ æ¨©é™ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="permOverlay">
    <div id="permMsg">
      èƒŒæ™¯ãŒçœŸã£é»’ï¼çœŸã£ç™½ã®å ´åˆã¯ã‚«ãƒ¡ãƒ©æ¨©é™ãŒæœªè¨±å¯ã§ã™ã€‚<br>
      ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
    </div>
    <button id="permBtn">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
  </div>
  <!-- iOSã®ä»•æ§˜å›é¿ç”¨ï¼šä¸€ç¬ã ã‘æ˜ åƒã‚’å—ã‘ã‚‹ãƒ—ãƒ¬ãƒ•ã‚£ãƒ©ã‚¤ãƒˆvideoï¼ˆéè¡¨ç¤ºï¼‰-->
  <video id="camPreflight" playsinline muted style="display:none"></video>

  <!-- â· ARã‚·ãƒ¼ãƒ³ï¼ˆæ¨©é™å–å¾—å¾Œã®å†èª­è¾¼ã§AR.jsãŒèµ·å‹•ï¼‰ -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="colorManagement: true; physicallyCorrectLights: true"
    arjs="sourceType: webcam; gpsMinDistance: 1; debugUIEnabled: false;"
  >
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <script>
    const overlay  = document.getElementById('permOverlay');
    const btn      = document.getElementById('permBtn');
    const vid      = document.getElementById('camPreflight');

    // ã™ã§ã«è¨±å¯æ¸ˆã¿ãªã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è‡ªå‹•ã§éš ã™ï¼ˆiOS 17 ä»¥é™ã¯ "granted"/"denied"/"prompt"ï¼‰
    if (navigator.permissions && navigator.permissions.query) {
      navigator.permissions.query({ name: 'camera' })
        .then(st => { if (st.state === 'granted') overlay.style.display = 'none'; })
        .catch(()=>{}); // æœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã¯ç„¡è¦–
    }

    btn.addEventListener('click', async () => {
      try {
        // â¸ æ˜ç¤ºçš„ã«ç’°å¢ƒã‚«ãƒ¡ãƒ©ã‚’è¦æ±‚ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œèµ·å› ï¼‰
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } }, audio: false
        });

        // iOSã§ã¯ä¸€åº¦ video ã«ã‚¢ã‚¿ãƒƒãƒã—ã¦å†ç”Ÿã‚’è©¦ã¿ã‚‹ã¨å®‰å®š
        vid.srcObject = stream;
        await vid.play().catch(()=>{});

        // ã™ãã«è§£æ”¾ï¼ˆAR.js ãŒå–ã‚Šç›´ã™ï¼‰
        stream.getTracks().forEach(t => t.stop());

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éš ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰
        overlay.style.display = 'none';
        location.reload(); // â† æ¨©é™ãŒé€šã£ãŸçŠ¶æ…‹ã§AR.jsãŒåˆæœŸåŒ–
      } catch (e) {
        // â¹ å¤±æ•—æ™‚ã®ã‚¬ã‚¤ãƒ‰
        const m = [
          'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚',
          'Safariã® å…±æœ‰ãƒœã‚¿ãƒ³(aa) â†’ã€Œãƒšãƒ¼ã‚¸è¨­å®šã€â†’ã€Œã‚«ãƒ¡ãƒ©ã€ã‚’ã€Œè¨±å¯ã€ã«',
          'ã¾ãŸã¯ è¨­å®šã‚¢ãƒ—ãƒª â†’ Safari â†’ ã‚«ãƒ¡ãƒ© â†’ã€Œè¨±å¯ã€ã«',
          e && e.name ? `(${e.name})` : ''
        ].join('\n');
        alert(m);
      }
    });
  </script>
</body>
</html>
