<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS â†’ ã‚«ãƒ¡ãƒ©å‰3m ARç”»åƒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; }
    #hud {
      position:fixed; top:8px; left:8px; z-index:9999;
      background:rgba(0,0,0,0.55); color:#fff;
      padding:6px 8px; font-size:12px; border-radius:4px;
      white-space:pre-line;
    }
  </style>
</head>
<body>

<div id="hud">GPSå–å¾—ä¸­â€¦ï¼ˆæœ€å¤§30ç§’ã‹ã‹ã‚‹å ´åˆã‚ã‚Šï¼‰</div>

<a-scene
  embedded
  vr-mode-ui="enabled:false"
  arjs="sourceType: webcam; debugUIEnabled:false;"
  renderer="alpha:true; antialias:true">

  <!-- gps-cameraã€‚ä¸­ã« popupImage ã‚’ã¶ã‚‰ä¸‹ã’ã‚‹ -->
  <a-camera id="camera" gps-camera rotation-reader>
    <!-- ã‚«ãƒ¡ãƒ©ã®å‰ 3m ã®å›ºå®šä½ç½®ã«è¡¨ç¤ºã•ã‚Œã‚‹ç”»åƒ -->
    <a-image id="popupImage"
             position="0 1.5 -3"
             width="3"
             height="1.5"
             visible="false">
    </a-image>
  </a-camera>

</a-scene>

<script>
// ====== 1. è¨­å®šåœ°ç‚¹ï¼ˆè·é›¢ã¨ç”»åƒï¼‰ ======
const PLACES = [
  { name:'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«',
    lat:38.10148128126027, lon:140.0433090680094,
    radius:100,
    img:'Index/Picture/TasParkHotel.png'
  },
  { name:'é“ã®é§… ã‹ã‚ã®ã¿ãªã¨é•·äº•',
    lat:38.108970970886325, lon:140.04382939078403,
    radius:100,
    img:'Index/Picture/MichinoEkiNagai.png'
  },
  { name:'é•·äº•å°å­¦æ ¡',
    lat:38.107796313044474, lon:140.04269068239356,
    radius:100,
    img:'Index/Picture/MNagaiShougakkou.png'
  },
  { name:'å°æ¡œé¤¨',
    lat:38.110963329145335, lon:140.03632275489852,
    radius:100,
    img:'Index/Picture/Kozakurakan.png'
  },
  { name:'ä¸¸å¤§æ‰‡å±‹',
    lat:38.11228246118919, lon:140.036198935986,
    radius:100,
    img:'Index/Picture/Marudaiougiya.png'
  },
  { name:'é•·äº•å¸‚å½¹æ‰€',
    lat:38.1063333593554, lon:140.033892868012,
    radius:100,
    img:'Index/Picture/Nagaisiyakusho.png'
  },
  { name:'é•·äº•å·¥æ¥­é«˜æ ¡',
    lat:38.114426209437404, lon:140.03013087985815,
    radius:100,
    img:'Index/Picture/NagaiKougyokoukou.png'
  },
  { name:'é•·äº•é«˜æ ¡',
    lat:38.097283861825424, lon:140.0380452392042,
    radius:100,
    img:'Index/Picture/Nagaikoukou.png'
  },
  { name:'å—é•·äº•é§…',
    lat:38.09769549394771, lon:140.03458623775896,
    radius:100,
    img:'Index/Picture/MinamiNagai.png'
  },
  { name:'ã‚¯ãƒ«ãƒ³ãƒˆ',
    lat:38.10491876278905, lon:140.03466346205656,
    radius:100,
    img:'Index/Picture/Kurunt.png'
  }
];

const hud   = document.getElementById("hud");
const popup = document.getElementById("popupImage");

// ====== è·é›¢è¨ˆç®— ======
function distanceMeter(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
    Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// ====== GPSç›£è¦–ãƒ»ç¯„å›²å†…ã§ç”»åƒè¡¨ç¤º ======
navigator.geolocation.watchPosition(
  pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const acc = pos.coords.accuracy;

    let nearestPlace = null;
    let nearestDist  = Number.POSITIVE_INFINITY;
    let activePlace  = null;

    PLACES.forEach(p => {
      const d = distanceMeter(lat, lon, p.lat, p.lon);

      // æœ€ã‚‚è¿‘ã„åœ°ç‚¹
      if (d < nearestDist) {
        nearestDist  = d;
        nearestPlace = p;
      }

      // radius å†…ã«å…¥ã£ãŸåœ°ç‚¹ï¼ˆæœ€å¾Œã«ãƒãƒƒãƒã—ãŸã‚‚ã®ã‚’æ¡ç”¨ï¼‰
      if (d <= p.radius) {
        activePlace = p;
      }
    });

    // ç”»åƒã®è¡¨ç¤ºï¼éè¡¨ç¤º
    if (activePlace) {
      popup.setAttribute("src", activePlace.img);
      popup.setAttribute("visible", "true");
    } else {
      popup.setAttribute("visible", "false");
    }

    // HUD è¡¨ç¤º
    let nearestText = "nearest: ãƒ¼";
    if (nearestPlace && nearestDist < 1_000_000) {
      nearestText =
        `nearest: ${nearestPlace.name}ï¼ˆç´„${nearestDist.toFixed(1)}mï¼‰`;
    }

    hud.textContent =
      `ğŸ“ ç¾åœ¨ã®GPS\n` +
      `lat: ${lat.toFixed(6)}\n` +
      `lon: ${lon.toFixed(6)}\n` +
      `ç²¾åº¦: Â±${acc.toFixed(1)}m\n\n` +
      nearestText;
  },
  err => {
    hud.textContent = "GPSå–å¾—ã‚¨ãƒ©ãƒ¼: " + err.message;
  },
  { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
);
</script>

</body>
</html>
