<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPS-AR failsafe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden}
    #hud{position:fixed;top:10px;left:10px;right:10px;display:flex;flex-direction:column;gap:6px;z-index:9999;font:14px/1.4 ui-monospace,monospace;color:#fff}
    .tag{display:inline-block;background:rgba(0,0,0,.55);padding:6px 10px;border-radius:8px;width:max-content;max-width:100%}
    #notice{background:#e65100}
    #btn{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);z-index:9999;padding:10px 14px;border:0;border-radius:10px}
  </style>

  <!-- A-Frame / AR.jsï¼ˆGPSï¼‰ -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@3.3.2/aframe-ar.min.js"></script>
</head>
<body>

  <!-- HUD -->
  <div id="hud">
    <div id="latlon" class="tag">lat: - lon: - Â±- m</div>
    <div id="nearest" class="tag">nearest: -</div>
    <div id="notice" class="tag" style="display:none">æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼æœªå–å¾— â†’ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã€Œå‰æ–¹2mãƒ”ãƒ³ã€ã‚’è¡¨ç¤ºä¸­</div>
  </div>

  <!-- A-Frame Scene -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true; physicallyCorrectLights: true"
    arjs="sourceType: webcam; gpsMinDistance: 1; debugUIEnabled: false;"
  >
    <!-- ã‚«ãƒ¡ãƒ©ï¼ˆä½ç½®ã¯GPSã€å‘ãã¯ãƒ‡ãƒã‚¤ã‚¹æ–¹ä½ã€‚æ–¹ä½ãŒå–ã‚Œãªã„æ™‚ã¯ãã®ã¾ã¾ï¼‰-->
    <a-camera gps-camera rotation-reader></a-camera>

    <!-- ã»ã‚“ã®ã‚Šç’°å¢ƒå…‰ -->
    <a-entity light="type:ambient; intensity:0.9"></a-entity>

    <!-- â–¼ ãƒ‡ãƒãƒƒã‚°ï¼šæ–¹ä½ãŒæ­»ã‚“ã æ™‚ã§ã‚‚â€œå‰æ–¹2m/é«˜ã•0.5mâ€ã«å¿…ãšè¦‹ãˆã‚‹ãƒ”ãƒ³ -->
    <a-entity id="aheadPin" visible="false">
      <a-sphere radius="0.25" color="#ff9800" position="0 0 0"></a-sphere>
    </a-entity>

  </a-scene>

  <button id="btn">å†èª­è¾¼</button>

  <script>
    // ====== è¨­å®šï¼ˆç›®çš„åœ°ï¼‰ ======
    const POIS = [
      // ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«å…¥å£ï¼ˆä¾‹ï¼‰
      { name: 'ã‚¿ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ†ãƒ«', lat: 38.101327, lon: 140.043027 }
    ];
    // ============================

    const hudLatlon = document.getElementById('latlon');
    const hudNearest = document.getElementById('nearest');
    const hudNotice  = document.getElementById('notice');
    document.getElementById('btn').onclick = () => location.reload();

    // Haversineè·é›¢(m)
    function dist(lat1, lon1, lat2, lon2){
      const R=6371000;
      const toRad = d=>d*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    // æ–¹ä½ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–ï¼ˆ2ç§’ã§æ¥ãªã‘ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    let headingOk = false;
    let headingTimer = setTimeout(()=>{ if(!headingOk) enableFallback(); }, 2000);

    function handleOrientation(){
      headingOk = true;
      clearTimeout(headingTimer);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ”ãƒ³ã¯ä¸è¦
      const ahead = document.getElementById('aheadPin');
      if (ahead) ahead.setAttribute('visible', false);
      hudNotice.style.display = 'none';
      window.removeEventListener('deviceorientation', handleOrientation);
    }
    window.addEventListener('deviceorientation', handleOrientation, {once:false});

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚«ãƒ¡ãƒ©ã®å‰ã«å¸¸æ™‚ãƒ”ãƒ³ã‚’ç½®ã
    function enableFallback(){
      const ahead = document.getElementById('aheadPin');
      if (!ahead) return;
      ahead.setAttribute('visible', true);
      hudNotice.style.display = '';
      // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã€ã‚«ãƒ¡ãƒ©ã®å‰æ–¹2mãƒ»é«˜ã•0.5mã¸
      const cam = document.querySelector('[gps-camera]');
      const tick = () => {
        if (!cam.object3D) { requestAnimationFrame(tick); return; }
        const camObj = cam.object3D;
        const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camObj.quaternion).normalize();
        const pos = camObj.position.clone().add(dir.multiplyScalar(2)); // 2må‰
        pos.y = (camObj.position.y||0) + 0.5; // 0.5mä¸Š
        ahead.object3D.position.copy(pos);
        requestAnimationFrame(tick);
      };
      tick();
    }

    // GPSæ›´æ–°æ™‚ã«HUDæ›´æ–°ï¼‹POIã‚’é…ç½®
    const scene = document.querySelector('a-scene');
    const camEl = document.querySelector('[gps-camera]');
    let placed = false;

    camEl.addEventListener('gps-camera-update-position', (e) => {
      const {position, accuracy} = e.detail; // lat, lon, accuracy
      const {latitude:lat, longitude:lon} = position;
      hudLatlon.textContent = `lat: ${lat.toFixed(6)}  lon: ${lon.toFixed(6)}  Â±${(accuracy||0).toFixed(1)} m`;

      // æœ€å¯„ã‚Šè¡¨ç¤º
      let nearest = {name:'-', d:Infinity};
      for (const p of POIS){
        const d = dist(lat, lon, p.lat, p.lon);
        if (d < nearest.d) nearest = {name:p.name, d};
      }
      hudNearest.textContent = `nearest: ${nearest.name} (${isFinite(nearest.d)?nearest.d.toFixed(1):'-'} m)`;

      // åˆå›ã ã‘POIã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆ
      if (!placed){
        placed = true;
        for (const p of POIS){
          const e = document.createElement('a-entity');
          e.setAttribute('gps-entity-place', `latitude: ${p.lat}; longitude: ${p.lon}`);
          e.setAttribute('look-at', '[gps-camera]');
          e.innerHTML = `
            <a-sphere radius="0.6" color="#ff9800"></a-sphere>
            <a-text value="${p.name}" align="center" position="0 1 0" color="#fff"></a-text>
          `;
          scene.appendChild(e);
        }
      }
    });
  </script>
<!-- ã‚«ãƒ¡ãƒ©å†å–å¾—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="camFix" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;z-index:99999">
  <button id="camBtn" style="font-size:18px;padding:12px 18px;border:0;border-radius:10px">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’å†å–å¾—</button>
</div>
<script>
  (async () => {
    // æ¨©é™ãŒæ—¢ã« granted ãªã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è‡ªå‹•ã§éš ã™
    try {
      const st = await navigator.permissions.query({name:'camera'});
      if (st.state === 'granted') document.getElementById('camFix').style.display='none';
    } catch(_) {}
  })();
  document.getElementById('camBtn').onclick = async () => {
    try {
      const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}, audio:false});
      // å–å¾—ã§ããŸã‚‰ã™ãåœæ­¢â†’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆAR.jsãŒå–ã‚Šç›´ã™ï¼‰
      s.getTracks().forEach(t=>t.stop());
      location.reload();
    } catch(e) {
      alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¨­å®šâ†’Safariâ†’ã‚«ãƒ¡ãƒ© ã‚’è¨±å¯ã«ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  };
</script>
</body>
</html>
