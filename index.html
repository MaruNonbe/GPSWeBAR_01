<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>GPSãƒˆãƒªã‚¬ãƒ¼ARï¼ˆè¤‡æ•°åœ°ç‚¹ï¼‹ãƒ­ã‚°ï¼‹iOSå¯¾å¿œï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; }
    #hud {
      position: fixed; top: 8px; left: 8px;
      z-index: 9999; background: rgba(0,0,0,0.6);
      color: #fff; font-size: 12px; line-height: 1.4;
      padding: 6px 8px; border-radius: 4px;
      white-space: pre-line; max-width: 90vw;
    }
    #sensorButton {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #007bff; color: white;
      padding: 14px 26px; border: none; border-radius: 8px;
      font-size: 18px; z-index: 9999;
    }
  </style>
</head>
<body>

<!-- ç”»é¢ã«å‡ºã™ãƒ‡ãƒãƒƒã‚°HUD -->
<div id="hud">ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒã¾ã ã§ã™</div>
<!-- iPhoneç”¨ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã‚’å–ã‚‹ -->
<button id="sensorButton">ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false;"
  renderer="antialias: true; alpha: true"
>
  <!-- å®Ÿæ©ŸGPSã‚«ãƒ¡ãƒ© -->
  <a-camera gps-camera rotation-reader></a-camera>

  <!-- ã‚«ãƒ¡ãƒ©å‰ã®å°ã•ã„ç®±ï¼ˆè¦‹ãˆã¦ã‚‹ã‹ç¢ºèªç”¨ï¼‰ -->
  <a-box position="0 0 -2" depth="0.2" height="0.2" width="0.2" color="#00FFAA"></a-box>
</a-scene>

<script>
/* =========================================
  1. GAS ã® Web ã‚¢ãƒ—ãƒª URLï¼ˆã‚ãªãŸã®æœ€æ–°ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
========================================= */
const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw_uhqYjG25qdhdrZ6zCZgjTCKPVypqmTcgKenXBtt4LSBCaoARHYSAYxtMEHijY1rSdA/exec';

/* =========================================
  2. ç´ã¥ã‘ã‚‹GPSåœ°ç‚¹ã¨è¡¨ç¤ºã™ã‚‹ç”»åƒ
========================================= */
const PLACES = [
  { id: 'tas-park',         name: 'TasParkHotel',       lat: 38.10148128126027, lon: 140.0433090680094, radius: 20, image: './Index/Picture/TasParkHotel.png' },
  { id: 'MichinoEkiNagai',  name: 'MichinoEkiNagai',    lat: 38.108970970886325, lon: 140.04382939078403, radius: 20, image: './Index/Picture/MichinoEkiNagai.png' },
  { id: 'MNagaiShougakkou', name: 'MNagaiShougakkou',   lat: 38.107796313044474, lon: 140.04269068239356, radius: 15, image: './Index/Picture/MNagaiShougakkou.png' },
  { id: 'Kozakurakan',      name: 'Kozakurakan',        lat: 38.110963329145335, lon: 140.03632275489852, radius: 15, image: './Index/Picture/Kozakurakan.png' },
  { id: 'Marudaiougiya',    name: 'Marudaiougiya',      lat: 38.11228246118919,  lon: 140.036198935986,   radius: 15, image: './Index/Picture/Marudaiougiya.png' },
  { id: 'Nagaisiyakusho',   name: 'Nagaisiyakusho',     lat: 38.1063333593554,   lon: 140.033892868012,   radius: 15, image: './Index/Picture/Nagaisiyakusho.png' },
  { id: 'NagaiKougyokoukou',name: 'NagaiKougyokoukou',  lat: 38.114426209437404, lon: 140.03013087985815, radius: 15, image: './Index/Picture/NagaiKougyokoukou.png' },
  { id: 'Nagaikoukou',      name: 'Nagaikoukou',        lat: 38.097283861825424, lon: 140.0380452392042,  radius: 15, image: './Index/Picture/Nagaikoukou.png' },
  { id: 'MinamiNagai',      name: 'MinamiNagai',        lat: 38.09769549394771,  lon: 140.03458623775896, radius: 15, image: './Index/Picture/MinamiNagai.png' },
  { id: 'Kurunt',           name: 'Kurunt',             lat: 38.10491876278905,  lon: 140.03466346205656, radius: 15, image: './Index/Picture/Kurunt.png' }
];

// HUDè¦ç´ 
const hud = document.getElementById('hud');

// fetch ã§ GAS ã«æŠ•ã’ã‚‹å°é–¢æ•°
function sendLog(payload) {
  fetch(LOG_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).catch(err => console.warn('ãƒ­ã‚°é€ä¿¡å¤±æ•—:', err));
}

/* =========================================
  3. å„åœ°ç‚¹ç”¨ã® <a-image> ã‚’å‹•çš„ã«ä½œã‚‹
========================================= */
function createPlaceEntities() {
  const scene = document.querySelector('a-scene');
  PLACES.forEach(place => {
    const img = document.createElement('a-image');
    img.setAttribute('id', 'place-' + place.id);
    img.setAttribute('src', place.image);
    img.setAttribute('position', '0 1.5 -3');   // ã‚«ãƒ¡ãƒ©ã®å‰ã«å‡ºã™
    img.setAttribute('width', '2.5');
    img.setAttribute('height', '1.2');
    img.setAttribute('material', 'side: double;');
    img.setAttribute('visible', 'false');       // åˆæœŸã¯éè¡¨ç¤º
    scene.appendChild(img);

    // å¾Œã§ã€Œä¸­ã«ã„ã‚‹ã‹ã©ã†ã‹ã€ã‚’åˆ¤å®šã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°ã‚’ã¤ã‘ã¦ãŠã
    place._isInside = false;
  });
}

/* =========================================
  4. è·é›¢ã‚’ãƒ¡ãƒ¼ãƒˆãƒ«ã§è¨ˆç®—
========================================= */
function distanceMeter(lat1, lon1, lat2, lon2) {
  const R = 6378137;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* =========================================
  5. GPSç›£è¦–ï¼ˆè¨±å¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚ã¨ã«ã ã‘å‘¼ã¶ï¼‰
========================================= */
let lastPos = null;      // æœ€æ–°ä½ç½®ã‚’ä¿æŒ
let lastSentAt = 0;      // 5ç§’é€ä¿¡ç”¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—

function startGPSWatch() {
  if (!navigator.geolocation) {
    hud.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯GPSãŒä½¿ãˆã¾ã›ã‚“';
    return;
  }

  // ä½ç½®ãŒå¤‰ã‚ã‚‹ãŸã³ã«å‘¼ã°ã‚Œã‚‹
  navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      lastPos = { lat, lon, acc };

      // HUDã‚’æ›´æ–°ï¼ˆç¾åœ¨ä½ç½®ã®ã¿è¡¨ç¤ºï¼‰
      hud.textContent =
        `ğŸ“ ç¾åœ¨ã®GPS\nlat: ${lat.toFixed(6)}\nlon: ${lon.toFixed(6)}\nç²¾åº¦: Â±${acc.toFixed(1)}m`;

      // å„åœ°ç‚¹ã¨ã®è·é›¢ã‚’è¦‹ã¦è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒ»enter/leaveãƒ­ã‚°
      PLACES.forEach(place => {
        const dist = distanceMeter(lat, lon, place.lat, place.lon);
        const entity = document.getElementById('place-' + place.id);
        const isNear = dist <= place.radius;

        if (entity) {
          entity.setAttribute('visible', isNear);
        }

        // è·é›¢å†…ã«å…¥ã£ãŸç¬é–“ã«ãƒ­ã‚°
        if (!place._isInside && isNear) {
          sendLog({ place_id: place.id, event: 'enter', lat, lon });
        }
        // å‡ºãŸç¬é–“ã«ãƒ­ã‚°
        if (place._isInside && !isNear) {
          sendLog({ place_id: place.id, event: 'leave', lat, lon });
        }

        place._isInside = isNear;
      });
    },
    (err) => {
      hud.textContent = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼š' + err.message;
      console.warn('GPSå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );

  // â˜… 5ç§’ã”ã¨ã«ã€Œç¾åœ¨ä½ç½®ã€ã‚’å¿…ãšãƒ­ã‚°ã«é£›ã°ã™
  setInterval(() => {
    if (!lastPos) return;
    const now = Date.now();
    if (now - lastSentAt < 5000) return; // 5ç§’çµŒã£ã¦ãªã‘ã‚Œã°é€ã‚‰ãªã„
    sendLog({
      place_id: 'current',
      event: 'position',
      lat: lastPos.lat,
      lon: lastPos.lon
    });
    lastSentAt = now;
  }, 1000);   // 1ç§’ã«ä¸€å›ãƒã‚§ãƒƒã‚¯ã—ã¦ã€Œ5ç§’çµŒã£ã¦ãŸã‚‰é€ã‚‹ã€
}

/* =========================================
  6. ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒœã‚¿ãƒ³ã®å‡¦ç†
========================================= */
const sensorButton = document.getElementById('sensorButton');
sensorButton.addEventListener('click', async () => {
  // iOSã®ã¨ãã ã‘ requestPermission ãŒã‚ã‚‹
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const state = await DeviceOrientationEvent.requestPermission();
      if (state === 'granted') {
        sensorButton.remove();
        startGPSWatch();
      } else {
        alert('ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
      }
    } catch (e) {
      alert('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  } else {
    // Androidã‚„PCãªã©ã¯ãã®ã¾ã¾é€²ã‚ã‚‹
    sensorButton.remove();
    startGPSWatch();
  }
});

/* =========================================
  7. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼šã¨ã‚Šã‚ãˆãšåœ°ç‚¹ã®3Dã ã‘ä½œã‚‹
========================================= */
window.addEventListener('load', () => {
  createPlaceEntities();
  // GPSã¯ã¾ã é–‹å§‹ã—ãªã„ï¼ˆãƒœã‚¿ãƒ³ã‚’å¾…ã¤ï¼‰
});
</script>

</body>
</html>
